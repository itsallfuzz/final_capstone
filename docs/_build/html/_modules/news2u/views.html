

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>news2u.views &mdash; News2U 00.00.01 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="../../_static/css/theme.css?v=e59714d7" />

  
      <script src="../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../_static/documentation_options.js?v=d7bb8d4d"></script>
      <script src="../../_static/doctools.js?v=9bcbadda"></script>
      <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html" class="icon icon-home">
            News2U
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../modules.html">news2u</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">News2U</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../index.html">Module code</a></li>
      <li class="breadcrumb-item active">news2u.views</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for news2u.views</h1><div class="highlight"><pre>
<span></span><span class="kn">from</span><span class="w"> </span><span class="nn">django.shortcuts</span><span class="w"> </span><span class="kn">import</span> <span class="n">render</span><span class="p">,</span> <span class="n">redirect</span><span class="p">,</span> <span class="n">get_object_or_404</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">django.contrib.auth.models</span><span class="w"> </span><span class="kn">import</span> <span class="n">User</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">django.contrib.auth</span><span class="w"> </span><span class="kn">import</span> <span class="n">authenticate</span><span class="p">,</span> <span class="n">login</span><span class="p">,</span> <span class="n">logout</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">django.contrib</span><span class="w"> </span><span class="kn">import</span> <span class="n">messages</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">django.urls</span><span class="w"> </span><span class="kn">import</span> <span class="n">reverse</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">django.utils</span><span class="w"> </span><span class="kn">import</span> <span class="n">timezone</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">django.contrib.auth.decorators</span><span class="w"> </span><span class="kn">import</span> <span class="n">login_required</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">django.contrib.auth.decorators</span><span class="w"> </span><span class="kn">import</span> <span class="n">user_passes_test</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">django.contrib.auth.decorators</span><span class="w"> </span><span class="kn">import</span> <span class="n">permission_required</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.models</span><span class="w"> </span><span class="kn">import</span> <span class="n">CustomUser</span><span class="p">,</span> <span class="n">Publisher</span><span class="p">,</span> <span class="n">Editor</span><span class="p">,</span> <span class="n">Journalist</span><span class="p">,</span> <span class="n">Reader</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.models</span><span class="w"> </span><span class="kn">import</span> <span class="n">Article</span><span class="p">,</span> <span class="n">Newsletter</span><span class="p">,</span> <span class="n">AdminApproval</span><span class="p">,</span> <span class="n">ResetToken</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.models</span><span class="w"> </span><span class="kn">import</span> <span class="n">ArticleSerializer</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.models</span><span class="w"> </span><span class="kn">import</span> <span class="n">JournalistSerializer</span><span class="p">,</span> <span class="n">PublisherSerializer</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.forms</span><span class="w"> </span><span class="kn">import</span> <span class="n">PublisherRegistrationForm</span><span class="p">,</span> <span class="n">EditorRegistrationForm</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.forms</span><span class="w"> </span><span class="kn">import</span> <span class="n">JournalistRegistrationForm</span><span class="p">,</span> <span class="n">ReaderRegistrationForm</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.forms</span><span class="w"> </span><span class="kn">import</span> <span class="n">SelectEditorForm</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.forms</span><span class="w"> </span><span class="kn">import</span> <span class="n">SubmitToPublisherForm</span><span class="p">,</span> <span class="n">SubscriptionForm</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.forms</span><span class="w"> </span><span class="kn">import</span> <span class="n">ArticleForm</span><span class="p">,</span> <span class="n">NewsletterForm</span><span class="p">,</span> <span class="n">LoginFormSerializer</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">django.core.mail</span><span class="w"> </span><span class="kn">import</span> <span class="n">send_mass_mail</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">django.conf</span><span class="w"> </span><span class="kn">import</span> <span class="n">settings</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">secrets</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">django.contrib.auth.models</span><span class="w"> </span><span class="kn">import</span> <span class="n">Group</span><span class="p">,</span> <span class="n">Permission</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">django.contrib.contenttypes.models</span><span class="w"> </span><span class="kn">import</span> <span class="n">ContentType</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">timedelta</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">hashlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">sha1</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">django.core.mail</span><span class="w"> </span><span class="kn">import</span> <span class="n">EmailMessage</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">django.core.mail</span><span class="w"> </span><span class="kn">import</span> <span class="n">send_mail</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">django.contrib.auth.forms</span><span class="w"> </span><span class="kn">import</span> <span class="n">AuthenticationForm</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">django.db</span><span class="w"> </span><span class="kn">import</span> <span class="n">transaction</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">django.http</span><span class="w"> </span><span class="kn">import</span> <span class="n">JsonResponse</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">rest_framework.decorators</span><span class="w"> </span><span class="kn">import</span> <span class="n">api_view</span><span class="p">,</span> <span class="n">permission_classes</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">rest_framework.permissions</span><span class="w"> </span><span class="kn">import</span> <span class="n">IsAuthenticated</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">rest_framework.response</span><span class="w"> </span><span class="kn">import</span> <span class="n">Response</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.functions.tweet</span><span class="w"> </span><span class="kn">import</span> <span class="n">Tweet</span>


<span class="c1"># Helper functions to check user roles</span>
<div class="viewcode-block" id="is_journalist">
<a class="viewcode-back" href="../../news2u.html#news2u.views.is_journalist">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">is_journalist</span><span class="p">(</span><span class="n">user</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">user</span><span class="o">.</span><span class="n">customuser</span><span class="o">.</span><span class="n">role</span> <span class="o">==</span> <span class="s1">&#39;journalist&#39;</span>
    <span class="k">except</span> <span class="n">CustomUser</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">False</span></div>



<div class="viewcode-block" id="is_editor">
<a class="viewcode-back" href="../../news2u.html#news2u.views.is_editor">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">is_editor</span><span class="p">(</span><span class="n">user</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">user</span><span class="o">.</span><span class="n">customuser</span><span class="o">.</span><span class="n">role</span> <span class="o">==</span> <span class="s1">&#39;editor&#39;</span>
    <span class="k">except</span> <span class="n">CustomUser</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">False</span></div>



<div class="viewcode-block" id="is_publisher">
<a class="viewcode-back" href="../../news2u.html#news2u.views.is_publisher">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">is_publisher</span><span class="p">(</span><span class="n">user</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">user</span><span class="o">.</span><span class="n">customuser</span><span class="o">.</span><span class="n">role</span> <span class="o">==</span> <span class="s1">&#39;publisher&#39;</span>
    <span class="k">except</span> <span class="n">CustomUser</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">False</span></div>



<div class="viewcode-block" id="is_reader">
<a class="viewcode-back" href="../../news2u.html#news2u.views.is_reader">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">is_reader</span><span class="p">(</span><span class="n">user</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">user</span><span class="o">.</span><span class="n">customuser</span><span class="o">.</span><span class="n">role</span> <span class="o">==</span> <span class="s1">&#39;reader&#39;</span>
    <span class="k">except</span> <span class="n">CustomUser</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">False</span></div>



<span class="c1"># View for home page</span>
<div class="viewcode-block" id="home">
<a class="viewcode-back" href="../../news2u.html#news2u.views.home">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">home</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="c1"># Display latest 6 articles</span>
    <span class="n">articles</span> <span class="o">=</span> <span class="n">Article</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
        <span class="n">status__in</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;published_independent&#39;</span><span class="p">,</span> <span class="s1">&#39;published_publisher&#39;</span><span class="p">]</span>
        <span class="p">)</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="s1">&#39;-published_at&#39;</span><span class="p">)[:</span><span class="mi">9</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;news2u/home.html&#39;</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;articles&#39;</span><span class="p">:</span> <span class="n">articles</span><span class="p">})</span></div>



<span class="c1"># ============================================================</span>
<span class="c1"># REGISTRATION &amp; APPROVAL</span>
<span class="c1"># ============================================================</span>


<span class="c1"># User Registration for the Publisher role</span>
<div class="viewcode-block" id="register">
<a class="viewcode-back" href="../../news2u.html#news2u.views.register">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">register</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;news2u/register.html&#39;</span><span class="p">)</span></div>



<div class="viewcode-block" id="register_publisher">
<a class="viewcode-back" href="../../news2u.html#news2u.views.register_publisher">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">register_publisher</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Handle the registration of a new publisher.</span>

<span class="sd">    Creates a new user account with publisher role and sets it to</span>
<span class="sd">    inactive until admin approval. Also creates associated CustomUser,</span>
<span class="sd">    AdminApproval, and Publisher profile records.</span>

<span class="sd">    :param request: HttpRequest object</span>
<span class="sd">    :type request: HttpRequest</span>

<span class="sd">    :return: Redirect to pending approval</span>
<span class="sd">    :rtype: HttpResponse</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;POST&#39;</span><span class="p">:</span>
        <span class="n">form</span> <span class="o">=</span> <span class="n">PublisherRegistrationForm</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="p">,</span> <span class="n">request</span><span class="o">.</span><span class="n">FILES</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">form</span><span class="o">.</span><span class="n">is_valid</span><span class="p">():</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">with</span> <span class="n">transaction</span><span class="o">.</span><span class="n">atomic</span><span class="p">():</span>
                    <span class="n">new_user</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">commit</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                    <span class="c1"># Until approval is granted</span>
                    <span class="n">new_user</span><span class="o">.</span><span class="n">is_active</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="n">new_user</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>

                    <span class="c1"># Create CustomUser profile with role</span>
                    <span class="n">custom_user</span> <span class="o">=</span> <span class="n">CustomUser</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
                        <span class="n">user</span><span class="o">=</span><span class="n">new_user</span><span class="p">,</span>
                        <span class="n">role</span><span class="o">=</span><span class="s1">&#39;publisher&#39;</span><span class="p">,</span>
                        <span class="n">is_approved</span><span class="o">=</span><span class="kc">False</span>
                    <span class="p">)</span>

                    <span class="c1"># Create AdminApproval record</span>
                    <span class="n">AdminApproval</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
                        <span class="n">user</span><span class="o">=</span><span class="n">custom_user</span><span class="p">,</span>
                        <span class="n">role</span><span class="o">=</span><span class="s1">&#39;publisher&#39;</span><span class="p">,</span>
                        <span class="n">is_approved</span><span class="o">=</span><span class="kc">False</span>
                    <span class="p">)</span>

                    <span class="c1"># Add to Publisher group</span>
                    <span class="n">publisher_group</span><span class="p">,</span> <span class="n">created</span> <span class="o">=</span> <span class="n">Group</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get_or_create</span><span class="p">(</span>
                        <span class="n">name</span><span class="o">=</span><span class="s1">&#39;Publisher&#39;</span><span class="p">)</span>
                    <span class="n">new_user</span><span class="o">.</span><span class="n">groups</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">publisher_group</span><span class="p">)</span>

                    <span class="c1"># Create Publisher profile</span>
                    <span class="n">Publisher</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
                        <span class="n">user</span><span class="o">=</span><span class="n">new_user</span><span class="p">,</span>
                        <span class="n">publisher_name</span><span class="o">=</span><span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span>
                            <span class="s1">&#39;publisher_name&#39;</span><span class="p">],</span>
                        <span class="n">publisher_description</span><span class="o">=</span><span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span>
                            <span class="s1">&#39;publisher_description&#39;</span><span class="p">],</span>
                        <span class="n">publisher_logo</span><span class="o">=</span><span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                            <span class="s1">&#39;publisher_logo&#39;</span><span class="p">)</span>
                    <span class="p">)</span>

                    <span class="n">messages</span><span class="o">.</span><span class="n">success</span><span class="p">(</span>
                        <span class="n">request</span><span class="p">,</span>
                        <span class="s1">&#39;Registration successful! An admin &#39;</span>
                        <span class="s1">&#39;will review your account in the &#39;</span>
                        <span class="s1">&#39;next 24-48 hours.&#39;</span>
                        <span class="p">)</span>
                    <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s1">&#39;registration_pending&#39;</span><span class="p">)</span>

            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">messages</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                    <span class="n">request</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;Registration failed: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">messages</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;Please correct the errors below.&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">form</span> <span class="o">=</span> <span class="n">PublisherRegistrationForm</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span>
                  <span class="s1">&#39;news2u/register_publisher.html&#39;</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;form&#39;</span><span class="p">:</span> <span class="n">form</span><span class="p">})</span></div>



<span class="c1"># User Registration for the Editor role</span>
<div class="viewcode-block" id="register_editor">
<a class="viewcode-back" href="../../news2u.html#news2u.views.register_editor">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">register_editor</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Handle the registration of a new editor.</span>

<span class="sd">    Creates a new user account with editor role and sets it to inactive</span>
<span class="sd">    until admin approval. Also creates associated CustomUser,</span>
<span class="sd">    AdminApproval, and Editor profile records.</span>

<span class="sd">    :param request: HttpRequest object</span>
<span class="sd">    :type request: HttpRequest</span>

<span class="sd">    :return: Redirect to pending approval</span>
<span class="sd">    :rtype: HttpResponse</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;POST&#39;</span><span class="p">:</span>
        <span class="n">form</span> <span class="o">=</span> <span class="n">EditorRegistrationForm</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="p">,</span> <span class="n">request</span><span class="o">.</span><span class="n">FILES</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">form</span><span class="o">.</span><span class="n">is_valid</span><span class="p">():</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">with</span> <span class="n">transaction</span><span class="o">.</span><span class="n">atomic</span><span class="p">():</span>
                    <span class="n">new_user</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">commit</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                    <span class="c1"># Until approval is granted</span>
                    <span class="n">new_user</span><span class="o">.</span><span class="n">is_active</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="n">new_user</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>

                <span class="c1"># Create CustomUser profile with role</span>
                <span class="n">custom_user</span> <span class="o">=</span> <span class="n">CustomUser</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
                    <span class="n">user</span><span class="o">=</span><span class="n">new_user</span><span class="p">,</span>
                    <span class="n">role</span><span class="o">=</span><span class="s1">&#39;editor&#39;</span><span class="p">,</span>
                    <span class="n">is_approved</span><span class="o">=</span><span class="kc">False</span>
                <span class="p">)</span>

                <span class="c1"># Create AdminApproval record</span>
                <span class="n">AdminApproval</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
                    <span class="n">user</span><span class="o">=</span><span class="n">custom_user</span><span class="p">,</span>
                    <span class="n">role</span><span class="o">=</span><span class="s1">&#39;editor&#39;</span><span class="p">,</span>
                    <span class="n">is_approved</span><span class="o">=</span><span class="kc">False</span>
                <span class="p">)</span>

                <span class="c1"># Add to Editor group</span>
                <span class="n">editor_group</span><span class="p">,</span> <span class="n">created</span> <span class="o">=</span> <span class="n">Group</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get_or_create</span><span class="p">(</span>
                    <span class="n">name</span><span class="o">=</span><span class="s1">&#39;Editor&#39;</span><span class="p">)</span>
                <span class="n">new_user</span><span class="o">.</span><span class="n">groups</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">editor_group</span><span class="p">)</span>

                <span class="n">Editor</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
                    <span class="n">user</span><span class="o">=</span><span class="n">new_user</span><span class="p">,</span>
                    <span class="n">editor_name</span><span class="o">=</span><span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s1">&#39;editor_name&#39;</span><span class="p">],</span>
                    <span class="n">editor_interests</span><span class="o">=</span><span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s1">&#39;editor_interests&#39;</span><span class="p">],</span>
                    <span class="n">editor_bio</span><span class="o">=</span><span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s1">&#39;editor_bio&#39;</span><span class="p">],</span>
                    <span class="n">editor_photo</span><span class="o">=</span><span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;editor_photo&#39;</span><span class="p">)</span>
                <span class="p">)</span>

                <span class="n">messages</span><span class="o">.</span><span class="n">success</span><span class="p">(</span>
                    <span class="n">request</span><span class="p">,</span>
                    <span class="s1">&#39;Registration successful! An admin will &#39;</span>
                    <span class="s1">&#39;review your account in the next &#39;</span>
                    <span class="s1">&#39;24-48 hours.&#39;</span>
                <span class="p">)</span>
                <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s1">&#39;registration_pending&#39;</span><span class="p">)</span>

            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">messages</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                    <span class="n">request</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;Registration failed: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="n">form</span> <span class="o">=</span> <span class="n">EditorRegistrationForm</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span>
                  <span class="s1">&#39;news2u/register_editor.html&#39;</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;form&#39;</span><span class="p">:</span> <span class="n">form</span><span class="p">})</span></div>



<span class="c1"># User Registration for the Journalist role</span>
<div class="viewcode-block" id="register_journalist">
<a class="viewcode-back" href="../../news2u.html#news2u.views.register_journalist">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">register_journalist</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Handle the registration of a new journalist.</span>

<span class="sd">    Creates a new user account with journalist role and sets it to</span>
<span class="sd">    inactive until admin approval. Also creates associated CustomUser,</span>
<span class="sd">    AdminApproval, and Journalist profile records.</span>

<span class="sd">    :param request: HttpRequest object</span>
<span class="sd">    :type request: HttpRequest</span>

<span class="sd">    :return: Redirect to pending approval</span>
<span class="sd">    :rtype: HttpResponse</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;POST&#39;</span><span class="p">:</span>
        <span class="n">form</span> <span class="o">=</span> <span class="n">JournalistRegistrationForm</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="p">,</span> <span class="n">request</span><span class="o">.</span><span class="n">FILES</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">form</span><span class="o">.</span><span class="n">is_valid</span><span class="p">():</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">with</span> <span class="n">transaction</span><span class="o">.</span><span class="n">atomic</span><span class="p">():</span>
                    <span class="n">new_user</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">commit</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                    <span class="c1"># Until approval is granted</span>
                    <span class="n">new_user</span><span class="o">.</span><span class="n">is_active</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="n">new_user</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>

                <span class="c1"># Create CustomUser profile with role</span>
                <span class="n">custom_user</span> <span class="o">=</span> <span class="n">CustomUser</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
                    <span class="n">user</span><span class="o">=</span><span class="n">new_user</span><span class="p">,</span>
                    <span class="n">role</span><span class="o">=</span><span class="s1">&#39;journalist&#39;</span><span class="p">,</span>
                    <span class="n">is_approved</span><span class="o">=</span><span class="kc">False</span>
                <span class="p">)</span>

                <span class="c1"># Create AdminApproval record</span>
                <span class="n">AdminApproval</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
                    <span class="n">user</span><span class="o">=</span><span class="n">custom_user</span><span class="p">,</span>
                    <span class="n">role</span><span class="o">=</span><span class="s1">&#39;journalist&#39;</span><span class="p">,</span>
                    <span class="n">is_approved</span><span class="o">=</span><span class="kc">False</span>
                <span class="p">)</span>

                <span class="c1"># Add to Journalist group</span>
                <span class="n">journalist_group</span><span class="p">,</span> <span class="n">created</span> <span class="o">=</span> <span class="n">Group</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get_or_create</span><span class="p">(</span>
                    <span class="n">name</span><span class="o">=</span><span class="s1">&#39;Journalist&#39;</span><span class="p">)</span>
                <span class="n">new_user</span><span class="o">.</span><span class="n">groups</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">journalist_group</span><span class="p">)</span>

                <span class="n">Journalist</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
                    <span class="n">user</span><span class="o">=</span><span class="n">new_user</span><span class="p">,</span>
                    <span class="n">journalist_name</span><span class="o">=</span><span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s1">&#39;journalist_name&#39;</span><span class="p">],</span>
                    <span class="n">journalist_bio</span><span class="o">=</span><span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s1">&#39;journalist_bio&#39;</span><span class="p">],</span>
                    <span class="n">journalist_photo</span><span class="o">=</span><span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                        <span class="s1">&#39;journalist_photo&#39;</span><span class="p">)</span>
                    <span class="p">)</span>

                <span class="n">messages</span><span class="o">.</span><span class="n">success</span><span class="p">(</span>
                    <span class="n">request</span><span class="p">,</span>
                    <span class="s1">&#39;Registration successful! An admin will review your&#39;</span>
                    <span class="s1">&#39; account in the next 24-48 hours.&#39;</span>
                    <span class="p">)</span>
                <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s1">&#39;registration_pending&#39;</span><span class="p">)</span>

            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">messages</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                    <span class="n">request</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;Registration failed: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="n">form</span> <span class="o">=</span> <span class="n">JournalistRegistrationForm</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span>
                  <span class="s1">&#39;news2u/register_journalist.html&#39;</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;form&#39;</span><span class="p">:</span> <span class="n">form</span><span class="p">})</span></div>



<span class="c1"># User registration for the Reader role</span>
<div class="viewcode-block" id="register_reader">
<a class="viewcode-back" href="../../news2u.html#news2u.views.register_reader">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">register_reader</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Handle the registration of a new reader (subscriber).</span>

<span class="sd">    Creates a new user account with reader role and sets it to active</span>
<span class="sd">    immediately. Also creates associated CustomUser and Reader profile</span>
<span class="sd">    records.</span>

<span class="sd">    :param request: HttpRequest object</span>
<span class="sd">    :type request: HttpRequest</span>

<span class="sd">    :return: Login Page or render registration form</span>
<span class="sd">    :rtype: HttpResponse</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;POST&#39;</span><span class="p">:</span>
        <span class="n">form</span> <span class="o">=</span> <span class="n">ReaderRegistrationForm</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="p">,</span> <span class="n">request</span><span class="o">.</span><span class="n">FILES</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">form</span><span class="o">.</span><span class="n">is_valid</span><span class="p">():</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">with</span> <span class="n">transaction</span><span class="o">.</span><span class="n">atomic</span><span class="p">():</span>
                    <span class="n">new_user</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">commit</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                    <span class="c1"># Readers are immediately active</span>
                    <span class="n">new_user</span><span class="o">.</span><span class="n">is_active</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="n">new_user</span><span class="o">.</span><span class="n">email</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                        <span class="s1">&#39;email&#39;</span><span class="p">)</span>
                    <span class="n">new_user</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>

                <span class="c1"># Create CustomUser profile with role</span>
                <span class="n">custom_user</span> <span class="o">=</span> <span class="n">CustomUser</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
                    <span class="n">user</span><span class="o">=</span><span class="n">new_user</span><span class="p">,</span>
                    <span class="n">role</span><span class="o">=</span><span class="s1">&#39;reader&#39;</span><span class="p">,</span>
                    <span class="n">email</span><span class="o">=</span><span class="n">new_user</span><span class="o">.</span><span class="n">email</span><span class="p">,</span>
                    <span class="n">is_approved</span><span class="o">=</span><span class="kc">True</span>
                <span class="p">)</span>

                <span class="c1"># Add to Reader group</span>
                <span class="n">reader_group</span><span class="p">,</span> <span class="n">created</span> <span class="o">=</span> <span class="n">Group</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get_or_create</span><span class="p">(</span>
                    <span class="n">name</span><span class="o">=</span><span class="s1">&#39;Reader&#39;</span><span class="p">)</span>
                <span class="n">new_user</span><span class="o">.</span><span class="n">groups</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">reader_group</span><span class="p">)</span>

                <span class="c1"># If group created for the first time</span>
                <span class="k">if</span> <span class="n">created</span><span class="p">:</span>
                    <span class="n">content_type</span> <span class="o">=</span> <span class="n">ContentType</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get_for_model</span><span class="p">(</span>
                        <span class="n">Article</span><span class="p">)</span>
                    <span class="n">view_permission</span> <span class="o">=</span> <span class="n">Permission</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                        <span class="n">codename</span><span class="o">=</span><span class="s1">&#39;view_article&#39;</span><span class="p">,</span>
                        <span class="n">content_type</span><span class="o">=</span><span class="n">content_type</span>
                    <span class="p">)</span>
                    <span class="n">reader_group</span><span class="o">.</span><span class="n">permissions</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">view_permission</span><span class="p">)</span>

                <span class="n">Reader</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
                    <span class="n">user</span><span class="o">=</span><span class="n">new_user</span><span class="p">,</span>
                    <span class="n">reader_name</span><span class="o">=</span><span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s1">&#39;reader_name&#39;</span><span class="p">],</span>
                    <span class="n">reader_interests</span><span class="o">=</span><span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s1">&#39;reader_interests&#39;</span><span class="p">],</span>
                    <span class="n">reader_photo</span><span class="o">=</span><span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;reader_photo&#39;</span><span class="p">)</span>
                    <span class="p">)</span>

                <span class="n">messages</span><span class="o">.</span><span class="n">success</span><span class="p">(</span>
                    <span class="n">request</span><span class="p">,</span>
                    <span class="s1">&#39;Registration successful! You can now &#39;</span>
                    <span class="s1">&#39;log in and start reading articles.&#39;</span>
                    <span class="p">)</span>
                <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s1">&#39;login&#39;</span><span class="p">)</span>

            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">messages</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                    <span class="n">request</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;Registration failed: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="n">form</span> <span class="o">=</span> <span class="n">ReaderRegistrationForm</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">render</span><span class="p">(</span>
        <span class="n">request</span><span class="p">,</span>
        <span class="s1">&#39;news2u/register_reader.html&#39;</span><span class="p">,</span>
        <span class="p">{</span><span class="s1">&#39;form&#39;</span><span class="p">:</span> <span class="n">form</span><span class="p">})</span></div>



<div class="viewcode-block" id="registration_pending">
<a class="viewcode-back" href="../../news2u.html#news2u.views.registration_pending">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">registration_pending</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;news2u/registration_pending.html&#39;</span><span class="p">)</span></div>



<span class="c1"># View the pending registrations (admin only)</span>
<div class="viewcode-block" id="view_pending_registration">
<a class="viewcode-back" href="../../news2u.html#news2u.views.view_pending_registration">[docs]</a>
<span class="nd">@login_required</span>
<span class="nd">@user_passes_test</span><span class="p">(</span><span class="k">lambda</span> <span class="n">u</span><span class="p">:</span> <span class="n">u</span><span class="o">.</span><span class="n">is_superuser</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">view_pending_registration</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;GET&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;news2u/registration_pending.html&#39;</span><span class="p">)</span></div>



<span class="c1"># ============================================================</span>
<span class="c1"># # USER AUTHENTICATION (LOGIN, LOGOUT, PASSWORD RESET)</span>
<span class="c1"># ============================================================</span>

<span class="c1"># User Login</span>
<div class="viewcode-block" id="user_login">
<a class="viewcode-back" href="../../news2u.html#news2u.views.user_login">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">user_login</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Handle user login and redirect based on role.</span>

<span class="sd">    Manages login for all user roles and redirects to respective</span>
<span class="sd">    dashboards.</span>

<span class="sd">    :param request: HttpRequest object</span>
<span class="sd">    :type request: HttpRequest</span>

<span class="sd">    :return: Login page or redirect to dashboard</span>
<span class="sd">    :rtype: HttpResponse</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;POST&#39;</span><span class="p">:</span>
        <span class="n">form</span> <span class="o">=</span> <span class="n">AuthenticationForm</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">form</span><span class="o">.</span><span class="n">is_valid</span><span class="p">():</span>
            <span class="n">username</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="p">[</span><span class="s1">&#39;username&#39;</span><span class="p">]</span>
            <span class="n">password</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="p">[</span><span class="s1">&#39;password&#39;</span><span class="p">]</span>
            <span class="n">user</span> <span class="o">=</span> <span class="n">authenticate</span><span class="p">(</span><span class="n">request</span><span class="p">,</span>
                                <span class="n">username</span><span class="o">=</span><span class="n">username</span><span class="p">,</span>
                                <span class="n">password</span><span class="o">=</span><span class="n">password</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">user</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">login</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">user</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">is_publisher</span><span class="p">(</span><span class="n">user</span><span class="p">):</span>
                    <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s1">&#39;publisher_dashboard&#39;</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">is_editor</span><span class="p">(</span><span class="n">user</span><span class="p">):</span>
                    <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s1">&#39;editor_dashboard&#39;</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">is_journalist</span><span class="p">(</span><span class="n">user</span><span class="p">):</span>
                    <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s1">&#39;journalist_dashboard&#39;</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">is_reader</span><span class="p">(</span><span class="n">user</span><span class="p">):</span>
                    <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s1">&#39;reader_dashboard&#39;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s1">&#39;home&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">form</span> <span class="o">=</span> <span class="n">AuthenticationForm</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;news2u/login.html&#39;</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;form&#39;</span><span class="p">:</span> <span class="n">form</span><span class="p">})</span></div>



<span class="c1"># User Logout</span>
<div class="viewcode-block" id="user_logout">
<a class="viewcode-back" href="../../news2u.html#news2u.views.user_logout">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">user_logout</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Handle user logout.</span>

<span class="sd">    Logs out the user and redirects to login page.</span>
<span class="sd">    :param request: HttpRequest object</span>
<span class="sd">    :type request: HttpRequest</span>

<span class="sd">    :return: Redirect to login page</span>
<span class="sd">    :rtype: HttpResponse</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">is_authenticated</span><span class="p">:</span>  <span class="c1"># Better check than is not None</span>
        <span class="c1"># Clear pending messages</span>
        <span class="n">storage</span> <span class="o">=</span> <span class="n">messages</span><span class="o">.</span><span class="n">get_messages</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
        <span class="n">storage</span><span class="o">.</span><span class="n">used</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="n">logout</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
        <span class="n">messages</span><span class="o">.</span><span class="n">success</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;You have been logged out successfully.&#39;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s1">&#39;login&#39;</span><span class="p">)</span></div>



<span class="c1"># Reset Password</span>
<div class="viewcode-block" id="generate_reset_url">
<a class="viewcode-back" href="../../news2u.html#news2u.views.generate_reset_url">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">generate_reset_url</span><span class="p">(</span><span class="n">user</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; Generate a unique password reset URL for the user.</span>

<span class="sd">    :param user: User object</span>
<span class="sd">    :type user: User</span>

<span class="sd">    :return: Password reset URL</span>
<span class="sd">    :rtype: str</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">domain</span> <span class="o">=</span> <span class="s2">&quot;http://127.0.0.1:8000/&quot;</span>
    <span class="n">app_name</span> <span class="o">=</span> <span class="s2">&quot;news2u&quot;</span>
    <span class="n">url</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">domain</span><span class="si">}{</span><span class="n">app_name</span><span class="si">}</span><span class="s2">/reset_password/&quot;</span>
    <span class="n">token</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">secrets</span><span class="o">.</span><span class="n">token_urlsafe</span><span class="p">(</span><span class="mi">16</span><span class="p">))</span>
    <span class="n">expiry_date</span> <span class="o">=</span> <span class="n">timezone</span><span class="o">.</span><span class="n">now</span><span class="p">()</span> <span class="o">+</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">minutes</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
    <span class="n">reset_token</span> <span class="o">=</span> <span class="n">ResetToken</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
        <span class="n">user</span><span class="o">=</span><span class="n">user</span><span class="p">,</span>
        <span class="n">token</span><span class="o">=</span><span class="n">sha1</span><span class="p">(</span><span class="n">token</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">(),</span>
        <span class="n">expiry_date</span><span class="o">=</span><span class="n">expiry_date</span>
        <span class="p">)</span>
    <span class="n">url</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">token</span><span class="si">}</span><span class="s2">/&quot;</span>
    <span class="k">return</span> <span class="n">url</span></div>



<span class="c1"># Build an email to send email to user with reset link</span>
<div class="viewcode-block" id="build_email">
<a class="viewcode-back" href="../../news2u.html#news2u.views.build_email">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">build_email</span><span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="n">reset_url</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; Build the password reset email.</span>

<span class="sd">    Build the email template to sendt to the user with the password</span>
<span class="sd">    reset link.</span>

<span class="sd">    :param user: User object</span>
<span class="sd">    :type user: User</span>

<span class="sd">    :param reset_url: Password reset URL</span>
<span class="sd">    :rtype: str</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">subject</span> <span class="o">=</span> <span class="s2">&quot;Password Reset&quot;</span>
    <span class="n">user_email</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">email</span>
    <span class="n">domain_email</span> <span class="o">=</span> <span class="s2">&quot;example@domain.com&quot;</span>
    <span class="n">body</span> <span class="o">=</span> <span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;Hi </span><span class="si">{</span><span class="n">user</span><span class="o">.</span><span class="n">username</span><span class="si">}</span><span class="s2">,</span><span class="se">\n</span><span class="s2">Here is your link to reset your&quot;</span>
        <span class="sa">f</span><span class="s2">&quot;password: </span><span class="si">{</span><span class="n">reset_url</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="p">)</span>
    <span class="n">email</span> <span class="o">=</span> <span class="n">EmailMessage</span><span class="p">(</span><span class="n">subject</span><span class="p">,</span> <span class="n">body</span><span class="p">,</span> <span class="n">domain_email</span><span class="p">,</span> <span class="p">[</span><span class="n">user_email</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">email</span></div>



<span class="c1"># Take user to the forgot password page</span>
<div class="viewcode-block" id="forgot_password">
<a class="viewcode-back" href="../../news2u.html#news2u.views.forgot_password">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">forgot_password</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; Render the forgot password page.</span>

<span class="sd">    :param request: HttpRequest object</span>
<span class="sd">    :type request: HttpRequest</span>

<span class="sd">    :return: Render forgot password page</span>
<span class="sd">    :rtype: HttpResponse</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;news2u/forgot_password.html&#39;</span><span class="p">)</span></div>



<span class="c1"># Send password reset link to user&#39;s email</span>
<div class="viewcode-block" id="send_password_reset">
<a class="viewcode-back" href="../../news2u.html#news2u.views.send_password_reset">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">send_password_reset</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; Send password reset link to user&#39;s email.</span>

<span class="sd">    :param request: HttpRequest object</span>
<span class="sd">    :type request: HttpRequest</span>

<span class="sd">    :return: Redirect to login page with success message</span>
<span class="sd">    :rtype: HttpResponse</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">user_email</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;email&#39;</span><span class="p">)</span>
    <span class="n">user</span> <span class="o">=</span> <span class="n">User</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">email</span><span class="o">=</span><span class="n">user_email</span><span class="p">)</span>
    <span class="n">url</span> <span class="o">=</span> <span class="n">generate_reset_url</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
    <span class="n">email</span> <span class="o">=</span> <span class="n">build_email</span><span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="n">url</span><span class="p">)</span>
    <span class="n">email</span><span class="o">.</span><span class="n">send</span><span class="p">()</span>

    <span class="n">messages</span><span class="o">.</span><span class="n">success</span><span class="p">(</span>
        <span class="n">request</span><span class="p">,</span> <span class="s1">&#39;Password reset link has been sent to &#39;</span>
        <span class="s1">&#39;your email.&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">reverse</span><span class="p">(</span><span class="s1">&#39;login&#39;</span><span class="p">))</span></div>



<span class="c1"># Password Reset Confirmation</span>
<div class="viewcode-block" id="reset_password">
<a class="viewcode-back" href="../../news2u.html#news2u.views.reset_password">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">reset_password</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">token</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; Handle password reset using the provided token.</span>

<span class="sd">    :param request: HttpRequest object</span>
<span class="sd">    :type request: HttpRequest</span>
<span class="sd">    :param token: Password reset token</span>
<span class="sd">    :type token: str</span>

<span class="sd">    :return: Render reset password page or redirect to login</span>
<span class="sd">    :rtype: HttpResponse</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">hashed_token</span> <span class="o">=</span> <span class="n">sha1</span><span class="p">(</span><span class="n">token</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()</span>
    <span class="n">reset_token</span> <span class="o">=</span> <span class="n">get_object_or_404</span><span class="p">(</span><span class="n">ResetToken</span><span class="p">,</span> <span class="n">token</span><span class="o">=</span><span class="n">hashed_token</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">reset_token</span><span class="o">.</span><span class="n">expiry_date</span> <span class="o">&lt;</span> <span class="n">timezone</span><span class="o">.</span><span class="n">now</span><span class="p">():</span>
            <span class="k">return</span> <span class="n">render</span><span class="p">(</span>
                <span class="n">request</span><span class="p">,</span>
                <span class="s1">&#39;news2u/reset_password.html&#39;</span><span class="p">,</span>
                <span class="p">{</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;Token has expired&#39;</span><span class="p">}</span>
                <span class="p">)</span>

        <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;POST&#39;</span><span class="p">:</span>
            <span class="n">new_password</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="p">[</span><span class="s1">&#39;new_password&#39;</span><span class="p">]</span>
            <span class="n">password_confirm</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;password_confirm&#39;</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">new_password</span> <span class="o">==</span> <span class="n">password_confirm</span><span class="p">:</span>
                <span class="n">reset_token</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">set_password</span><span class="p">(</span><span class="n">new_password</span><span class="p">)</span>
                <span class="n">reset_token</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
                <span class="n">reset_token</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>
                <span class="n">messages</span><span class="o">.</span><span class="n">success</span><span class="p">(</span>
                    <span class="n">request</span><span class="p">,</span> <span class="s1">&#39;Password has been reset successfully.&#39;</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">reverse</span><span class="p">(</span><span class="s1">&#39;login&#39;</span><span class="p">))</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">render</span><span class="p">(</span>
                    <span class="n">request</span><span class="p">,</span>
                    <span class="s1">&#39;news2u/reset_password.html&#39;</span><span class="p">,</span>
                    <span class="p">{</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;Passwords do not match&#39;</span><span class="p">}</span>
                    <span class="p">)</span>
        <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;news2u/reset_password.html&#39;</span><span class="p">)</span>

    <span class="k">except</span> <span class="n">ResetToken</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;news2u/reset_password.html&#39;</span><span class="p">,</span>
                      <span class="p">{</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;Invalid token&#39;</span><span class="p">})</span></div>



<span class="c1"># ============================================================</span>
<span class="c1"># EMAIL NOTIFICATIONS (WHEN EDITOR APPROVES ARTICLE/NEWSLETTER)</span>
<span class="c1"># ============================================================</span>

<div class="viewcode-block" id="send_article_email">
<a class="viewcode-back" href="../../news2u.html#news2u.views.send_article_email">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">send_article_email</span><span class="p">(</span><span class="n">article</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; Send email to subscribers when article is approved</span>

<span class="sd">    :param article: Article object to be sent</span>
<span class="sd">    :type article: Article</span>

<span class="sd">    :return: Number of emails sent (in console) (or None)</span>
<span class="sd">    :rtype: None</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=== SEND ARTICLE EMAIL PRINT TO CONSOLE ===&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Article: </span><span class="si">{</span><span class="n">article</span><span class="o">.</span><span class="n">article_title</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Status: </span><span class="si">{</span><span class="n">article</span><span class="o">.</span><span class="n">status</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Journalist: </span><span class="si">{</span><span class="n">article</span><span class="o">.</span><span class="n">journalist</span><span class="o">.</span><span class="n">journalist_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Publisher: </span><span class="si">{</span><span class="n">article</span><span class="o">.</span><span class="n">publisher</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># For articles ready to publish or published independently -</span>
    <span class="c1"># send to journalist subscribers</span>
    <span class="k">if</span> <span class="n">article</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="s1">&#39;published_independent&#39;</span><span class="p">:</span>
        <span class="n">subscribed_readers</span> <span class="o">=</span> <span class="n">CustomUser</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
            <span class="n">role</span><span class="o">=</span><span class="s1">&#39;reader&#39;</span><span class="p">,</span>
            <span class="n">subscribed_journalists</span><span class="o">=</span><span class="n">article</span><span class="o">.</span><span class="n">journalist</span>
        <span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Checking journalist subscribers...&quot;</span><span class="p">)</span>

    <span class="c1"># For articles published via publisher -</span>
    <span class="c1"># send to publisher subscribers</span>
    <span class="k">elif</span> <span class="n">article</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="s1">&#39;published_publisher&#39;</span><span class="p">:</span>
        <span class="n">subscribed_readers</span> <span class="o">=</span> <span class="n">CustomUser</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
            <span class="n">role</span><span class="o">=</span><span class="s1">&#39;reader&#39;</span><span class="p">,</span>
            <span class="n">subscribed_publishers</span><span class="o">=</span><span class="n">article</span><span class="o">.</span><span class="n">publisher</span>
        <span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Checking publisher subscribers...&quot;</span><span class="p">)</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Status </span><span class="si">{</span><span class="n">article</span><span class="o">.</span><span class="n">status</span><span class="si">}</span><span class="s2"> doesn&#39;t match - not sending&quot;</span><span class="p">)</span>
        <span class="k">return</span>

    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Subscribers found: </span><span class="si">{</span><span class="n">subscribed_readers</span><span class="o">.</span><span class="n">count</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">reader</span> <span class="ow">in</span> <span class="n">subscribed_readers</span><span class="p">:</span>
        <span class="n">email</span> <span class="o">=</span> <span class="n">reader</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">email</span>
        <span class="k">if</span> <span class="n">email</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  - </span><span class="si">{</span><span class="n">reader</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">username</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">email</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># If there are NO subscribers</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">subscribed_readers</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;No subscribers - exiting&quot;</span><span class="p">)</span>
        <span class="k">return</span>

    <span class="c1"># Prepare email</span>
    <span class="n">subject</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;New Article: </span><span class="si">{</span><span class="n">article</span><span class="o">.</span><span class="n">article_title</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="n">message</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    A new article by </span><span class="si">{</span><span class="n">article</span><span class="o">.</span><span class="n">journalist</span><span class="o">.</span><span class="n">journalist_name</span><span class="si">}</span><span class="s2"> </span><span class="se">\</span>
<span class="s2">        has just been released!</span>

<span class="s2">Title: </span><span class="si">{</span><span class="n">article</span><span class="o">.</span><span class="n">article_title</span><span class="si">}</span>

<span class="si">{</span><span class="n">article</span><span class="o">.</span><span class="n">article_content</span><span class="p">[:</span><span class="mi">200</span><span class="p">]</span><span class="si">}</span><span class="s2">...</span>

<span class="s2">Read the full article on News2U.</span>
<span class="s2">    &quot;&quot;&quot;</span>

    <span class="n">sent_count</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">reader</span> <span class="ow">in</span> <span class="n">subscribed_readers</span><span class="p">:</span>
        <span class="n">email</span> <span class="o">=</span> <span class="n">reader</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">email</span>
        <span class="k">if</span> <span class="n">email</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Sending email to: </span><span class="si">{</span><span class="n">email</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">send_mail</span><span class="p">(</span>
                    <span class="n">subject</span><span class="p">,</span>
                    <span class="n">message</span><span class="p">,</span>
                    <span class="n">settings</span><span class="o">.</span><span class="n">DEFAULT_FROM_EMAIL</span><span class="p">,</span>
                    <span class="p">[</span><span class="n">reader</span><span class="o">.</span><span class="n">email</span><span class="p">],</span>
                    <span class="n">fail_silently</span><span class="o">=</span><span class="kc">False</span>  <span class="c1"># Show errors!</span>
                <span class="p">)</span>
                <span class="n">sent_count</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Sent!&quot;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Total emails sent: </span><span class="si">{</span><span class="n">sent_count</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>



<span class="c1"># Send newsletter email (Only Publisher &amp; Journalist can send)</span>
<div class="viewcode-block" id="send_newsletter_email">
<a class="viewcode-back" href="../../news2u.html#news2u.views.send_newsletter_email">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">send_newsletter_email</span><span class="p">(</span><span class="n">newsletter</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; Send newsletter to subscribers via email and after approval</span>
<span class="sd">      by editor.</span>

<span class="sd">    :param newsletter: Newsletter object to be sent</span>
<span class="sd">    :type newsletter: Newsletter</span>

<span class="sd">    :return: Number of emails sent (in console) (or None)</span>
<span class="sd">    :rtype: None</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># For newsletter published independently by journalists</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=== SEND NEWSLETTER EMAIL DEBUG ===&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Newsletter: </span><span class="si">{</span><span class="n">newsletter</span><span class="o">.</span><span class="n">newsletter_title</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Status: </span><span class="si">{</span><span class="n">newsletter</span><span class="o">.</span><span class="n">status</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Journalist: </span><span class="si">{</span><span class="n">newsletter</span><span class="o">.</span><span class="n">journalist</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Publisher: </span><span class="si">{</span><span class="n">newsletter</span><span class="o">.</span><span class="n">publisher</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># For newsletter published independently by journalists</span>
    <span class="k">if</span> <span class="n">newsletter</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="s1">&#39;published_newsletter&#39;</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Newsletter is independent&quot;</span><span class="p">)</span>
        <span class="n">subscribed_readers</span> <span class="o">=</span> <span class="n">CustomUser</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
            <span class="n">role</span><span class="o">=</span><span class="s1">&#39;reader&#39;</span><span class="p">,</span>
            <span class="n">subscribed_journalists</span><span class="o">=</span><span class="n">newsletter</span><span class="o">.</span><span class="n">journalist</span>
        <span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Subscribers found: </span><span class="si">{</span><span class="n">subscribed_readers</span><span class="o">.</span><span class="n">count</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># For newsletters published via publisher</span>
    <span class="k">elif</span> <span class="n">newsletter</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="s1">&#39;published_newsletter_by_publisher&#39;</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Newsletter is via publisher&quot;</span><span class="p">)</span>
        <span class="n">subscribed_readers</span> <span class="o">=</span> <span class="n">CustomUser</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
            <span class="n">role</span><span class="o">=</span><span class="s1">&#39;reader&#39;</span><span class="p">,</span>
            <span class="n">subscribed_publishers</span><span class="o">=</span><span class="n">newsletter</span><span class="o">.</span><span class="n">publisher</span>
        <span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Subscribers found: </span><span class="si">{</span><span class="n">subscribed_readers</span><span class="o">.</span><span class="n">count</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Newsletter status &#39; &quot;</span>
              <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">newsletter</span><span class="o">.</span><span class="n">status</span><span class="si">}</span><span class="s2">&#39; doesn&#39;t match - exiting&quot;</span><span class="p">)</span>
        <span class="k">return</span>

    <span class="c1"># If there are NO subscribers</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">subscribed_readers</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
        <span class="k">return</span>

    <span class="c1"># Prepare email</span>
    <span class="n">subject</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;New Newsletter: </span><span class="si">{</span><span class="n">newsletter</span><span class="o">.</span><span class="n">newsletter_title</span><span class="si">}</span><span class="s2">&quot;</span>

    <span class="c1"># Build articles section with previews</span>
    <span class="n">articles_text</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="k">if</span> <span class="n">newsletter</span><span class="o">.</span><span class="n">articles</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
        <span class="n">articles_text</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">--- Featured Articles ---</span><span class="se">\n\n</span><span class="s2">&quot;</span>
        <span class="k">for</span> <span class="n">article</span> <span class="ow">in</span> <span class="n">newsletter</span><span class="o">.</span><span class="n">articles</span><span class="o">.</span><span class="n">all</span><span class="p">():</span>
            <span class="n">articles_text</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">article</span><span class="o">.</span><span class="n">article_title</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="n">articles_text</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;By </span><span class="si">{</span><span class="n">article</span><span class="o">.</span><span class="n">journalist</span><span class="o">.</span><span class="n">journalist_name</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="n">articles_text</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">article</span><span class="o">.</span><span class="n">article_content</span><span class="p">[:</span><span class="mi">100</span><span class="p">]</span><span class="si">}</span><span class="s2">...</span><span class="se">\n\n</span><span class="s2">&quot;</span>

    <span class="n">message</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    A new newsletter by </span><span class="si">{</span><span class="n">newsletter</span><span class="o">.</span><span class="n">journalist</span><span class="o">.</span><span class="n">journalist_name</span><span class="si">}</span><span class="s2"> has</span>
<span class="s2">    just been released.</span>

<span class="s2">    </span><span class="si">{</span><span class="n">newsletter</span><span class="o">.</span><span class="n">newsletter_title</span><span class="si">}</span>
<span class="s2">    </span><span class="si">{</span><span class="s1">&#39;-&#39;</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">50</span><span class="si">}</span>

<span class="s2">    </span><span class="si">{</span><span class="n">newsletter</span><span class="o">.</span><span class="n">newsletter_content</span><span class="p">[:</span><span class="mi">200</span><span class="p">]</span><span class="si">}</span><span class="s2">...</span>
<span class="s2">    </span><span class="si">{</span><span class="n">articles_text</span><span class="si">}</span>

<span class="s2">    Visit News2U to read the full newsletter and articles.</span>
<span class="s2">    &quot;&quot;&quot;</span>

    <span class="c1"># Create email list</span>
    <span class="n">emails</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">reader</span> <span class="ow">in</span> <span class="n">subscribed_readers</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">reader</span><span class="o">.</span><span class="n">email</span><span class="p">:</span>  <span class="c1"># Check if they have an email</span>
            <span class="n">emails</span><span class="o">.</span><span class="n">append</span><span class="p">((</span>
                <span class="n">subject</span><span class="p">,</span>
                <span class="n">message</span><span class="p">,</span>
                <span class="n">settings</span><span class="o">.</span><span class="n">DEFAULT_FROM_EMAIL</span><span class="p">,</span>
                <span class="p">[</span><span class="n">reader</span><span class="o">.</span><span class="n">email</span><span class="p">]</span>
            <span class="p">))</span>

    <span class="k">if</span> <span class="n">emails</span><span class="p">:</span>
        <span class="n">send_mass_mail</span><span class="p">(</span><span class="n">emails</span><span class="p">,</span> <span class="n">fail_silently</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></div>



<span class="c1"># ============================================================</span>
<span class="c1"># DASHBOARDS</span>
<span class="c1"># ============================================================</span>

<span class="c1"># Publisher Dashboard</span>
<div class="viewcode-block" id="publisher_dashboard">
<a class="viewcode-back" href="../../news2u.html#news2u.views.publisher_dashboard">[docs]</a>
<span class="nd">@login_required</span>
<span class="nd">@user_passes_test</span><span class="p">(</span><span class="n">is_publisher</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">publisher_dashboard</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; Show publisher dashboard with stats on published content &quot;&quot;&quot;</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">publisher</span> <span class="o">=</span> <span class="n">Publisher</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">user</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">Publisher</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">:</span>
        <span class="n">messages</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s2">&quot;Publisher profile not found.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s1">&#39;home&#39;</span><span class="p">)</span>

    <span class="c1"># Show statistics for the dashboard</span>
    <span class="n">total_published_articles</span> <span class="o">=</span> <span class="n">Article</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
        <span class="n">publisher</span><span class="o">=</span><span class="n">publisher</span><span class="p">,</span>
        <span class="n">status</span><span class="o">=</span><span class="s1">&#39;published_publisher&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>
    <span class="n">total_newsletters</span> <span class="o">=</span> <span class="n">Newsletter</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
        <span class="n">publisher</span><span class="o">=</span><span class="n">publisher</span><span class="p">,</span>
        <span class="n">status</span><span class="o">=</span><span class="s1">&#39;published_newsletter_by_publisher&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>
    <span class="n">total_journalists</span> <span class="o">=</span> <span class="n">publisher</span><span class="o">.</span><span class="n">journalists</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>
    <span class="n">total_editors</span> <span class="o">=</span> <span class="n">publisher</span><span class="o">.</span><span class="n">editors</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>
    <span class="n">total_subscribers</span> <span class="o">=</span> <span class="n">publisher</span><span class="o">.</span><span class="n">reader_subscribers</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>
    <span class="n">total_requests</span> <span class="o">=</span> <span class="n">Article</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
        <span class="n">publisher</span><span class="o">=</span><span class="n">publisher</span><span class="p">,</span>
        <span class="n">status</span><span class="o">=</span><span class="s1">&#39;in_review_publisher&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>
    <span class="n">total_draft_newsletters</span> <span class="o">=</span> <span class="n">Newsletter</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
        <span class="n">publisher</span><span class="o">=</span><span class="n">publisher</span><span class="p">,</span>
        <span class="n">status</span><span class="o">=</span><span class="s1">&#39;draft&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;news2u/publisher_dashboard.html&#39;</span><span class="p">,</span> <span class="p">{</span>
        <span class="s1">&#39;total_published_articles&#39;</span><span class="p">:</span> <span class="n">total_published_articles</span><span class="p">,</span>
        <span class="s1">&#39;total_newsletters&#39;</span><span class="p">:</span> <span class="n">total_newsletters</span><span class="p">,</span>
        <span class="s1">&#39;total_journalists&#39;</span><span class="p">:</span> <span class="n">total_journalists</span><span class="p">,</span>
        <span class="s1">&#39;total_editors&#39;</span><span class="p">:</span> <span class="n">total_editors</span><span class="p">,</span>
        <span class="s1">&#39;total_subscribers&#39;</span><span class="p">:</span> <span class="n">total_subscribers</span><span class="p">,</span>
        <span class="s1">&#39;total_requests&#39;</span><span class="p">:</span> <span class="n">total_requests</span><span class="p">,</span>
        <span class="s1">&#39;total_draft_newsletters&#39;</span><span class="p">:</span> <span class="n">total_draft_newsletters</span>
    <span class="p">})</span></div>



<span class="c1"># Editor Dashboard</span>
<div class="viewcode-block" id="editor_dashboard">
<a class="viewcode-back" href="../../news2u.html#news2u.views.editor_dashboard">[docs]</a>
<span class="nd">@login_required</span>
<span class="nd">@user_passes_test</span><span class="p">(</span><span class="n">is_editor</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">editor_dashboard</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">editor</span> <span class="o">=</span> <span class="n">Editor</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">user</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">Editor</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">:</span>
        <span class="n">messages</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s2">&quot;Editor profile not found.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s1">&#39;home&#39;</span><span class="p">)</span>

    <span class="c1"># Show statistics for the dashboard</span>
    <span class="n">total_articles</span> <span class="o">=</span> <span class="n">Article</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
        <span class="n">editor</span><span class="o">=</span><span class="n">editor</span><span class="p">,</span>
        <span class="n">status__in</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;published_independent&#39;</span><span class="p">,</span> <span class="s1">&#39;published_publisher&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>
    <span class="n">total_newsletters</span> <span class="o">=</span> <span class="n">Newsletter</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
        <span class="n">status__in</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;ready_to_publish&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;published_newsletter&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;published_newsletter_by_publisher&#39;</span><span class="p">],</span>
        <span class="n">editor</span><span class="o">=</span><span class="n">editor</span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>
    <span class="n">total_journalists</span> <span class="o">=</span> <span class="n">editor</span><span class="o">.</span><span class="n">journalists</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>
    <span class="n">total_publishers</span> <span class="o">=</span> <span class="n">editor</span><span class="o">.</span><span class="n">publishers</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>
    <span class="n">edit_requests</span> <span class="o">=</span> <span class="n">Article</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
        <span class="n">editor</span><span class="o">=</span><span class="n">editor</span><span class="p">,</span>
        <span class="n">status</span><span class="o">=</span><span class="s1">&#39;awaiting_editor&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">()</span> <span class="o">+</span> <span class="n">Newsletter</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
        <span class="n">editor</span><span class="o">=</span><span class="n">editor</span><span class="p">,</span>
        <span class="n">status</span><span class="o">=</span><span class="s1">&#39;awaiting_editor&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>
    <span class="n">accepted_requests</span> <span class="o">=</span> <span class="n">Article</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
        <span class="n">editor</span><span class="o">=</span><span class="n">editor</span><span class="p">,</span>
        <span class="n">status</span><span class="o">=</span><span class="s1">&#39;ready_to_publish&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>
    <span class="n">declined_requests</span> <span class="o">=</span> <span class="n">Article</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
        <span class="n">editor</span><span class="o">=</span><span class="n">editor</span><span class="p">,</span>
        <span class="n">status</span><span class="o">=</span><span class="s1">&#39;revise&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>
    <span class="n">accepted_newsletters</span> <span class="o">=</span> <span class="n">Newsletter</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
        <span class="n">editor</span><span class="o">=</span><span class="n">editor</span><span class="p">,</span>
        <span class="n">status</span><span class="o">=</span><span class="s1">&#39;ready_to_publish&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;news2u/editor_dashboard.html&#39;</span><span class="p">,</span> <span class="p">{</span>
        <span class="s1">&#39;total_articles&#39;</span><span class="p">:</span> <span class="n">total_articles</span><span class="p">,</span>
        <span class="s1">&#39;total_newsletters&#39;</span><span class="p">:</span> <span class="n">total_newsletters</span><span class="p">,</span>
        <span class="s1">&#39;total_journalists&#39;</span><span class="p">:</span> <span class="n">total_journalists</span><span class="p">,</span>
        <span class="s1">&#39;total_publishers&#39;</span><span class="p">:</span> <span class="n">total_publishers</span><span class="p">,</span>
        <span class="s1">&#39;edit_requests&#39;</span><span class="p">:</span> <span class="n">edit_requests</span><span class="p">,</span>
        <span class="s1">&#39;accepted_requests&#39;</span><span class="p">:</span> <span class="n">accepted_requests</span><span class="p">,</span>
        <span class="s1">&#39;declined_requests&#39;</span><span class="p">:</span> <span class="n">declined_requests</span><span class="p">,</span>
        <span class="s1">&#39;accepted_newsletters&#39;</span><span class="p">:</span> <span class="n">accepted_newsletters</span>
    <span class="p">})</span></div>



<span class="c1"># Journalist Dashboard</span>
<div class="viewcode-block" id="journalist_dashboard">
<a class="viewcode-back" href="../../news2u.html#news2u.views.journalist_dashboard">[docs]</a>
<span class="nd">@login_required</span>
<span class="nd">@user_passes_test</span><span class="p">(</span><span class="n">is_journalist</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">journalist_dashboard</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">journalist</span> <span class="o">=</span> <span class="n">Journalist</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">user</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">Journalist</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">:</span>
        <span class="n">messages</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s2">&quot;Journalist profile not found.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s1">&#39;home&#39;</span><span class="p">)</span>

    <span class="c1"># Show statistics for the dashboard</span>
    <span class="n">total_newsletters</span> <span class="o">=</span> <span class="n">Newsletter</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
        <span class="n">journalist</span><span class="o">=</span><span class="n">journalist</span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>
    <span class="n">total_editors</span> <span class="o">=</span> <span class="n">journalist</span><span class="o">.</span><span class="n">editors</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>
    <span class="n">total_publishers</span> <span class="o">=</span> <span class="n">journalist</span><span class="o">.</span><span class="n">publishers</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>
    <span class="n">total_subscribers</span> <span class="o">=</span> <span class="n">CustomUser</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
        <span class="n">role</span><span class="o">=</span><span class="s1">&#39;reader&#39;</span><span class="p">,</span>
        <span class="n">subscribed_journalists</span><span class="o">=</span><span class="n">journalist</span>
    <span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>

    <span class="c1"># Get counts</span>
    <span class="n">draft_articles_count</span> <span class="o">=</span> <span class="n">Article</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
        <span class="n">journalist</span><span class="o">=</span><span class="n">journalist</span><span class="p">,</span>
        <span class="n">status__in</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;draft&#39;</span><span class="p">,</span> <span class="s1">&#39;revise&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>

    <span class="n">submitted_articles_count</span> <span class="o">=</span> <span class="n">Article</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
        <span class="n">journalist</span><span class="o">=</span><span class="n">journalist</span><span class="p">,</span> <span class="n">status</span><span class="o">=</span><span class="s1">&#39;awaiting_editor&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>

    <span class="n">published_articles_count</span> <span class="o">=</span> <span class="n">Article</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
        <span class="n">journalist</span><span class="o">=</span><span class="n">journalist</span><span class="p">,</span>
        <span class="n">status__in</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;published_independent&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;published_publisher&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>

    <span class="n">submitted_to_publisher_count</span> <span class="o">=</span> <span class="n">Article</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
        <span class="n">journalist</span><span class="o">=</span><span class="n">journalist</span><span class="p">,</span> <span class="n">status</span><span class="o">=</span><span class="s1">&#39;in_review_publisher&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>

    <span class="n">submitted_newsletters_count</span> <span class="o">=</span> <span class="n">Newsletter</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
        <span class="n">journalist</span><span class="o">=</span><span class="n">journalist</span><span class="p">,</span> <span class="n">status</span><span class="o">=</span><span class="s1">&#39;awaiting_editor&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>

    <span class="n">published_newsletters_count</span> <span class="o">=</span> <span class="n">Newsletter</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
        <span class="n">journalist</span><span class="o">=</span><span class="n">journalist</span><span class="p">,</span>
        <span class="n">status</span><span class="o">=</span><span class="s1">&#39;published_newsletter&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>

    <span class="n">draft_newsletters_count</span> <span class="o">=</span> <span class="n">Newsletter</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
        <span class="n">journalist</span><span class="o">=</span><span class="n">journalist</span><span class="p">,</span> <span class="n">status</span><span class="o">=</span><span class="s1">&#39;draft&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>

    <span class="n">accepted_articles</span> <span class="o">=</span> <span class="n">Article</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
        <span class="n">journalist</span><span class="o">=</span><span class="n">journalist</span><span class="p">,</span> <span class="n">status</span><span class="o">=</span><span class="s1">&#39;ready_to_publish&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>

    <span class="n">accepted_newsletters</span> <span class="o">=</span> <span class="n">Newsletter</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
        <span class="n">journalist</span><span class="o">=</span><span class="n">journalist</span><span class="p">,</span> <span class="n">status</span><span class="o">=</span><span class="s1">&#39;ready_to_publish&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;news2u/journalist_dashboard.html&#39;</span><span class="p">,</span> <span class="p">{</span>
        <span class="c1"># Show statistics</span>
        <span class="s1">&#39;total_newsletters&#39;</span><span class="p">:</span> <span class="n">total_newsletters</span><span class="p">,</span>
        <span class="s1">&#39;total_editors&#39;</span><span class="p">:</span> <span class="n">total_editors</span><span class="p">,</span>
        <span class="s1">&#39;total_publishers&#39;</span><span class="p">:</span> <span class="n">total_publishers</span><span class="p">,</span>
        <span class="s1">&#39;total_subscribers&#39;</span><span class="p">:</span> <span class="n">total_subscribers</span><span class="p">,</span>
        <span class="c1"># Show counts</span>
        <span class="s1">&#39;journalist&#39;</span><span class="p">:</span> <span class="n">journalist</span><span class="p">,</span>
        <span class="s1">&#39;draft_articles_count&#39;</span><span class="p">:</span> <span class="n">draft_articles_count</span><span class="p">,</span>
        <span class="s1">&#39;submitted_articles_count&#39;</span><span class="p">:</span> <span class="n">submitted_articles_count</span><span class="p">,</span>
        <span class="s1">&#39;published_articles_count&#39;</span><span class="p">:</span> <span class="n">published_articles_count</span><span class="p">,</span>
        <span class="s1">&#39;draft_newsletters_count&#39;</span><span class="p">:</span> <span class="n">draft_newsletters_count</span><span class="p">,</span>
        <span class="s1">&#39;accepted_articles&#39;</span><span class="p">:</span> <span class="n">accepted_articles</span><span class="p">,</span>
        <span class="s1">&#39;submitted_newsletters_count&#39;</span><span class="p">:</span> <span class="n">submitted_newsletters_count</span><span class="p">,</span>
        <span class="s1">&#39;published_newsletters_count&#39;</span><span class="p">:</span> <span class="n">published_newsletters_count</span><span class="p">,</span>
        <span class="s1">&#39;submitted_to_publisher_count&#39;</span><span class="p">:</span> <span class="n">submitted_to_publisher_count</span><span class="p">,</span>
        <span class="s1">&#39;accepted_newsletters&#39;</span><span class="p">:</span> <span class="n">accepted_newsletters</span><span class="p">,</span>
    <span class="p">})</span></div>



<span class="c1"># Reader Dashboard</span>
<div class="viewcode-block" id="reader_dashboard">
<a class="viewcode-back" href="../../news2u.html#news2u.views.reader_dashboard">[docs]</a>
<span class="nd">@login_required</span>
<span class="nd">@user_passes_test</span><span class="p">(</span><span class="n">is_reader</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">reader_dashboard</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; Show reader dashboard with stats on subscribed content &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">reader</span> <span class="o">=</span> <span class="n">Reader</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">user</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="p">)</span>
        <span class="n">customuser</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">customuser</span>
    <span class="k">except</span> <span class="n">Reader</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">:</span>
        <span class="n">messages</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s2">&quot;Reader profile not found.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s1">&#39;home&#39;</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">CustomUser</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">:</span>
        <span class="n">messages</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s2">&quot;User profile not found.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s1">&#39;home&#39;</span><span class="p">)</span>

    <span class="c1"># Articles from subscribed journalists and publishers</span>
    <span class="n">total_articles</span> <span class="o">=</span> <span class="n">Article</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
        <span class="n">journalist__in</span><span class="o">=</span><span class="n">customuser</span><span class="o">.</span><span class="n">subscribed_journalists</span><span class="o">.</span><span class="n">all</span><span class="p">(),</span>
        <span class="n">status__in</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;published_independent&#39;</span><span class="p">,</span> <span class="s1">&#39;published_publisher&#39;</span><span class="p">],</span>
        <span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">()</span> <span class="o">+</span> <span class="n">Article</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
            <span class="n">publisher__in</span><span class="o">=</span><span class="n">customuser</span><span class="o">.</span><span class="n">subscribed_publishers</span><span class="o">.</span><span class="n">all</span><span class="p">(),</span>
            <span class="n">status</span><span class="o">=</span><span class="s1">&#39;published_publisher&#39;</span>
            <span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>

    <span class="c1"># Newsletters from subscribed journalists and publishers</span>
    <span class="n">total_newsletters</span> <span class="o">=</span> <span class="n">Newsletter</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
        <span class="n">journalist__in</span><span class="o">=</span><span class="n">customuser</span><span class="o">.</span><span class="n">subscribed_journalists</span><span class="o">.</span><span class="n">all</span><span class="p">(),</span>
        <span class="n">status__in</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;published_newsletter&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;published_newsletter_by_publisher&#39;</span><span class="p">]</span>
        <span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">()</span> <span class="o">+</span> <span class="n">Newsletter</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
            <span class="n">publisher__in</span><span class="o">=</span><span class="n">customuser</span><span class="o">.</span><span class="n">subscribed_publishers</span><span class="o">.</span><span class="n">all</span><span class="p">(),</span>
            <span class="n">status__in</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;published_newsletter&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;published_newsletter_by_publisher&#39;</span><span class="p">]</span>
            <span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>

    <span class="n">context</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;reader&#39;</span><span class="p">:</span> <span class="n">reader</span><span class="p">,</span>
        <span class="s1">&#39;customuser&#39;</span><span class="p">:</span> <span class="n">customuser</span><span class="p">,</span>
        <span class="p">}</span>

    <span class="c1"># Subscription counts</span>
    <span class="n">total_journalists</span> <span class="o">=</span> <span class="n">customuser</span><span class="o">.</span><span class="n">subscribed_journalists</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>
    <span class="n">total_publishers</span> <span class="o">=</span> <span class="n">customuser</span><span class="o">.</span><span class="n">subscribed_publishers</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;news2u/reader_dashboard.html&#39;</span><span class="p">,</span> <span class="p">{</span>
        <span class="s1">&#39;total_articles&#39;</span><span class="p">:</span> <span class="n">total_articles</span><span class="p">,</span>
        <span class="s1">&#39;total_newsletters&#39;</span><span class="p">:</span> <span class="n">total_newsletters</span><span class="p">,</span>
        <span class="s1">&#39;total_journalists&#39;</span><span class="p">:</span> <span class="n">total_journalists</span><span class="p">,</span>
        <span class="s1">&#39;total_publishers&#39;</span><span class="p">:</span> <span class="n">total_publishers</span><span class="p">,</span>
        <span class="s1">&#39;context&#39;</span><span class="p">:</span> <span class="n">context</span><span class="p">,</span>
    <span class="p">})</span></div>



<span class="c1"># ============================================================</span>
<span class="c1"># SHARED VIEWS FOR PUBLISHED CONTENT</span>
<span class="c1"># ============================================================</span>

<span class="c1"># View Published Articles based on user role</span>
<div class="viewcode-block" id="my_published_articles">
<a class="viewcode-back" href="../../news2u.html#news2u.views.my_published_articles">[docs]</a>
<span class="nd">@login_required</span>
<span class="nd">@user_passes_test</span><span class="p">(</span><span class="k">lambda</span> <span class="n">u</span><span class="p">:</span>
                  <span class="n">is_journalist</span><span class="p">(</span><span class="n">u</span><span class="p">)</span> <span class="ow">or</span>
                  <span class="n">is_editor</span><span class="p">(</span><span class="n">u</span><span class="p">)</span> <span class="ow">or</span>
                  <span class="n">is_publisher</span><span class="p">(</span><span class="n">u</span><span class="p">)</span> <span class="ow">or</span>
                  <span class="n">is_reader</span><span class="p">(</span><span class="n">u</span><span class="p">))</span>
<span class="nd">@permission_required</span><span class="p">(</span>
    <span class="s1">&#39;news2u.view_article&#39;</span><span class="p">,</span> <span class="n">raise_exception</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">my_published_articles</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Show published articles based on user role&quot;&quot;&quot;</span>

    <span class="n">user</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span>

    <span class="k">if</span> <span class="n">is_journalist</span><span class="p">(</span><span class="n">user</span><span class="p">):</span>
        <span class="n">journalist</span> <span class="o">=</span> <span class="n">Journalist</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">user</span><span class="o">=</span><span class="n">user</span><span class="p">)</span>
        <span class="n">articles</span> <span class="o">=</span> <span class="n">Article</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
            <span class="n">journalist</span><span class="o">=</span><span class="n">journalist</span><span class="p">,</span>
            <span class="n">status__in</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;published_independent&#39;</span><span class="p">,</span> <span class="s1">&#39;published_publisher&#39;</span><span class="p">],</span>
        <span class="p">)</span>
        <span class="n">role_label</span> <span class="o">=</span> <span class="s2">&quot;Your Published Articles&quot;</span>

    <span class="k">elif</span> <span class="n">is_editor</span><span class="p">(</span><span class="n">user</span><span class="p">):</span>
        <span class="n">editor</span> <span class="o">=</span> <span class="n">Editor</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">user</span><span class="o">=</span><span class="n">user</span><span class="p">)</span>
        <span class="n">articles</span> <span class="o">=</span> <span class="n">Article</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
            <span class="n">editor</span><span class="o">=</span><span class="n">editor</span><span class="p">,</span>
            <span class="n">status__in</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;published_independent&#39;</span><span class="p">,</span> <span class="s1">&#39;published_publisher&#39;</span><span class="p">],</span>
            <span class="n">is_approved</span><span class="o">=</span><span class="kc">True</span>
        <span class="p">)</span>
        <span class="n">role_label</span> <span class="o">=</span> <span class="s2">&quot;Articles You Approved&quot;</span>

    <span class="k">elif</span> <span class="n">is_publisher</span><span class="p">(</span><span class="n">user</span><span class="p">):</span>
        <span class="n">publisher</span> <span class="o">=</span> <span class="n">Publisher</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">user</span><span class="o">=</span><span class="n">user</span><span class="p">)</span>
        <span class="n">articles</span> <span class="o">=</span> <span class="n">Article</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
            <span class="n">publisher</span><span class="o">=</span><span class="n">publisher</span><span class="p">,</span>
            <span class="n">status</span><span class="o">=</span><span class="s1">&#39;published_publisher&#39;</span><span class="p">,</span>
            <span class="n">is_approved</span><span class="o">=</span><span class="kc">True</span>
        <span class="p">)</span>
        <span class="n">role_label</span> <span class="o">=</span> <span class="s2">&quot;Published Articles from Your Publication House&quot;</span>

    <span class="k">elif</span> <span class="n">is_reader</span><span class="p">(</span><span class="n">user</span><span class="p">):</span>
        <span class="n">custom_user</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">customuser</span>
        <span class="n">articles</span> <span class="o">=</span> <span class="n">Article</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
            <span class="n">journalist__in</span><span class="o">=</span><span class="n">custom_user</span><span class="o">.</span><span class="n">subscribed_journalists</span><span class="o">.</span><span class="n">all</span><span class="p">(),</span>
            <span class="n">status__in</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;published_independent&#39;</span><span class="p">,</span> <span class="s1">&#39;published_publisher&#39;</span><span class="p">]</span>
        <span class="p">)</span> <span class="o">|</span> <span class="n">Article</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
            <span class="n">publisher__in</span><span class="o">=</span><span class="n">custom_user</span><span class="o">.</span><span class="n">subscribed_publishers</span><span class="o">.</span><span class="n">all</span><span class="p">(),</span>
            <span class="n">status</span><span class="o">=</span><span class="s1">&#39;published_publisher&#39;</span>
        <span class="p">)</span>
        <span class="n">role_label</span> <span class="o">=</span> <span class="s2">&quot;Articles from Your Subscriptions&quot;</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="n">articles</span> <span class="o">=</span> <span class="n">Article</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">none</span><span class="p">()</span>
        <span class="n">role_label</span> <span class="o">=</span> <span class="s2">&quot;No Articles to Read yet. Are you subscribed?&quot;</span>

    <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;news2u/my_published_articles.html&#39;</span><span class="p">,</span> <span class="p">{</span>
        <span class="s1">&#39;articles&#39;</span><span class="p">:</span> <span class="n">articles</span><span class="p">,</span>
        <span class="s1">&#39;role_label&#39;</span><span class="p">:</span> <span class="n">role_label</span><span class="p">,</span>
        <span class="s1">&#39;is_reader&#39;</span><span class="p">:</span> <span class="n">is_reader</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="p">),</span>
        <span class="s1">&#39;is_journalist&#39;</span><span class="p">:</span> <span class="n">is_journalist</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="p">),</span>
        <span class="s1">&#39;is_editor&#39;</span><span class="p">:</span> <span class="n">is_editor</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="p">),</span>
        <span class="s1">&#39;is_publisher&#39;</span><span class="p">:</span> <span class="n">is_publisher</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="p">),</span>
    <span class="p">})</span></div>



<span class="c1"># View Published Newsletters based on user role</span>
<div class="viewcode-block" id="my_published_newsletters">
<a class="viewcode-back" href="../../news2u.html#news2u.views.my_published_newsletters">[docs]</a>
<span class="nd">@login_required</span>
<span class="nd">@user_passes_test</span><span class="p">(</span><span class="k">lambda</span> <span class="n">u</span><span class="p">:</span>
                  <span class="n">is_journalist</span><span class="p">(</span><span class="n">u</span><span class="p">)</span> <span class="ow">or</span>
                  <span class="n">is_editor</span><span class="p">(</span><span class="n">u</span><span class="p">)</span> <span class="ow">or</span>
                  <span class="n">is_publisher</span><span class="p">(</span><span class="n">u</span><span class="p">)</span> <span class="ow">or</span>
                  <span class="n">is_reader</span><span class="p">(</span><span class="n">u</span><span class="p">))</span>
<span class="nd">@permission_required</span><span class="p">(</span>
    <span class="s1">&#39;news2u.view_newsletter&#39;</span><span class="p">,</span> <span class="n">raise_exception</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">my_published_newsletters</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Show published newsletters based on user role&quot;&quot;&quot;</span>

    <span class="n">user</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span>

    <span class="k">if</span> <span class="n">is_journalist</span><span class="p">(</span><span class="n">user</span><span class="p">):</span>
        <span class="n">journalist</span> <span class="o">=</span> <span class="n">Journalist</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">user</span><span class="o">=</span><span class="n">user</span><span class="p">)</span>
        <span class="n">newsletters</span> <span class="o">=</span> <span class="n">Newsletter</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
            <span class="n">journalist</span><span class="o">=</span><span class="n">journalist</span><span class="p">,</span>
            <span class="n">status</span><span class="o">=</span><span class="s1">&#39;published_newsletter&#39;</span>
        <span class="p">)</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="s1">&#39;-published_at&#39;</span><span class="p">)</span>
        <span class="n">role_label</span> <span class="o">=</span> <span class="s2">&quot;Your Published Newsletters&quot;</span>

    <span class="k">elif</span> <span class="n">is_editor</span><span class="p">(</span><span class="n">user</span><span class="p">):</span>
        <span class="n">editor</span> <span class="o">=</span> <span class="n">Editor</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">user</span><span class="o">=</span><span class="n">user</span><span class="p">)</span>
        <span class="n">newsletters</span> <span class="o">=</span> <span class="n">Newsletter</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
            <span class="n">editor</span><span class="o">=</span><span class="n">editor</span><span class="p">,</span>
            <span class="n">is_approved</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="p">)</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="s1">&#39;-published_at&#39;</span><span class="p">)</span>
        <span class="n">role_label</span> <span class="o">=</span> <span class="s2">&quot;Newsletters You Approved&quot;</span>

    <span class="k">elif</span> <span class="n">is_publisher</span><span class="p">(</span><span class="n">user</span><span class="p">):</span>
        <span class="n">publisher</span> <span class="o">=</span> <span class="n">Publisher</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">user</span><span class="o">=</span><span class="n">user</span><span class="p">)</span>
        <span class="n">newsletters</span> <span class="o">=</span> <span class="n">Newsletter</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
            <span class="n">publisher</span><span class="o">=</span><span class="n">publisher</span><span class="p">,</span>
            <span class="n">status</span><span class="o">=</span><span class="s1">&#39;published_newsletter_by_publisher&#39;</span>
        <span class="p">)</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="s1">&#39;-published_at&#39;</span><span class="p">)</span>
        <span class="n">role_label</span> <span class="o">=</span> <span class="s2">&quot;Published Newsletters from Your Publication House&quot;</span>

    <span class="k">elif</span> <span class="n">is_reader</span><span class="p">(</span><span class="n">user</span><span class="p">):</span>
        <span class="n">custom_user</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">customuser</span>
        <span class="n">newsletters</span> <span class="o">=</span> <span class="n">Newsletter</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
            <span class="n">journalist__in</span><span class="o">=</span><span class="n">custom_user</span><span class="o">.</span><span class="n">subscribed_journalists</span><span class="o">.</span><span class="n">all</span><span class="p">(),</span>
            <span class="n">is_approved</span><span class="o">=</span><span class="kc">True</span>
        <span class="p">)</span> <span class="o">|</span> <span class="n">Newsletter</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
            <span class="n">publisher__in</span><span class="o">=</span><span class="n">custom_user</span><span class="o">.</span><span class="n">subscribed_publishers</span><span class="o">.</span><span class="n">all</span><span class="p">(),</span>
            <span class="n">status__in</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;published_newsletter&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;published_newsletter_by_publisher&#39;</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="n">newsletters</span> <span class="o">=</span> <span class="n">newsletters</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="s1">&#39;-published_at&#39;</span><span class="p">)</span>
        <span class="n">role_label</span> <span class="o">=</span> <span class="s2">&quot;Newsletters from Your Subscriptions&quot;</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="n">newsletters</span> <span class="o">=</span> <span class="n">Newsletter</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">none</span><span class="p">()</span>
        <span class="n">role_label</span> <span class="o">=</span> <span class="s2">&quot;No Newsletters&quot;</span>

    <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;news2u/my_published_newsletters.html&#39;</span><span class="p">,</span> <span class="p">{</span>
        <span class="s1">&#39;newsletters&#39;</span><span class="p">:</span> <span class="n">newsletters</span><span class="p">,</span>
        <span class="s1">&#39;role_label&#39;</span><span class="p">:</span> <span class="n">role_label</span><span class="p">,</span>
        <span class="s1">&#39;is_journalist&#39;</span><span class="p">:</span> <span class="n">is_journalist</span><span class="p">(</span><span class="n">user</span><span class="p">),</span>
        <span class="s1">&#39;is_editor&#39;</span><span class="p">:</span> <span class="n">is_editor</span><span class="p">(</span><span class="n">user</span><span class="p">),</span>
        <span class="s1">&#39;is_publisher&#39;</span><span class="p">:</span> <span class="n">is_publisher</span><span class="p">(</span><span class="n">user</span><span class="p">),</span>
        <span class="s1">&#39;is_reader&#39;</span><span class="p">:</span> <span class="n">is_reader</span><span class="p">(</span><span class="n">user</span><span class="p">),</span>
    <span class="p">})</span></div>



<span class="c1"># ============================================================</span>
<span class="c1"># JOURNALIST FUNCTIONS</span>
<span class="c1"># ============================================================</span>

<span class="c1"># Create Article</span>
<div class="viewcode-block" id="create_article">
<a class="viewcode-back" href="../../news2u.html#news2u.views.create_article">[docs]</a>
<span class="nd">@login_required</span>
<span class="nd">@user_passes_test</span><span class="p">(</span><span class="n">is_journalist</span><span class="p">)</span>
<span class="nd">@permission_required</span><span class="p">(</span><span class="s1">&#39;news2u.add_article&#39;</span><span class="p">,</span> <span class="n">raise_exception</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">create_article</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; Journalist is the only user that can create an article.</span>
<span class="sd">    - Can publish independently</span>
<span class="sd">    - Can submit and publish via publisher</span>
<span class="sd">    - All articles need to be edited by an editor and approved</span>
<span class="sd">    before publication</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Clear old messages</span>
    <span class="n">storage</span> <span class="o">=</span> <span class="n">messages</span><span class="o">.</span><span class="n">get_messages</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">storage</span><span class="p">:</span>
        <span class="k">pass</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">journalist</span> <span class="o">=</span> <span class="n">Journalist</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">user</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">Journalist</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">:</span>
        <span class="n">messages</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s2">&quot;Journalist profile not found.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s1">&#39;home&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;POST&#39;</span><span class="p">:</span>
        <span class="n">form</span> <span class="o">=</span> <span class="n">ArticleForm</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="p">,</span> <span class="n">request</span><span class="o">.</span><span class="n">FILES</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">form</span><span class="o">.</span><span class="n">is_valid</span><span class="p">():</span>
            <span class="n">article</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">commit</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">article</span><span class="o">.</span><span class="n">journalist</span> <span class="o">=</span> <span class="n">journalist</span>
            <span class="n">article</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="s1">&#39;draft&#39;</span>
            <span class="n">article</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>

            <span class="n">messages</span><span class="o">.</span><span class="n">success</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;Article created!&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s1">&#39;article_detail&#39;</span><span class="p">,</span> <span class="n">article_id</span><span class="o">=</span><span class="n">article</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">form</span> <span class="o">=</span> <span class="n">ArticleForm</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;news2u/create_article.html&#39;</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;form&#39;</span><span class="p">:</span> <span class="n">form</span><span class="p">})</span></div>



<span class="c1"># View Article Details</span>
<div class="viewcode-block" id="article_detail">
<a class="viewcode-back" href="../../news2u.html#news2u.views.article_detail">[docs]</a>
<span class="nd">@login_required</span>
<span class="nd">@user_passes_test</span><span class="p">(</span><span class="n">is_journalist</span><span class="p">)</span>
<span class="nd">@permission_required</span><span class="p">(</span><span class="s1">&#39;news2u.view_article&#39;</span><span class="p">,</span> <span class="n">raise_exception</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">article_detail</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">article_id</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; View article details &quot;&quot;&quot;</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">journalist</span> <span class="o">=</span> <span class="n">Journalist</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">user</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="p">)</span>
        <span class="n">article</span> <span class="o">=</span> <span class="n">Article</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
            <span class="nb">id</span><span class="o">=</span><span class="n">article_id</span><span class="p">,</span>
            <span class="n">journalist</span><span class="o">=</span><span class="n">journalist</span><span class="p">)</span>
    <span class="k">except</span> <span class="p">(</span><span class="n">Journalist</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">,</span> <span class="n">Article</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">):</span>
        <span class="n">messages</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s2">&quot;Article not found.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s1">&#39;journalist_dashboard&#39;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;news2u/article_detail.html&#39;</span><span class="p">,</span>
                  <span class="p">{</span><span class="s1">&#39;article&#39;</span><span class="p">:</span> <span class="n">article</span><span class="p">})</span></div>



<span class="c1"># Edit Article by Journalist or Editor</span>
<div class="viewcode-block" id="edit_article">
<a class="viewcode-back" href="../../news2u.html#news2u.views.edit_article">[docs]</a>
<span class="nd">@login_required</span>
<span class="nd">@user_passes_test</span><span class="p">(</span><span class="k">lambda</span> <span class="n">u</span><span class="p">:</span> <span class="n">is_journalist</span><span class="p">(</span><span class="n">u</span><span class="p">)</span> <span class="ow">or</span> <span class="n">is_editor</span><span class="p">(</span><span class="n">u</span><span class="p">))</span>
<span class="nd">@permission_required</span><span class="p">(</span><span class="s1">&#39;news2u.change_article&#39;</span><span class="p">,</span> <span class="n">raise_exception</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">edit_article</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">article_id</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; Journalists or Editors can edit articles:</span>
<span class="sd">    - Journalists can edit draft articles</span>
<span class="sd">    - Editors can edit articles awaiting their review&quot;&quot;&quot;</span>

    <span class="n">user</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span>
    <span class="n">article</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="c1"># Fetch the article based on user role</span>
    <span class="c1"># Journalists can edit their own draft articles</span>
    <span class="c1"># Editors can edit articles assigned to them awaiting review</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">is_journalist</span><span class="p">(</span><span class="n">user</span><span class="p">):</span>
            <span class="n">journalist</span> <span class="o">=</span> <span class="n">Journalist</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">user</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="p">)</span>
            <span class="n">article</span> <span class="o">=</span> <span class="n">Article</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                <span class="nb">id</span><span class="o">=</span><span class="n">article_id</span><span class="p">,</span>
                <span class="n">journalist</span><span class="o">=</span><span class="n">journalist</span><span class="p">,</span>
                <span class="n">status__in</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;draft&#39;</span><span class="p">,</span> <span class="s1">&#39;revise&#39;</span><span class="p">]</span>
                <span class="p">)</span>

        <span class="k">elif</span> <span class="n">is_editor</span><span class="p">(</span><span class="n">user</span><span class="p">):</span>
            <span class="n">editor</span> <span class="o">=</span> <span class="n">Editor</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">user</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="p">)</span>
            <span class="n">article</span> <span class="o">=</span> <span class="n">Article</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                <span class="nb">id</span><span class="o">=</span><span class="n">article_id</span><span class="p">,</span>
                <span class="n">editor</span><span class="o">=</span><span class="n">editor</span><span class="p">,</span>
                <span class="n">status</span><span class="o">=</span><span class="s1">&#39;awaiting_editor&#39;</span>
                <span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">messages</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s2">&quot;Access denied.&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s1">&#39;home&#39;</span><span class="p">)</span>

    <span class="k">except</span> <span class="p">(</span><span class="n">Journalist</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">,</span>
            <span class="n">Editor</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">,</span>
            <span class="n">Article</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">):</span>

        <span class="n">messages</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s2">&quot;Article not found.&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">is_journalist</span><span class="p">(</span><span class="n">user</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s1">&#39;journalist_dashboard&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s1">&#39;editor_dashboard&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;POST&#39;</span><span class="p">:</span>
        <span class="n">form</span> <span class="o">=</span> <span class="n">ArticleForm</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="p">,</span> <span class="n">request</span><span class="o">.</span><span class="n">FILES</span><span class="p">,</span> <span class="n">instance</span><span class="o">=</span><span class="n">article</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">form</span><span class="o">.</span><span class="n">is_valid</span><span class="p">():</span>
            <span class="n">form</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
            <span class="n">messages</span><span class="o">.</span><span class="n">success</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;Article Updated!&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">is_journalist</span><span class="p">(</span><span class="n">user</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s1">&#39;article_detail&#39;</span><span class="p">,</span> <span class="n">article_id</span><span class="o">=</span><span class="n">article</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">is_editor</span><span class="p">(</span><span class="n">user</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s1">&#39;view_requests&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s1">&#39;home&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">form</span> <span class="o">=</span> <span class="n">ArticleForm</span><span class="p">(</span><span class="n">instance</span><span class="o">=</span><span class="n">article</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;news2u/edit_article.html&#39;</span><span class="p">,</span>
                  <span class="p">{</span><span class="s1">&#39;form&#39;</span><span class="p">:</span> <span class="n">form</span><span class="p">,</span>
                   <span class="s1">&#39;article&#39;</span><span class="p">:</span> <span class="n">article</span><span class="p">,</span>
                   <span class="n">is_journalist</span><span class="p">:</span> <span class="n">is_journalist</span><span class="p">(</span><span class="n">user</span><span class="p">),</span>
                   <span class="n">is_editor</span><span class="p">:</span> <span class="n">is_editor</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
                   <span class="p">})</span></div>



<span class="c1"># Select Editor for Article</span>
<div class="viewcode-block" id="select_editor">
<a class="viewcode-back" href="../../news2u.html#news2u.views.select_editor">[docs]</a>
<span class="nd">@login_required</span>
<span class="nd">@user_passes_test</span><span class="p">(</span><span class="n">is_journalist</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">select_editor</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">article_id</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; All articles require approval by an editor &quot;&quot;&quot;</span>

    <span class="n">user</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span>
    <span class="n">article</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">journalist</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">publisher</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="c1"># Fetch the article based on user role</span>
    <span class="c1"># Journalists can select editor for their own draft articles</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">is_journalist</span><span class="p">(</span><span class="n">user</span><span class="p">):</span>
            <span class="n">journalist</span> <span class="o">=</span> <span class="n">Journalist</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">user</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="p">)</span>
            <span class="n">article</span> <span class="o">=</span> <span class="n">Article</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                <span class="nb">id</span><span class="o">=</span><span class="n">article_id</span><span class="p">,</span>
                <span class="n">journalist</span><span class="o">=</span><span class="n">journalist</span><span class="p">,</span>
                <span class="n">status__in</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;draft&#39;</span><span class="p">,</span> <span class="s1">&#39;revise&#39;</span><span class="p">]</span>
                <span class="p">)</span>

        <span class="k">elif</span> <span class="n">is_publisher</span><span class="p">(</span><span class="n">user</span><span class="p">):</span>
            <span class="n">publisher</span> <span class="o">=</span> <span class="n">Publisher</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">user</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="p">)</span>
            <span class="n">article</span> <span class="o">=</span> <span class="n">Article</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                <span class="nb">id</span><span class="o">=</span><span class="n">article_id</span><span class="p">,</span>
                <span class="n">publisher</span><span class="o">=</span><span class="n">publisher</span><span class="p">,</span>
                <span class="n">status</span><span class="o">=</span><span class="s1">&#39;draft&#39;</span>
                <span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">messages</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s2">&quot;Access denied.&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s1">&#39;home&#39;</span><span class="p">)</span>

    <span class="k">except</span> <span class="p">(</span><span class="n">Journalist</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">,</span>
            <span class="n">Publisher</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">,</span>
            <span class="n">Article</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">):</span>
        <span class="n">messages</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s2">&quot;Publication not found.&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">is_journalist</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s1">&#39;journalist_dashboard&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s1">&#39;publisher_dashboard&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;POST&#39;</span><span class="p">:</span>
        <span class="n">form</span> <span class="o">=</span> <span class="n">SelectEditorForm</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">form</span><span class="o">.</span><span class="n">is_valid</span><span class="p">():</span>
            <span class="n">article</span><span class="o">.</span><span class="n">editor</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s1">&#39;editor&#39;</span><span class="p">]</span>
            <span class="n">article</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="s1">&#39;awaiting_editor&#39;</span>
            <span class="n">article</span><span class="o">.</span><span class="n">submitted_at</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
            <span class="n">article</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>

            <span class="n">messages</span><span class="o">.</span><span class="n">success</span><span class="p">(</span><span class="n">request</span><span class="p">,</span>
                             <span class="sa">f</span><span class="s1">&#39;Article sent to &#39;</span>
                             <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">article</span><span class="o">.</span><span class="n">editor</span><span class="o">.</span><span class="n">editor_name</span><span class="si">}</span><span class="s1"> for review.&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s1">&#39;article_submit_success&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">form</span> <span class="o">=</span> <span class="n">SelectEditorForm</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;news2u/select_editor.html&#39;</span><span class="p">,</span> <span class="p">{</span>
        <span class="s1">&#39;form&#39;</span><span class="p">:</span> <span class="n">form</span><span class="p">,</span>
        <span class="s1">&#39;article&#39;</span><span class="p">:</span> <span class="n">article</span><span class="p">,</span>
        <span class="s1">&#39;editor&#39;</span><span class="p">:</span> <span class="n">article</span><span class="o">.</span><span class="n">editor</span>
    <span class="p">})</span></div>



<span class="c1"># Select Editor for Newsletter</span>
<div class="viewcode-block" id="select_editor_newsletter">
<a class="viewcode-back" href="../../news2u.html#news2u.views.select_editor_newsletter">[docs]</a>
<span class="nd">@login_required</span>
<span class="nd">@user_passes_test</span><span class="p">(</span><span class="k">lambda</span> <span class="n">u</span><span class="p">:</span> <span class="n">is_journalist</span><span class="p">(</span><span class="n">u</span><span class="p">)</span> <span class="ow">or</span> <span class="n">is_publisher</span><span class="p">(</span><span class="n">u</span><span class="p">))</span>
<span class="k">def</span><span class="w"> </span><span class="nf">select_editor_newsletter</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">newsletter_id</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; All newsletters require approval by an editor &quot;&quot;&quot;</span>

    <span class="n">user</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span>
    <span class="n">newsletter</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">journalist</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">publisher</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="c1"># Fetch the article based on user role</span>
    <span class="c1"># Journalists and publishers can select an editor for their own</span>
    <span class="c1"># draft newsletters</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">is_journalist</span><span class="p">(</span><span class="n">user</span><span class="p">):</span>
            <span class="n">journalist</span> <span class="o">=</span> <span class="n">Journalist</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">user</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="p">)</span>
            <span class="n">newsletter</span> <span class="o">=</span> <span class="n">Newsletter</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                <span class="nb">id</span><span class="o">=</span><span class="n">newsletter_id</span><span class="p">,</span>
                <span class="n">journalist</span><span class="o">=</span><span class="n">journalist</span><span class="p">,</span>
                <span class="n">status</span><span class="o">=</span><span class="s1">&#39;draft&#39;</span>
                <span class="p">)</span>

        <span class="k">elif</span> <span class="n">is_publisher</span><span class="p">(</span><span class="n">user</span><span class="p">):</span>
            <span class="n">publisher</span> <span class="o">=</span> <span class="n">Publisher</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">user</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="p">)</span>
            <span class="n">newsletter</span> <span class="o">=</span> <span class="n">Newsletter</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                <span class="nb">id</span><span class="o">=</span><span class="n">newsletter_id</span><span class="p">,</span>
                <span class="n">publisher</span><span class="o">=</span><span class="n">publisher</span><span class="p">,</span>
                <span class="n">status</span><span class="o">=</span><span class="s1">&#39;draft&#39;</span>
                <span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">messages</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s2">&quot;Access denied.&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s1">&#39;home&#39;</span><span class="p">)</span>

    <span class="k">except</span> <span class="p">(</span><span class="n">Journalist</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">,</span>
            <span class="n">Publisher</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">,</span>
            <span class="n">Newsletter</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">):</span>
        <span class="n">messages</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s2">&quot;Publication not found.&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">is_journalist</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s1">&#39;journalist_dashboard&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s1">&#39;publisher_dashboard&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;POST&#39;</span><span class="p">:</span>
        <span class="n">form</span> <span class="o">=</span> <span class="n">SelectEditorForm</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">form</span><span class="o">.</span><span class="n">is_valid</span><span class="p">():</span>
            <span class="n">newsletter</span><span class="o">.</span><span class="n">editor</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s1">&#39;editor&#39;</span><span class="p">]</span>
            <span class="n">newsletter</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="s1">&#39;awaiting_editor&#39;</span>
            <span class="n">newsletter</span><span class="o">.</span><span class="n">submitted_at</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
            <span class="n">newsletter</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>

            <span class="n">messages</span><span class="o">.</span><span class="n">success</span><span class="p">(</span><span class="n">request</span><span class="p">,</span>
                             <span class="sa">f</span><span class="s1">&#39;Newsletter sent to&#39;</span>
                             <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">newsletter</span><span class="o">.</span><span class="n">editor</span><span class="o">.</span><span class="n">editor_name</span><span class="si">}</span><span class="s1"> for review.&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s1">&#39;newsletter_submit_success&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">form</span> <span class="o">=</span> <span class="n">SelectEditorForm</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;news2u/select_editor_newsletter.html&#39;</span><span class="p">,</span> <span class="p">{</span>
        <span class="s1">&#39;form&#39;</span><span class="p">:</span> <span class="n">form</span><span class="p">,</span>
        <span class="s1">&#39;newsletter&#39;</span><span class="p">:</span> <span class="n">newsletter</span><span class="p">,</span>
        <span class="s1">&#39;editor&#39;</span><span class="p">:</span> <span class="n">newsletter</span><span class="o">.</span><span class="n">editor</span><span class="p">,</span>
        <span class="n">is_journalist</span><span class="p">:</span> <span class="n">is_journalist</span><span class="p">(</span><span class="n">user</span><span class="p">),</span>
        <span class="n">is_publisher</span><span class="p">:</span> <span class="n">is_publisher</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
    <span class="p">})</span></div>



<span class="c1"># Newsletter submit success</span>
<div class="viewcode-block" id="newsletter_submit_success">
<a class="viewcode-back" href="../../news2u.html#news2u.views.newsletter_submit_success">[docs]</a>
<span class="nd">@login_required</span>
<span class="nd">@user_passes_test</span><span class="p">(</span><span class="k">lambda</span> <span class="n">u</span><span class="p">:</span> <span class="n">is_journalist</span><span class="p">(</span><span class="n">u</span><span class="p">)</span> <span class="ow">or</span> <span class="n">is_publisher</span><span class="p">(</span><span class="n">u</span><span class="p">))</span>
<span class="k">def</span><span class="w"> </span><span class="nf">newsletter_submit_success</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;news2u/newsletter_submit_success.html&#39;</span><span class="p">)</span></div>



<span class="c1"># Journalist publish independently (after approval by editor)</span>
<div class="viewcode-block" id="publish_independent">
<a class="viewcode-back" href="../../news2u.html#news2u.views.publish_independent">[docs]</a>
<span class="nd">@login_required</span>
<span class="nd">@user_passes_test</span><span class="p">(</span><span class="n">is_journalist</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">publish_independent</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">article_id</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; Journalist can publish article independently.&quot;&quot;&quot;</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">journalist</span> <span class="o">=</span> <span class="n">Journalist</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">user</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="p">)</span>
        <span class="n">article</span> <span class="o">=</span> <span class="n">Article</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
            <span class="nb">id</span><span class="o">=</span><span class="n">article_id</span><span class="p">,</span>
            <span class="n">journalist</span><span class="o">=</span><span class="n">journalist</span><span class="p">,</span>
            <span class="n">status</span><span class="o">=</span><span class="s1">&#39;ready_to_publish&#39;</span><span class="p">)</span>
    <span class="k">except</span> <span class="p">(</span><span class="n">Journalist</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">,</span> <span class="n">Article</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">):</span>
        <span class="n">messages</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s2">&quot;Article not found.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s1">&#39;journalist_dashboard&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;POST&#39;</span><span class="p">:</span>
        <span class="n">article</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="s1">&#39;published_independent&#39;</span>
        <span class="n">article</span><span class="o">.</span><span class="n">published_at</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
        <span class="n">article</span><span class="o">.</span><span class="n">publisher</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># No publisher for independent</span>
        <span class="n">article</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>

        <span class="c1"># Send email to subscribers</span>
        <span class="n">send_article_email</span><span class="p">(</span><span class="n">article</span><span class="p">)</span>

        <span class="c1"># Build the tweet</span>
        <span class="n">new_article_tweet</span> <span class="o">=</span> <span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;New Article Published!</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="si">{</span><span class="n">article</span><span class="o">.</span><span class="n">article_preview</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>

        <span class="c1"># Check if article has an image and tweet</span>
        <span class="n">tweet</span> <span class="o">=</span> <span class="n">Tweet</span><span class="p">()</span>
        <span class="n">tweet</span><span class="o">.</span><span class="n">make_tweet</span><span class="p">(</span>
            <span class="n">new_article_tweet</span><span class="p">,</span> <span class="n">article</span><span class="o">.</span><span class="n">article_photo</span><span class="o">.</span><span class="n">path</span>
            <span class="k">if</span> <span class="n">article</span><span class="o">.</span><span class="n">article_photo</span>
            <span class="k">else</span> <span class="kc">None</span><span class="p">)</span>

        <span class="n">messages</span><span class="o">.</span><span class="n">success</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;Article published independently!&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s1">&#39;journalist_dashboard&#39;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">render</span><span class="p">(</span>
        <span class="n">request</span><span class="p">,</span>
        <span class="s1">&#39;news2u/publish_independent.html&#39;</span><span class="p">,</span>
        <span class="p">{</span><span class="s1">&#39;article&#39;</span><span class="p">:</span> <span class="n">article</span><span class="p">}</span>
        <span class="p">)</span></div>



<span class="c1"># View Published Article</span>
<div class="viewcode-block" id="view_published_article">
<a class="viewcode-back" href="../../news2u.html#news2u.views.view_published_article">[docs]</a>
<span class="nd">@login_required</span>
<span class="nd">@user_passes_test</span><span class="p">(</span><span class="k">lambda</span> <span class="n">u</span><span class="p">:</span> <span class="n">is_journalist</span><span class="p">(</span><span class="n">u</span><span class="p">)</span> <span class="ow">or</span>
                  <span class="n">is_editor</span><span class="p">(</span><span class="n">u</span><span class="p">)</span> <span class="ow">or</span>
                  <span class="n">is_publisher</span><span class="p">(</span><span class="n">u</span><span class="p">)</span> <span class="ow">or</span>
                  <span class="n">is_reader</span><span class="p">(</span><span class="n">u</span><span class="p">))</span>
<span class="nd">@permission_required</span><span class="p">(</span><span class="s1">&#39;news2u.view_article&#39;</span><span class="p">,</span> <span class="n">raise_exception</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">view_published_article</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">article_id</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Show published articles for journalist&quot;&quot;&quot;</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">article</span> <span class="o">=</span> <span class="n">Article</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
            <span class="nb">id</span><span class="o">=</span><span class="n">article_id</span><span class="p">,</span>
            <span class="n">status__in</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;published_independent&#39;</span><span class="p">,</span> <span class="s1">&#39;published_publisher&#39;</span><span class="p">]</span>
        <span class="p">)</span>

    <span class="k">except</span> <span class="n">Article</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">:</span>
        <span class="n">messages</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s2">&quot;Article not found.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s1">&#39;home&#39;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;news2u/view_published_article.html&#39;</span><span class="p">,</span> <span class="p">{</span>
        <span class="s1">&#39;article&#39;</span><span class="p">:</span> <span class="n">article</span>
    <span class="p">})</span></div>



<span class="c1"># View Submitted Articles to Editor</span>
<div class="viewcode-block" id="view_submitted_articles">
<a class="viewcode-back" href="../../news2u.html#news2u.views.view_submitted_articles">[docs]</a>
<span class="nd">@login_required</span>
<span class="nd">@user_passes_test</span><span class="p">(</span><span class="n">is_journalist</span><span class="p">)</span>
<span class="nd">@permission_required</span><span class="p">(</span><span class="s1">&#39;news2u.view_article&#39;</span><span class="p">,</span> <span class="n">raise_exception</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">view_submitted_articles</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Show submitted articles for journalist&quot;&quot;&quot;</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">journalist</span> <span class="o">=</span> <span class="n">Journalist</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">user</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="p">)</span>
        <span class="n">articles</span> <span class="o">=</span> <span class="n">Article</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
            <span class="n">journalist</span><span class="o">=</span><span class="n">journalist</span><span class="p">,</span>
            <span class="n">status__in</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;awaiting_editor&#39;</span><span class="p">,</span> <span class="s1">&#39;in_review_publisher&#39;</span><span class="p">]</span>
        <span class="p">)</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="s1">&#39;-submitted_at&#39;</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">Journalist</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">:</span>
        <span class="n">messages</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s2">&quot;Journalist profile not found.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s1">&#39;home&#39;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;news2u/view_submitted_articles.html&#39;</span><span class="p">,</span> <span class="p">{</span>
        <span class="s1">&#39;articles&#39;</span><span class="p">:</span> <span class="n">articles</span>
    <span class="p">})</span></div>



<span class="c1"># Journalist submit to publisher (after approval by editor)</span>
<div class="viewcode-block" id="submit_to_publisher">
<a class="viewcode-back" href="../../news2u.html#news2u.views.submit_to_publisher">[docs]</a>
<span class="nd">@login_required</span>
<span class="nd">@user_passes_test</span><span class="p">(</span><span class="n">is_journalist</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">submit_to_publisher</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">article_id</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; Journalist can submit article to a publisher for publication.&quot;&quot;&quot;</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">journalist</span> <span class="o">=</span> <span class="n">Journalist</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">user</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="p">)</span>
        <span class="n">article</span> <span class="o">=</span> <span class="n">Article</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">article_id</span><span class="p">,</span>
                                      <span class="n">journalist</span><span class="o">=</span><span class="n">journalist</span><span class="p">,</span>
                                      <span class="n">status</span><span class="o">=</span><span class="s1">&#39;ready_to_publish&#39;</span><span class="p">)</span>
    <span class="k">except</span> <span class="p">(</span><span class="n">Journalist</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">,</span> <span class="n">Article</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">):</span>
        <span class="n">messages</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s2">&quot;Article not found.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s1">&#39;journalist_dashboard&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;POST&#39;</span><span class="p">:</span>
        <span class="n">form</span> <span class="o">=</span> <span class="n">SubmitToPublisherForm</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">form</span><span class="o">.</span><span class="n">is_valid</span><span class="p">():</span>
            <span class="n">article</span><span class="o">.</span><span class="n">publisher</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s1">&#39;publisher&#39;</span><span class="p">]</span>
            <span class="n">article</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="s1">&#39;in_review_publisher&#39;</span>
            <span class="n">article</span><span class="o">.</span><span class="n">published_at</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
            <span class="n">article</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>

            <span class="n">messages</span><span class="o">.</span><span class="n">success</span><span class="p">(</span><span class="n">request</span><span class="p">,</span>
                             <span class="sa">f</span><span class="s1">&#39;Article submitted to &#39;</span>
                             <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">article</span><span class="o">.</span><span class="n">publisher</span><span class="o">.</span><span class="n">publisher_name</span><span class="si">}</span><span class="s1">&#39;</span>
                             <span class="sa">f</span><span class="s1">&#39; for publication!&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s1">&#39;journalist_dashboard&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">form</span> <span class="o">=</span> <span class="n">SubmitToPublisherForm</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;news2u/submit_to_publisher.html&#39;</span><span class="p">,</span> <span class="p">{</span>
        <span class="s1">&#39;form&#39;</span><span class="p">:</span> <span class="n">form</span><span class="p">,</span>
        <span class="s1">&#39;article&#39;</span><span class="p">:</span> <span class="n">article</span>
    <span class="p">})</span></div>



<span class="c1"># Publish Success Message</span>
<div class="viewcode-block" id="publish_success">
<a class="viewcode-back" href="../../news2u.html#news2u.views.publish_success">[docs]</a>
<span class="nd">@login_required</span>
<span class="nd">@user_passes_test</span><span class="p">(</span><span class="k">lambda</span> <span class="n">u</span><span class="p">:</span> <span class="n">is_journalist</span><span class="p">(</span><span class="n">u</span><span class="p">)</span> <span class="ow">or</span> <span class="n">is_publisher</span><span class="p">(</span><span class="n">u</span><span class="p">))</span>
<span class="k">def</span><span class="w"> </span><span class="nf">publish_success</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;news2u/publish_success.html&#39;</span><span class="p">)</span></div>



<span class="c1"># Newsletter published independently by Journalist</span>
<div class="viewcode-block" id="publish_newsletter">
<a class="viewcode-back" href="../../news2u.html#news2u.views.publish_newsletter">[docs]</a>
<span class="nd">@login_required</span>
<span class="nd">@user_passes_test</span><span class="p">(</span><span class="n">is_journalist</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">publish_newsletter</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">newsletter_id</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; Journalist can publish newsletter independently.&quot;&quot;&quot;</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">journalist</span> <span class="o">=</span> <span class="n">Journalist</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">user</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="p">)</span>
        <span class="n">newsletter</span> <span class="o">=</span> <span class="n">Newsletter</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
            <span class="nb">id</span><span class="o">=</span><span class="n">newsletter_id</span><span class="p">,</span>
            <span class="n">journalist</span><span class="o">=</span><span class="n">journalist</span><span class="p">,</span>
            <span class="n">status</span><span class="o">=</span><span class="s1">&#39;ready_to_publish&#39;</span><span class="p">)</span>
    <span class="k">except</span> <span class="p">(</span><span class="n">Journalist</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">,</span> <span class="n">Newsletter</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">):</span>
        <span class="n">messages</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s2">&quot;Newsletter not found.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s1">&#39;journalist_dashboard&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;POST&#39;</span><span class="p">:</span>
        <span class="n">newsletter</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="s1">&#39;published_newsletter&#39;</span>
        <span class="n">newsletter</span><span class="o">.</span><span class="n">published_at</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
        <span class="n">newsletter</span><span class="o">.</span><span class="n">publisher</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># No publisher for independent</span>
        <span class="n">newsletter</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>

        <span class="n">messages</span><span class="o">.</span><span class="n">success</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;Newsletter published independently!&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s1">&#39;journalist_dashboard&#39;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">render</span><span class="p">(</span>
        <span class="n">request</span><span class="p">,</span>
        <span class="s1">&#39;news2u/publish_newsletter.html&#39;</span><span class="p">,</span>
        <span class="p">{</span><span class="s1">&#39;newsletter&#39;</span><span class="p">:</span> <span class="n">newsletter</span><span class="p">}</span>
        <span class="p">)</span></div>



<span class="c1"># Newsletter published by Publication House</span>
<div class="viewcode-block" id="publish_newsletter_by_publisher">
<a class="viewcode-back" href="../../news2u.html#news2u.views.publish_newsletter_by_publisher">[docs]</a>
<span class="nd">@login_required</span>
<span class="nd">@user_passes_test</span><span class="p">(</span><span class="n">is_publisher</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">publish_newsletter_by_publisher</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">newsletter_id</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; Publisher can publish newsletters assigned to them.&quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">publisher</span> <span class="o">=</span> <span class="n">Publisher</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">user</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="p">)</span>
        <span class="n">newsletter</span> <span class="o">=</span> <span class="n">Newsletter</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
            <span class="nb">id</span><span class="o">=</span><span class="n">newsletter_id</span><span class="p">,</span>
            <span class="n">publisher</span><span class="o">=</span><span class="n">publisher</span><span class="p">,</span>
            <span class="n">status</span><span class="o">=</span><span class="s1">&#39;ready_to_publish&#39;</span><span class="p">)</span>
    <span class="k">except</span> <span class="p">(</span><span class="n">Publisher</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">,</span> <span class="n">Newsletter</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">):</span>
        <span class="n">messages</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s2">&quot;Newsletter not found.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s1">&#39;publish_success&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;POST&#39;</span><span class="p">:</span>
        <span class="n">newsletter</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="s1">&#39;published_newsletter_by_publisher&#39;</span>
        <span class="n">newsletter</span><span class="o">.</span><span class="n">published_at</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
        <span class="n">newsletter</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>

        <span class="c1"># Send email to subscribers</span>
        <span class="n">send_newsletter_email</span><span class="p">(</span><span class="n">newsletter</span><span class="p">)</span>

        <span class="n">messages</span><span class="o">.</span><span class="n">success</span><span class="p">(</span>
            <span class="n">request</span><span class="p">,</span>
            <span class="sa">f</span><span class="s1">&#39;Newsletter &quot;</span><span class="si">{</span><span class="n">newsletter</span><span class="o">.</span><span class="n">newsletter_title</span><span class="si">}</span><span class="s1">&quot; published!&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s1">&#39;publisher_dashboard&#39;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">render</span><span class="p">(</span>
        <span class="n">request</span><span class="p">,</span>
        <span class="s1">&#39;news2u/publish_newsletter_by_publisher.html&#39;</span><span class="p">,</span>
        <span class="p">{</span><span class="s1">&#39;newsletter&#39;</span><span class="p">:</span> <span class="n">newsletter</span><span class="p">}</span>
        <span class="p">)</span></div>



<div class="viewcode-block" id="view_published_newsletter">
<a class="viewcode-back" href="../../news2u.html#news2u.views.view_published_newsletter">[docs]</a>
<span class="nd">@login_required</span>
<span class="nd">@user_passes_test</span><span class="p">(</span><span class="k">lambda</span> <span class="n">u</span><span class="p">:</span> <span class="n">is_journalist</span><span class="p">(</span><span class="n">u</span><span class="p">)</span> <span class="ow">or</span> <span class="n">is_editor</span><span class="p">(</span><span class="n">u</span><span class="p">))</span>
<span class="k">def</span><span class="w"> </span><span class="nf">view_published_newsletter</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">newsletter_id</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Show published newsletters for journalist&quot;&quot;&quot;</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">newsletter</span> <span class="o">=</span> <span class="n">Newsletter</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
            <span class="nb">id</span><span class="o">=</span><span class="n">newsletter_id</span><span class="p">,</span>
            <span class="n">status__in</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;published_newsletter&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;published_newsletter_by_publisher&#39;</span><span class="p">]</span>
        <span class="p">)</span>

    <span class="k">except</span> <span class="n">Newsletter</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">:</span>
        <span class="n">messages</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s2">&quot;Newsletter not found.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s1">&#39;home&#39;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;news2u/view_published_newsletter.html&#39;</span><span class="p">,</span> <span class="p">{</span>
        <span class="s1">&#39;newsletter&#39;</span><span class="p">:</span> <span class="n">newsletter</span>
    <span class="p">})</span></div>



<span class="c1"># View Draft Articles</span>
<div class="viewcode-block" id="draft_articles">
<a class="viewcode-back" href="../../news2u.html#news2u.views.draft_articles">[docs]</a>
<span class="nd">@login_required</span>
<span class="nd">@user_passes_test</span><span class="p">(</span><span class="k">lambda</span> <span class="n">u</span><span class="p">:</span> <span class="n">is_journalist</span><span class="p">(</span><span class="n">u</span><span class="p">)</span> <span class="ow">or</span> <span class="n">is_editor</span><span class="p">(</span><span class="n">u</span><span class="p">))</span>
<span class="nd">@permission_required</span><span class="p">(</span><span class="s1">&#39;news2u.view_article&#39;</span><span class="p">,</span> <span class="n">raise_exception</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">draft_articles</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Show draft articles for journalist OR editor&quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">is_journalist</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">journalist</span> <span class="o">=</span> <span class="n">Journalist</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">user</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="p">)</span>
            <span class="n">articles</span> <span class="o">=</span> <span class="n">Article</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
                <span class="n">journalist</span><span class="o">=</span><span class="n">journalist</span><span class="p">,</span>
                <span class="n">status__in</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;draft&#39;</span><span class="p">,</span> <span class="s1">&#39;revise&#39;</span><span class="p">]</span>
            <span class="p">)</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="s1">&#39;-submitted_at&#39;</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">Journalist</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">:</span>
            <span class="n">messages</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s2">&quot;Journalist profile not found.&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s1">&#39;home&#39;</span><span class="p">)</span>

    <span class="k">elif</span> <span class="n">is_editor</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">editor</span> <span class="o">=</span> <span class="n">Editor</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">user</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="p">)</span>
            <span class="c1"># Editor sees articles that need revision</span>
            <span class="n">articles</span> <span class="o">=</span> <span class="n">Article</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
                <span class="n">editor</span><span class="o">=</span><span class="n">editor</span><span class="p">,</span>
                <span class="n">status</span><span class="o">=</span><span class="s1">&#39;revise&#39;</span>
            <span class="p">)</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="s1">&#39;-submitted_at&#39;</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">Editor</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">:</span>
            <span class="n">messages</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s2">&quot;Editor profile not found.&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s1">&#39;home&#39;</span><span class="p">)</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="n">messages</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s2">&quot;Access denied.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s1">&#39;home&#39;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;news2u/draft_articles.html&#39;</span><span class="p">,</span> <span class="p">{</span>
        <span class="s1">&#39;articles&#39;</span><span class="p">:</span> <span class="n">articles</span><span class="p">,</span>
        <span class="s1">&#39;is_editor&#39;</span><span class="p">:</span> <span class="n">is_editor</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="p">),</span>
        <span class="s1">&#39;is_journalist&#39;</span><span class="p">:</span> <span class="n">is_journalist</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="p">),</span>
    <span class="p">})</span></div>



<span class="c1"># Success page after article submission</span>
<div class="viewcode-block" id="article_submit_success">
<a class="viewcode-back" href="../../news2u.html#news2u.views.article_submit_success">[docs]</a>
<span class="nd">@login_required</span>
<span class="nd">@user_passes_test</span><span class="p">(</span><span class="n">is_journalist</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">article_submit_success</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;news2u/article_submit_success.html&#39;</span><span class="p">)</span></div>



<span class="c1"># ============================================================</span>
<span class="c1"># -- EDITOR FUNCTIONS -- ##</span>
<span class="c1"># ============================================================</span>

<span class="c1"># Review Article</span>
<div class="viewcode-block" id="review_article">
<a class="viewcode-back" href="../../news2u.html#news2u.views.review_article">[docs]</a>
<span class="nd">@login_required</span>
<span class="nd">@user_passes_test</span><span class="p">(</span><span class="n">is_editor</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">review_article</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">article_id</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; Editor is the only role that can approve articles.</span>
<span class="sd">    Editor can:</span>
<span class="sd">    - view</span>
<span class="sd">    - update</span>
<span class="sd">    - delete</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">editor</span> <span class="o">=</span> <span class="n">Editor</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">user</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="p">)</span>
        <span class="n">article</span> <span class="o">=</span> <span class="n">Article</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
            <span class="nb">id</span><span class="o">=</span><span class="n">article_id</span><span class="p">,</span>
            <span class="n">editor</span><span class="o">=</span><span class="n">editor</span><span class="p">,</span>
            <span class="n">status</span><span class="o">=</span><span class="s1">&#39;awaiting_editor&#39;</span><span class="p">)</span>
    <span class="k">except</span> <span class="p">(</span><span class="n">Editor</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">,</span> <span class="n">Article</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">):</span>
        <span class="n">messages</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s2">&quot;Article not found.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s1">&#39;view_requests&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;POST&#39;</span><span class="p">:</span>
        <span class="n">action</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;action&#39;</span><span class="p">)</span>
        <span class="n">editor_comments</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;editor_comments&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">action</span> <span class="o">==</span> <span class="s1">&#39;approve&#39;</span><span class="p">:</span>
            <span class="n">article</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="s1">&#39;ready_to_publish&#39;</span>
            <span class="n">article</span><span class="o">.</span><span class="n">is_approved</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">article</span><span class="o">.</span><span class="n">editor</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">article</span><span class="o">.</span><span class="n">editor_comments</span> <span class="o">=</span> <span class="n">editor_comments</span>
            <span class="n">article</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
            <span class="n">messages</span><span class="o">.</span><span class="n">success</span><span class="p">(</span>
                <span class="n">request</span><span class="p">,</span>
                <span class="s1">&#39;Article approved! &#39;</span>
                <span class="s1">&#39;Journalist can now publish.&#39;</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">action</span> <span class="o">==</span> <span class="s1">&#39;edit&#39;</span><span class="p">:</span>
            <span class="n">article</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="s1">&#39;in_review&#39;</span>
            <span class="n">article</span><span class="o">.</span><span class="n">editor_comments</span> <span class="o">=</span> <span class="n">editor_comments</span>
            <span class="n">article</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
            <span class="n">messages</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="n">request</span><span class="p">,</span>
                <span class="s1">&#39;Article edited by editor.&#39;</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">action</span> <span class="o">==</span> <span class="s1">&#39;revise&#39;</span><span class="p">:</span>
            <span class="n">article</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="s1">&#39;revise&#39;</span>
            <span class="n">article</span><span class="o">.</span><span class="n">editor_comments</span> <span class="o">=</span> <span class="n">editor_comments</span>
            <span class="n">article</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
            <span class="n">messages</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="n">request</span><span class="p">,</span>
                <span class="s1">&#39;Article sent back to journalist &#39;</span>
                <span class="s1">&#39;for revisions.&#39;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s1">&#39;view_requests&#39;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;news2u/review_article.html&#39;</span><span class="p">,</span> <span class="p">{</span>
        <span class="s1">&#39;article&#39;</span><span class="p">:</span> <span class="n">article</span><span class="p">})</span></div>



<span class="c1"># Accept/Approve Article</span>
<div class="viewcode-block" id="accept_article">
<a class="viewcode-back" href="../../news2u.html#news2u.views.accept_article">[docs]</a>
<span class="nd">@login_required</span>
<span class="nd">@user_passes_test</span><span class="p">(</span><span class="n">is_editor</span><span class="p">)</span>
<span class="nd">@permission_required</span><span class="p">(</span><span class="s1">&#39;news2u.change_article&#39;</span><span class="p">,</span> <span class="n">raise_exception</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">accept_article</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">article_id</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; Editor can approve articles assigned to them.&quot;&quot;&quot;</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">editor</span> <span class="o">=</span> <span class="n">Editor</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">user</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="p">)</span>
        <span class="n">article</span> <span class="o">=</span> <span class="n">Article</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
            <span class="nb">id</span><span class="o">=</span><span class="n">article_id</span><span class="p">,</span>
            <span class="n">editor</span><span class="o">=</span><span class="n">editor</span><span class="p">,</span>
            <span class="n">status</span><span class="o">=</span><span class="s1">&#39;awaiting_editor&#39;</span><span class="p">)</span>
    <span class="k">except</span> <span class="p">(</span><span class="n">Editor</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">,</span> <span class="n">Article</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">):</span>
        <span class="n">messages</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s2">&quot;Article not found.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s1">&#39;view_requests&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;POST&#39;</span><span class="p">:</span>
        <span class="n">action</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;action&#39;</span><span class="p">)</span>
        <span class="n">editor_comments</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;editor_comments&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>

        <span class="c1"># DEBUG</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;POST data: </span><span class="si">{</span><span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Action: &#39;</span><span class="si">{</span><span class="n">action</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Editor comments: &#39;</span><span class="si">{</span><span class="n">editor_comments</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">action</span> <span class="o">==</span> <span class="s1">&#39;approve&#39;</span><span class="p">:</span>
            <span class="n">article</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="s1">&#39;ready_to_publish&#39;</span>
            <span class="n">article</span><span class="o">.</span><span class="n">is_approved</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">article</span><span class="o">.</span><span class="n">editor_comments</span> <span class="o">=</span> <span class="n">editor_comments</span>
            <span class="n">article</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>

            <span class="n">messages</span><span class="o">.</span><span class="n">success</span><span class="p">(</span><span class="n">request</span><span class="p">,</span>
                             <span class="sa">f</span><span class="s1">&#39;Article &quot;</span><span class="si">{</span><span class="n">article</span><span class="o">.</span><span class="n">article_title</span><span class="si">}</span><span class="s1">&quot;&#39;</span>
                             <span class="sa">f</span><span class="s1">&#39;approved!&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s1">&#39;view_requests&#39;</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">action</span> <span class="o">==</span> <span class="s1">&#39;edit&#39;</span><span class="p">:</span>
            <span class="n">article</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="s1">&#39;draft&#39;</span>
            <span class="n">article</span><span class="o">.</span><span class="n">editor_comments</span> <span class="o">=</span> <span class="n">editor_comments</span>
            <span class="n">article</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>

    <span class="c1"># Pass the comments from the previous form (review_article) to</span>
    <span class="c1"># the template</span>
    <span class="n">editor_comments</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
        <span class="s1">&#39;editor_comments&#39;</span><span class="p">,</span> <span class="n">article</span><span class="o">.</span><span class="n">editor_comments</span> <span class="ow">or</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">render</span><span class="p">(</span>
        <span class="n">request</span><span class="p">,</span>
        <span class="s1">&#39;news2u/accept_article.html&#39;</span><span class="p">,</span>
            <span class="p">{</span><span class="s1">&#39;article&#39;</span><span class="p">:</span> <span class="n">article</span><span class="p">,</span>
            <span class="s1">&#39;editor_comments&#39;</span><span class="p">:</span> <span class="n">editor_comments</span><span class="p">}</span>
            <span class="p">)</span></div>



<span class="c1"># View Accepted Articles</span>
<div class="viewcode-block" id="view_accepted_articles">
<a class="viewcode-back" href="../../news2u.html#news2u.views.view_accepted_articles">[docs]</a>
<span class="nd">@login_required</span>
<span class="nd">@user_passes_test</span><span class="p">(</span><span class="k">lambda</span> <span class="n">u</span><span class="p">:</span> <span class="n">is_editor</span><span class="p">(</span><span class="n">u</span><span class="p">)</span> <span class="ow">or</span> <span class="n">is_journalist</span><span class="p">(</span><span class="n">u</span><span class="p">))</span>
<span class="nd">@permission_required</span><span class="p">(</span><span class="s1">&#39;news2u.view_article&#39;</span><span class="p">,</span> <span class="n">raise_exception</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">view_accepted_articles</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Show accepted articles journalist&quot;&quot;&quot;</span>

    <span class="n">user</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">is_editor</span><span class="p">(</span><span class="n">user</span><span class="p">):</span>
            <span class="n">editor</span> <span class="o">=</span> <span class="n">Editor</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">user</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="p">)</span>
            <span class="n">articles</span> <span class="o">=</span> <span class="n">Article</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
                <span class="n">editor</span><span class="o">=</span><span class="n">editor</span><span class="p">,</span>
                <span class="n">status</span><span class="o">=</span><span class="s1">&#39;ready_to_publish&#39;</span>
            <span class="p">)</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="s1">&#39;-submitted_at&#39;</span><span class="p">)</span>

            <span class="n">accepted_articles</span> <span class="o">=</span> <span class="n">Article</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
                <span class="n">editor</span><span class="o">=</span><span class="n">editor</span><span class="p">,</span>
                <span class="n">status</span><span class="o">=</span><span class="s1">&#39;ready_to_publish&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>

        <span class="k">elif</span> <span class="n">is_journalist</span><span class="p">(</span><span class="n">user</span><span class="p">):</span>
            <span class="n">journalist</span> <span class="o">=</span> <span class="n">Journalist</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">user</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="p">)</span>
            <span class="n">articles</span> <span class="o">=</span> <span class="n">Article</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
                <span class="n">journalist</span><span class="o">=</span><span class="n">journalist</span><span class="p">,</span>
                <span class="n">status</span><span class="o">=</span><span class="s1">&#39;ready_to_publish&#39;</span>
            <span class="p">)</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="s1">&#39;-submitted_at&#39;</span><span class="p">)</span>

            <span class="n">accepted_articles</span> <span class="o">=</span> <span class="n">Article</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
                <span class="n">journalist</span><span class="o">=</span><span class="n">journalist</span><span class="p">,</span>
                <span class="n">status</span><span class="o">=</span><span class="s1">&#39;ready_to_publish&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>

    <span class="k">except</span> <span class="p">(</span><span class="n">Editor</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">,</span> <span class="n">Journalist</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">):</span>
        <span class="n">messages</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">request</span><span class="p">,</span>
                       <span class="s2">&quot;Editor or Journalist profile not found.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s1">&#39;home&#39;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;news2u/view_accepted_articles.html&#39;</span><span class="p">,</span> <span class="p">{</span>
        <span class="s1">&#39;articles&#39;</span><span class="p">:</span> <span class="n">articles</span><span class="p">,</span>
        <span class="s1">&#39;accepted_articles&#39;</span><span class="p">:</span> <span class="n">accepted_articles</span><span class="p">,</span>
        <span class="s1">&#39;is_editor&#39;</span><span class="p">:</span> <span class="n">is_editor</span><span class="p">(</span><span class="n">user</span><span class="p">),</span>
        <span class="s1">&#39;is_journalist&#39;</span><span class="p">:</span> <span class="n">is_journalist</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
    <span class="p">})</span></div>



<span class="c1"># Decline/Reject Article</span>
<div class="viewcode-block" id="decline_article">
<a class="viewcode-back" href="../../news2u.html#news2u.views.decline_article">[docs]</a>
<span class="nd">@login_required</span>
<span class="nd">@user_passes_test</span><span class="p">(</span><span class="n">is_editor</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">decline_article</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">article_id</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">editor</span> <span class="o">=</span> <span class="n">Editor</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">user</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="p">)</span>
        <span class="n">article</span> <span class="o">=</span> <span class="n">Article</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
            <span class="nb">id</span><span class="o">=</span><span class="n">article_id</span><span class="p">,</span>
            <span class="n">editor</span><span class="o">=</span><span class="n">editor</span><span class="p">,</span>
            <span class="n">status</span><span class="o">=</span><span class="s1">&#39;awaiting_editor&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;POST&#39;</span><span class="p">:</span>
            <span class="c1"># If article is declined, set status to &#39;revise&#39;</span>
            <span class="n">editor_comments</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;editor_comments&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>

            <span class="n">article</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="s1">&#39;revise&#39;</span>
            <span class="n">article</span><span class="o">.</span><span class="n">is_approved</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">article</span><span class="o">.</span><span class="n">editor_comments</span> <span class="o">=</span> <span class="n">editor_comments</span>
            <span class="n">article</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
            <span class="n">messages</span><span class="o">.</span><span class="n">success</span><span class="p">(</span><span class="n">request</span><span class="p">,</span>
                             <span class="sa">f</span><span class="s1">&#39;Article &quot;</span><span class="si">{</span><span class="n">article</span><span class="o">.</span><span class="n">article_title</span><span class="si">}</span><span class="s1">&quot; &#39;</span>
                             <span class="sa">f</span><span class="s1">&#39;to be revised.&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s1">&#39;view_requests&#39;</span><span class="p">)</span>
    <span class="k">except</span> <span class="p">(</span><span class="n">Editor</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">,</span> <span class="n">Article</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">):</span>
        <span class="n">messages</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s2">&quot;Article not found.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s1">&#39;view_requests&#39;</span><span class="p">)</span></div>



<span class="c1"># Editor approved article</span>
<div class="viewcode-block" id="article_approved">
<a class="viewcode-back" href="../../news2u.html#news2u.views.article_approved">[docs]</a>
<span class="nd">@login_required</span>
<span class="nd">@user_passes_test</span><span class="p">(</span><span class="n">is_journalist</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">article_approved</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">article_id</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; Journalist can opt to publish independently or via</span>
<span class="sd">    a publication house.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">journalist</span> <span class="o">=</span> <span class="n">Journalist</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">user</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="p">)</span>
        <span class="n">article</span> <span class="o">=</span> <span class="n">Article</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
            <span class="nb">id</span><span class="o">=</span><span class="n">article_id</span><span class="p">,</span>
            <span class="n">journalist</span><span class="o">=</span><span class="n">journalist</span><span class="p">,</span>
            <span class="n">status</span><span class="o">=</span><span class="s1">&#39;ready_to_publish&#39;</span><span class="p">)</span>
    <span class="k">except</span> <span class="p">(</span><span class="n">Journalist</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">,</span> <span class="n">Article</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">):</span>
        <span class="n">messages</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">request</span><span class="p">,</span>
                       <span class="s2">&quot;Article not found or not ready to publish.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s1">&#39;journalist_dashboard&#39;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span>
                  <span class="s1">&#39;news2u/article_approved.html&#39;</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;article&#39;</span><span class="p">:</span> <span class="n">article</span><span class="p">})</span></div>



<span class="c1"># View Edited Article</span>
<div class="viewcode-block" id="view_edited_article">
<a class="viewcode-back" href="../../news2u.html#news2u.views.view_edited_article">[docs]</a>
<span class="nd">@login_required</span>
<span class="nd">@user_passes_test</span><span class="p">(</span><span class="k">lambda</span> <span class="n">u</span><span class="p">:</span>
                  <span class="n">is_journalist</span><span class="p">(</span><span class="n">u</span><span class="p">)</span> <span class="ow">or</span>
                  <span class="n">is_editor</span><span class="p">(</span><span class="n">u</span><span class="p">)</span> <span class="ow">or</span>
                  <span class="n">is_publisher</span><span class="p">(</span><span class="n">u</span><span class="p">))</span>
<span class="nd">@permission_required</span><span class="p">(</span><span class="s1">&#39;news2u.view_article&#39;</span><span class="p">,</span> <span class="n">raise_exception</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">view_edited_article</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">article_id</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; Journalist, Publisher or Editor can view article details.&quot;&quot;&quot;</span>

    <span class="n">user</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">is_journalist</span><span class="p">(</span><span class="n">user</span><span class="p">):</span>
            <span class="n">journalist</span> <span class="o">=</span> <span class="n">Journalist</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">user</span><span class="o">=</span><span class="n">user</span><span class="p">)</span>
            <span class="n">article</span> <span class="o">=</span> <span class="n">Article</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                <span class="nb">id</span><span class="o">=</span><span class="n">article_id</span><span class="p">,</span>
                <span class="n">journalist</span><span class="o">=</span><span class="n">journalist</span><span class="p">,</span>
                <span class="p">)</span>

        <span class="k">elif</span> <span class="n">is_editor</span><span class="p">(</span><span class="n">user</span><span class="p">):</span>
            <span class="n">editor</span> <span class="o">=</span> <span class="n">Editor</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">user</span><span class="o">=</span><span class="n">user</span><span class="p">)</span>
            <span class="n">article</span> <span class="o">=</span> <span class="n">Article</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                <span class="nb">id</span><span class="o">=</span><span class="n">article_id</span><span class="p">,</span>
                <span class="n">editor</span><span class="o">=</span><span class="n">editor</span>
                <span class="p">)</span>

        <span class="k">elif</span> <span class="n">is_publisher</span><span class="p">(</span><span class="n">user</span><span class="p">):</span>
            <span class="n">publisher</span> <span class="o">=</span> <span class="n">Publisher</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">user</span><span class="o">=</span><span class="n">user</span><span class="p">)</span>
            <span class="n">article</span> <span class="o">=</span> <span class="n">Article</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                <span class="nb">id</span><span class="o">=</span><span class="n">article_id</span><span class="p">,</span>
                <span class="n">publisher</span><span class="o">=</span><span class="n">publisher</span>
                <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">messages</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s2">&quot;Access denied.&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s1">&#39;home&#39;</span><span class="p">)</span>

    <span class="k">except</span> <span class="p">(</span><span class="n">Journalist</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">,</span>
            <span class="n">Editor</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">,</span>
            <span class="n">Article</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">):</span>
        <span class="n">messages</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s2">&quot;Article not found.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s1">&#39;home&#39;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;news2u/view_edited_article.html&#39;</span><span class="p">,</span>
                  <span class="p">{</span><span class="s1">&#39;article&#39;</span><span class="p">:</span> <span class="n">article</span><span class="p">,</span>
                   <span class="s1">&#39;is_journalist&#39;</span><span class="p">:</span> <span class="n">is_journalist</span><span class="p">(</span><span class="n">user</span><span class="p">),</span>
                   <span class="s1">&#39;is_editor&#39;</span><span class="p">:</span> <span class="n">is_editor</span><span class="p">(</span><span class="n">user</span><span class="p">),</span>
                   <span class="s1">&#39;is_publisher&#39;</span><span class="p">:</span> <span class="n">is_publisher</span><span class="p">(</span><span class="n">user</span><span class="p">),</span>
                   <span class="s1">&#39;editor_comments&#39;</span><span class="p">:</span> <span class="n">article</span><span class="o">.</span><span class="n">editor_comments</span>
                   <span class="p">})</span></div>



<span class="c1"># Delete Article</span>
<div class="viewcode-block" id="delete_article">
<a class="viewcode-back" href="../../news2u.html#news2u.views.delete_article">[docs]</a>
<span class="nd">@login_required</span>
<span class="nd">@user_passes_test</span><span class="p">(</span><span class="k">lambda</span> <span class="n">u</span><span class="p">:</span> <span class="n">is_journalist</span><span class="p">(</span><span class="n">u</span><span class="p">)</span> <span class="ow">or</span> <span class="n">is_editor</span><span class="p">(</span><span class="n">u</span><span class="p">))</span>
<span class="nd">@permission_required</span><span class="p">(</span><span class="s1">&#39;news2u.delete_article&#39;</span><span class="p">,</span> <span class="n">raise_exception</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">delete_article</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">article_id</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; Journalist or Editor can delete draft articles.&quot;&quot;&quot;</span>

    <span class="n">user</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">is_journalist</span><span class="p">(</span><span class="n">user</span><span class="p">):</span>
            <span class="n">journalist</span> <span class="o">=</span> <span class="n">Journalist</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">user</span><span class="o">=</span><span class="n">user</span><span class="p">)</span>
            <span class="n">article</span> <span class="o">=</span> <span class="n">Article</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                <span class="nb">id</span><span class="o">=</span><span class="n">article_id</span><span class="p">,</span>
                <span class="n">journalist</span><span class="o">=</span><span class="n">journalist</span><span class="p">,</span>
                <span class="n">status__in</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;draft&#39;</span><span class="p">,</span> <span class="s1">&#39;awaiting_editor&#39;</span><span class="p">]</span>
                <span class="p">)</span>
        <span class="k">elif</span> <span class="n">is_editor</span><span class="p">(</span><span class="n">user</span><span class="p">):</span>
            <span class="n">editor</span> <span class="o">=</span> <span class="n">Editor</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">user</span><span class="o">=</span><span class="n">user</span><span class="p">)</span>
            <span class="n">article</span> <span class="o">=</span> <span class="n">Article</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                <span class="nb">id</span><span class="o">=</span><span class="n">article_id</span><span class="p">,</span>
                <span class="n">editor</span><span class="o">=</span><span class="n">editor</span><span class="p">,</span>
                <span class="n">status__in</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;draft&#39;</span><span class="p">,</span> <span class="s1">&#39;awaiting_editor&#39;</span><span class="p">,</span> <span class="s1">&#39;in_review&#39;</span><span class="p">]</span>
                <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">messages</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s2">&quot;Access denied.&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s1">&#39;view_submitted_articles&#39;</span><span class="p">)</span>

    <span class="k">except</span> <span class="p">(</span><span class="n">Journalist</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">,</span>
            <span class="n">Editor</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">,</span>
            <span class="n">Article</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">):</span>
        <span class="n">messages</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s2">&quot;Article not found.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s1">&#39;view_submitted_articles&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;POST&#39;</span><span class="p">:</span>
        <span class="n">article</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>
        <span class="n">messages</span><span class="o">.</span><span class="n">success</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;Draft article deleted!&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s1">&#39;view_submitted_articles&#39;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;news2u/delete_article.html&#39;</span><span class="p">,</span>
                  <span class="p">{</span><span class="s1">&#39;article&#39;</span><span class="p">:</span> <span class="n">article</span><span class="p">})</span></div>



<span class="c1"># Create Newsletter</span>
<div class="viewcode-block" id="create_newsletter">
<a class="viewcode-back" href="../../news2u.html#news2u.views.create_newsletter">[docs]</a>
<span class="nd">@login_required</span>
<span class="nd">@user_passes_test</span><span class="p">(</span><span class="n">is_journalist</span><span class="p">)</span>
<span class="nd">@permission_required</span><span class="p">(</span><span class="s1">&#39;news2u.add_newsletter&#39;</span><span class="p">,</span> <span class="n">raise_exception</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">create_newsletter</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; Journalist is the only user that can create an article.</span>
<span class="sd">    - Can publish independently</span>
<span class="sd">    - Can submit and publish via publisher</span>
<span class="sd">    - All articles need to be edited by an editor and approved</span>
<span class="sd">    before publication</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">user</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span>
    <span class="n">journalist</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">publisher</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">is_journalist</span><span class="p">(</span><span class="n">user</span><span class="p">):</span>
            <span class="n">journalist</span> <span class="o">=</span> <span class="n">Journalist</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">user</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">is_publisher</span><span class="p">(</span><span class="n">user</span><span class="p">):</span>
            <span class="n">publisher</span> <span class="o">=</span> <span class="n">Publisher</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">user</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">messages</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s2">&quot;Access denied.&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s1">&#39;home&#39;</span><span class="p">)</span>

    <span class="k">except</span> <span class="n">Journalist</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">:</span>
        <span class="n">messages</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s2">&quot;Journalist profile not found.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s1">&#39;home&#39;</span><span class="p">)</span>

    <span class="c1"># Get only published articles by journalist or publisher</span>
    <span class="n">published_articles</span> <span class="o">=</span> <span class="n">Article</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
        <span class="n">journalist</span><span class="o">=</span><span class="n">journalist</span><span class="p">,</span>
        <span class="n">status__in</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;published_independent&#39;</span><span class="p">,</span> <span class="s1">&#39;published_publisher&#39;</span><span class="p">]</span>
    <span class="p">)</span>

    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;POST&#39;</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">journalist</span><span class="p">:</span>
            <span class="n">form</span> <span class="o">=</span> <span class="n">NewsletterForm</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="p">,</span>
                                  <span class="n">request</span><span class="o">.</span><span class="n">FILES</span><span class="p">,</span>
                                  <span class="n">journalist</span><span class="o">=</span><span class="n">journalist</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">publisher</span><span class="p">:</span>
            <span class="n">form</span> <span class="o">=</span> <span class="n">NewsletterForm</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="p">,</span>
                                  <span class="n">request</span><span class="o">.</span><span class="n">FILES</span><span class="p">,</span>
                                  <span class="n">publisher</span><span class="o">=</span><span class="n">publisher</span><span class="p">)</span>
        <span class="n">form</span> <span class="o">=</span> <span class="n">NewsletterForm</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="p">,</span>
                              <span class="n">request</span><span class="o">.</span><span class="n">FILES</span><span class="p">,</span>
                              <span class="n">journalist</span><span class="o">=</span><span class="n">journalist</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">form</span><span class="o">.</span><span class="n">is_valid</span><span class="p">():</span>
            <span class="n">newsletter</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">commit</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">journalist</span><span class="p">:</span>
                <span class="n">newsletter</span><span class="o">.</span><span class="n">journalist</span> <span class="o">=</span> <span class="n">journalist</span>
                <span class="n">newsletter</span><span class="o">.</span><span class="n">publisher</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">elif</span> <span class="n">publisher</span><span class="p">:</span>
                <span class="n">newsletter</span><span class="o">.</span><span class="n">publisher</span> <span class="o">=</span> <span class="n">publisher</span>
                <span class="n">newsletter</span><span class="o">.</span><span class="n">journalist</span> <span class="o">=</span> <span class="kc">None</span>

            <span class="n">newsletter</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="s1">&#39;draft&#39;</span> <span class="ow">or</span> <span class="s1">&#39;revise&#39;</span>
            <span class="n">newsletter</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
            <span class="n">form</span><span class="o">.</span><span class="n">save_m2m</span><span class="p">()</span>

            <span class="n">messages</span><span class="o">.</span><span class="n">success</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;Newsletter created!&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s1">&#39;newsletter_detail&#39;</span><span class="p">,</span>
                            <span class="n">newsletter_id</span><span class="o">=</span><span class="n">newsletter</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">journalist</span><span class="p">:</span>
            <span class="n">form</span> <span class="o">=</span> <span class="n">NewsletterForm</span><span class="p">(</span><span class="n">journalist</span><span class="o">=</span><span class="n">journalist</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">form</span> <span class="o">=</span> <span class="n">NewsletterForm</span><span class="p">(</span><span class="n">publisher</span><span class="o">=</span><span class="n">publisher</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;news2u/create_newsletter.html&#39;</span><span class="p">,</span>
                  <span class="p">{</span><span class="s1">&#39;form&#39;</span><span class="p">:</span> <span class="n">form</span><span class="p">,</span>
                   <span class="s1">&#39;is_journalist&#39;</span><span class="p">:</span> <span class="n">is_journalist</span><span class="p">(</span><span class="n">user</span><span class="p">),</span>
                   <span class="s1">&#39;is_publisher&#39;</span><span class="p">:</span> <span class="n">is_publisher</span><span class="p">(</span><span class="n">user</span><span class="p">),</span>
                   <span class="s1">&#39;published_articles&#39;</span><span class="p">:</span> <span class="n">published_articles</span>
                   <span class="p">})</span></div>



<span class="c1"># Delete Newsletter</span>
<div class="viewcode-block" id="delete_newsletter">
<a class="viewcode-back" href="../../news2u.html#news2u.views.delete_newsletter">[docs]</a>
<span class="nd">@login_required</span>
<span class="nd">@user_passes_test</span><span class="p">(</span><span class="k">lambda</span> <span class="n">u</span><span class="p">:</span> <span class="n">is_journalist</span><span class="p">(</span><span class="n">u</span><span class="p">)</span> <span class="ow">or</span> <span class="n">is_editor</span><span class="p">(</span><span class="n">u</span><span class="p">))</span>
<span class="nd">@permission_required</span><span class="p">(</span><span class="s1">&#39;news2u.delete_newsletter&#39;</span><span class="p">,</span> <span class="n">raise_exception</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">delete_newsletter</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">newsletter_id</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; Journalist or Editor can delete draft newsletters.&quot;&quot;&quot;</span>

    <span class="n">user</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">is_journalist</span><span class="p">(</span><span class="n">user</span><span class="p">):</span>
            <span class="n">journalist</span> <span class="o">=</span> <span class="n">Journalist</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">user</span><span class="o">=</span><span class="n">user</span><span class="p">)</span>
            <span class="n">newsletter</span> <span class="o">=</span> <span class="n">Newsletter</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                <span class="nb">id</span><span class="o">=</span><span class="n">newsletter_id</span><span class="p">,</span>
                <span class="n">journalist</span><span class="o">=</span><span class="n">journalist</span><span class="p">,</span>
                <span class="n">status</span><span class="o">=</span><span class="s1">&#39;draft&#39;</span>
                <span class="p">)</span>
        <span class="k">elif</span> <span class="n">is_editor</span><span class="p">(</span><span class="n">user</span><span class="p">):</span>
            <span class="n">editor</span> <span class="o">=</span> <span class="n">Editor</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">user</span><span class="o">=</span><span class="n">user</span><span class="p">)</span>
            <span class="n">newsletter</span> <span class="o">=</span> <span class="n">Newsletter</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                <span class="nb">id</span><span class="o">=</span><span class="n">newsletter_id</span><span class="p">,</span>
                <span class="n">editor</span><span class="o">=</span><span class="n">editor</span><span class="p">,</span>
                <span class="n">status</span><span class="o">=</span><span class="s1">&#39;draft&#39;</span>
                <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">messages</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s2">&quot;Access denied.&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s1">&#39;draft_newsletters&#39;</span><span class="p">)</span>

    <span class="k">except</span> <span class="p">(</span><span class="n">Journalist</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">,</span>
            <span class="n">Editor</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">,</span>
            <span class="n">Newsletter</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">):</span>
        <span class="n">messages</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s2">&quot;Newsletter not found.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s1">&#39;draft_newsletters&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;POST&#39;</span><span class="p">:</span>
        <span class="n">newsletter</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>
        <span class="n">messages</span><span class="o">.</span><span class="n">success</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;Draft newsletter deleted!&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s1">&#39;draft_newsletters&#39;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;news2u/delete_newsletter.html&#39;</span><span class="p">,</span>
                  <span class="p">{</span><span class="s1">&#39;newsletter&#39;</span><span class="p">:</span> <span class="n">newsletter</span><span class="p">})</span></div>



<span class="c1"># View Edited Newsletter</span>
<div class="viewcode-block" id="view_edited_newsletter">
<a class="viewcode-back" href="../../news2u.html#news2u.views.view_edited_newsletter">[docs]</a>
<span class="nd">@login_required</span>
<span class="nd">@user_passes_test</span><span class="p">(</span><span class="k">lambda</span> <span class="n">u</span><span class="p">:</span>
                  <span class="n">is_journalist</span><span class="p">(</span><span class="n">u</span><span class="p">)</span> <span class="ow">or</span>
                  <span class="n">is_editor</span><span class="p">(</span><span class="n">u</span><span class="p">)</span> <span class="ow">or</span>
                  <span class="n">is_publisher</span><span class="p">(</span><span class="n">u</span><span class="p">))</span>
<span class="nd">@permission_required</span><span class="p">(</span><span class="s1">&#39;news2u.view_newsletter&#39;</span><span class="p">,</span> <span class="n">raise_exception</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">view_edited_newsletter</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">newsletter_id</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; Journalist, Publisher or Editor can view newsletter details.&quot;&quot;&quot;</span>

    <span class="n">user</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">is_journalist</span><span class="p">(</span><span class="n">user</span><span class="p">):</span>
            <span class="n">journalist</span> <span class="o">=</span> <span class="n">Journalist</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">user</span><span class="o">=</span><span class="n">user</span><span class="p">)</span>
            <span class="n">newsletter</span> <span class="o">=</span> <span class="n">Newsletter</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                <span class="nb">id</span><span class="o">=</span><span class="n">newsletter_id</span><span class="p">,</span>
                <span class="n">journalist</span><span class="o">=</span><span class="n">journalist</span>
                <span class="p">)</span>
        <span class="k">elif</span> <span class="n">is_editor</span><span class="p">(</span><span class="n">user</span><span class="p">):</span>
            <span class="n">editor</span> <span class="o">=</span> <span class="n">Editor</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">user</span><span class="o">=</span><span class="n">user</span><span class="p">)</span>
            <span class="n">newsletter</span> <span class="o">=</span> <span class="n">Newsletter</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                <span class="nb">id</span><span class="o">=</span><span class="n">newsletter_id</span><span class="p">,</span>
                <span class="n">editor</span><span class="o">=</span><span class="n">editor</span>
                <span class="p">)</span>

        <span class="k">elif</span> <span class="n">is_publisher</span><span class="p">(</span><span class="n">user</span><span class="p">):</span>
            <span class="n">publisher</span> <span class="o">=</span> <span class="n">Publisher</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">user</span><span class="o">=</span><span class="n">user</span><span class="p">)</span>
            <span class="n">newsletter</span> <span class="o">=</span> <span class="n">Newsletter</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                <span class="nb">id</span><span class="o">=</span><span class="n">newsletter_id</span><span class="p">,</span>
                <span class="n">publisher</span><span class="o">=</span><span class="n">publisher</span>
                <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">messages</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s2">&quot;Access denied.&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s1">&#39;home&#39;</span><span class="p">)</span>

    <span class="k">except</span> <span class="p">(</span><span class="n">Journalist</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">,</span>
            <span class="n">Editor</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">,</span>
            <span class="n">Newsletter</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">):</span>
        <span class="n">messages</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s2">&quot;Newsletter not found.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s1">&#39;home&#39;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;news2u/view_edited_newsletter.html&#39;</span><span class="p">,</span>
                  <span class="p">{</span><span class="s1">&#39;newsletter&#39;</span><span class="p">:</span> <span class="n">newsletter</span><span class="p">,</span>
                   <span class="s1">&#39;is_journalist&#39;</span><span class="p">:</span> <span class="n">is_journalist</span><span class="p">(</span><span class="n">user</span><span class="p">),</span>
                   <span class="s1">&#39;is_editor&#39;</span><span class="p">:</span> <span class="n">is_editor</span><span class="p">(</span><span class="n">user</span><span class="p">),</span>
                   <span class="s1">&#39;is_publisher&#39;</span><span class="p">:</span> <span class="n">is_publisher</span><span class="p">(</span><span class="n">user</span><span class="p">),</span>
                   <span class="p">})</span></div>



<span class="c1"># Review |Newsletter</span>
<div class="viewcode-block" id="review_newsletter">
<a class="viewcode-back" href="../../news2u.html#news2u.views.review_newsletter">[docs]</a>
<span class="nd">@login_required</span>
<span class="nd">@user_passes_test</span><span class="p">(</span><span class="n">is_editor</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">review_newsletter</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">newsletter_id</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; Editor is the only role that can approve newsletters.</span>
<span class="sd">    Editor can:</span>
<span class="sd">    - view</span>
<span class="sd">    - update</span>
<span class="sd">    - delete</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">editor</span> <span class="o">=</span> <span class="n">Editor</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">user</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="p">)</span>
        <span class="n">newsletter</span> <span class="o">=</span> <span class="n">Newsletter</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
            <span class="nb">id</span><span class="o">=</span><span class="n">newsletter_id</span><span class="p">,</span>
            <span class="n">editor</span><span class="o">=</span><span class="n">editor</span><span class="p">,</span>
            <span class="n">status</span><span class="o">=</span><span class="s1">&#39;awaiting_editor&#39;</span><span class="p">)</span>

    <span class="k">except</span> <span class="p">(</span><span class="n">Editor</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">,</span> <span class="n">Newsletter</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">):</span>
        <span class="n">messages</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s2">&quot;Newsletter not found.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s1">&#39;view_requests&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;POST&#39;</span><span class="p">:</span>
        <span class="n">action</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;action&#39;</span><span class="p">)</span>
        <span class="n">editor_comments</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;editor_comments&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">action</span> <span class="o">==</span> <span class="s1">&#39;approve&#39;</span><span class="p">:</span>
            <span class="n">newsletter</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="s1">&#39;ready_to_publish&#39;</span>
            <span class="n">newsletter</span><span class="o">.</span><span class="n">is_approved</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">newsletter</span><span class="o">.</span><span class="n">editor</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">newsletter</span><span class="o">.</span><span class="n">editor_comments</span> <span class="o">=</span> <span class="n">editor_comments</span>
            <span class="n">newsletter</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
            <span class="n">messages</span><span class="o">.</span><span class="n">success</span><span class="p">(</span>
                <span class="n">request</span><span class="p">,</span>
                <span class="s1">&#39;Newsletter approved! &#39;</span>
                <span class="s1">&#39;Journalist can now publish.&#39;</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">action</span> <span class="o">==</span> <span class="s1">&#39;edit&#39;</span><span class="p">:</span>
            <span class="n">newsletter</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="s1">&#39;in_review&#39;</span>
            <span class="n">newsletter</span><span class="o">.</span><span class="n">editor_comments</span> <span class="o">=</span> <span class="n">editor_comments</span>
            <span class="n">newsletter</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
            <span class="n">messages</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">request</span><span class="p">,</span>
                          <span class="s1">&#39;Newsletter edited by editor.&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">action</span> <span class="o">==</span> <span class="s1">&#39;revise&#39;</span><span class="p">:</span>
            <span class="n">newsletter</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="s1">&#39;revise&#39;</span>
            <span class="n">newsletter</span><span class="o">.</span><span class="n">editor_comments</span> <span class="o">=</span> <span class="n">editor_comments</span>
            <span class="n">newsletter</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
            <span class="n">messages</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="n">request</span><span class="p">,</span>
                <span class="s1">&#39;Newsletter sent back to journalist &#39;</span>
                <span class="s1">&#39;for revisions.&#39;</span>
                <span class="p">)</span>

        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s1">&#39;view_requests&#39;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;news2u/review_newsletter.html&#39;</span><span class="p">,</span> <span class="p">{</span>
        <span class="s1">&#39;newsletter&#39;</span><span class="p">:</span> <span class="n">newsletter</span><span class="p">})</span></div>



<div class="viewcode-block" id="accept_newsletter">
<a class="viewcode-back" href="../../news2u.html#news2u.views.accept_newsletter">[docs]</a>
<span class="nd">@login_required</span>
<span class="nd">@user_passes_test</span><span class="p">(</span><span class="n">is_editor</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">accept_newsletter</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">newsletter_id</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; Editor can approve newsletters assigned to them.&quot;&quot;&quot;</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">editor</span> <span class="o">=</span> <span class="n">Editor</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">user</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="p">)</span>
        <span class="n">newsletter</span> <span class="o">=</span> <span class="n">Newsletter</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
            <span class="nb">id</span><span class="o">=</span><span class="n">newsletter_id</span><span class="p">,</span>
            <span class="n">editor</span><span class="o">=</span><span class="n">editor</span><span class="p">,</span>
            <span class="n">status</span><span class="o">=</span><span class="s1">&#39;awaiting_editor&#39;</span><span class="p">)</span>
    <span class="k">except</span> <span class="p">(</span><span class="n">Editor</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">,</span> <span class="n">Newsletter</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">):</span>
        <span class="n">messages</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s2">&quot;Newsletter not found.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s1">&#39;view_requests&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;POST&#39;</span><span class="p">:</span>
        <span class="n">action</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;action&#39;</span><span class="p">)</span>
        <span class="n">editor_comments</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;editor_comments&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">action</span> <span class="o">==</span> <span class="s1">&#39;approve&#39;</span><span class="p">:</span>
            <span class="n">newsletter</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="s1">&#39;ready_to_publish&#39;</span>
            <span class="n">newsletter</span><span class="o">.</span><span class="n">is_approved</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">newsletter</span><span class="o">.</span><span class="n">editor_comments</span> <span class="o">=</span> <span class="n">editor_comments</span>
            <span class="n">newsletter</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>

            <span class="c1"># Send email to subscribers</span>
            <span class="n">send_newsletter_email</span><span class="p">(</span><span class="n">newsletter</span><span class="p">)</span>

            <span class="n">messages</span><span class="o">.</span><span class="n">success</span><span class="p">(</span><span class="n">request</span><span class="p">,</span>
                             <span class="sa">f</span><span class="s1">&#39;Newsletter &quot;</span><span class="si">{</span><span class="n">newsletter</span><span class="o">.</span><span class="n">newsletter_title</span><span class="si">}</span><span class="s1">&quot;&#39;</span>
                             <span class="sa">f</span><span class="s1">&#39;approved!&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s1">&#39;view_requests&#39;</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">action</span> <span class="o">==</span> <span class="s1">&#39;edit&#39;</span><span class="p">:</span>
            <span class="n">newsletter</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="s1">&#39;draft&#39;</span>
            <span class="n">newsletter</span><span class="o">.</span><span class="n">editor_comments</span> <span class="o">=</span> <span class="n">editor_comments</span>
            <span class="n">newsletter</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">render</span><span class="p">(</span>
        <span class="n">request</span><span class="p">,</span>
        <span class="s1">&#39;news2u/accept_newsletter.html&#39;</span><span class="p">,</span>
        <span class="p">{</span><span class="s1">&#39;newsletter&#39;</span><span class="p">:</span> <span class="n">newsletter</span><span class="p">}</span>
        <span class="p">)</span></div>



<span class="c1"># View Accepted Newsletters</span>
<div class="viewcode-block" id="view_accepted_newsletters">
<a class="viewcode-back" href="../../news2u.html#news2u.views.view_accepted_newsletters">[docs]</a>
<span class="nd">@login_required</span>
<span class="nd">@user_passes_test</span><span class="p">(</span><span class="k">lambda</span> <span class="n">u</span><span class="p">:</span>
                  <span class="n">is_editor</span><span class="p">(</span><span class="n">u</span><span class="p">)</span> <span class="ow">or</span>
                  <span class="n">is_journalist</span><span class="p">(</span><span class="n">u</span><span class="p">)</span> <span class="ow">or</span>
                  <span class="n">is_publisher</span><span class="p">(</span><span class="n">u</span><span class="p">))</span>
<span class="nd">@permission_required</span><span class="p">(</span><span class="s1">&#39;news2u.view_article&#39;</span><span class="p">,</span> <span class="n">raise_exception</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">view_accepted_newsletters</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Show accepted articles journalist&quot;&quot;&quot;</span>

    <span class="n">user</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">is_editor</span><span class="p">(</span><span class="n">user</span><span class="p">):</span>
            <span class="n">editor</span> <span class="o">=</span> <span class="n">Editor</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">user</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="p">)</span>
            <span class="n">newsletters</span> <span class="o">=</span> <span class="n">Newsletter</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
                <span class="n">editor</span><span class="o">=</span><span class="n">editor</span><span class="p">,</span>
                <span class="n">status</span><span class="o">=</span><span class="s1">&#39;ready_to_publish&#39;</span>
            <span class="p">)</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="s1">&#39;-submitted_at&#39;</span><span class="p">)</span>

            <span class="n">accepted_newsletters</span> <span class="o">=</span> <span class="n">Newsletter</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
                <span class="n">editor</span><span class="o">=</span><span class="n">editor</span><span class="p">,</span>
                <span class="n">status</span><span class="o">=</span><span class="s1">&#39;ready_to_publish&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>

        <span class="k">elif</span> <span class="n">is_journalist</span><span class="p">(</span><span class="n">user</span><span class="p">):</span>
            <span class="n">journalist</span> <span class="o">=</span> <span class="n">Journalist</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">user</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="p">)</span>
            <span class="n">newsletters</span> <span class="o">=</span> <span class="n">Newsletter</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
                <span class="n">journalist</span><span class="o">=</span><span class="n">journalist</span><span class="p">,</span>
                <span class="n">status</span><span class="o">=</span><span class="s1">&#39;ready_to_publish&#39;</span>
            <span class="p">)</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="s1">&#39;-submitted_at&#39;</span><span class="p">)</span>

            <span class="n">accepted_newsletters</span> <span class="o">=</span> <span class="n">Newsletter</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
                <span class="n">journalist</span><span class="o">=</span><span class="n">journalist</span><span class="p">,</span>
                <span class="n">status</span><span class="o">=</span><span class="s1">&#39;ready_to_publish&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>

        <span class="k">elif</span> <span class="n">is_publisher</span><span class="p">(</span><span class="n">user</span><span class="p">):</span>
            <span class="n">publisher</span> <span class="o">=</span> <span class="n">Publisher</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">user</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="p">)</span>
            <span class="n">newsletters</span> <span class="o">=</span> <span class="n">Newsletter</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
                <span class="n">publisher</span><span class="o">=</span><span class="n">publisher</span><span class="p">,</span>
                <span class="n">status</span><span class="o">=</span><span class="s1">&#39;ready_to_publish&#39;</span>
            <span class="p">)</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="s1">&#39;-submitted_at&#39;</span><span class="p">)</span>

            <span class="n">accepted_newsletters</span> <span class="o">=</span> <span class="n">Newsletter</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
                <span class="n">publisher</span><span class="o">=</span><span class="n">publisher</span><span class="p">,</span>
                <span class="n">status</span><span class="o">=</span><span class="s1">&#39;ready_to_publish&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>

    <span class="k">except</span> <span class="p">(</span><span class="n">Editor</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">,</span> <span class="n">Journalist</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">):</span>
        <span class="n">messages</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">request</span><span class="p">,</span>
                       <span class="s2">&quot;Editor or Journalist profile not found.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s1">&#39;home&#39;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;news2u/view_accepted_newsletters.html&#39;</span><span class="p">,</span> <span class="p">{</span>
        <span class="s1">&#39;newsletters&#39;</span><span class="p">:</span> <span class="n">newsletters</span><span class="p">,</span>
        <span class="s1">&#39;accepted_newsletters&#39;</span><span class="p">:</span> <span class="n">accepted_newsletters</span><span class="p">,</span>
        <span class="s1">&#39;is_editor&#39;</span><span class="p">:</span> <span class="n">is_editor</span><span class="p">(</span><span class="n">user</span><span class="p">),</span>
        <span class="s1">&#39;is_journalist&#39;</span><span class="p">:</span> <span class="n">is_journalist</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
    <span class="p">})</span></div>



<span class="c1"># ============================================================</span>
<span class="c1"># PUBLISHER FUNCTIONS</span>
<span class="c1"># ============================================================</span>

<span class="c1"># View Article Publication Requests</span>
<div class="viewcode-block" id="view_article_publication_requests">
<a class="viewcode-back" href="../../news2u.html#news2u.views.view_article_publication_requests">[docs]</a>
<span class="nd">@login_required</span>
<span class="nd">@user_passes_test</span><span class="p">(</span><span class="n">is_publisher</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">view_article_publication_requests</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; Publisher can view article publication requests assigned to</span>
<span class="sd">    them</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">publisher</span> <span class="o">=</span> <span class="n">Publisher</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">user</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="p">)</span>
        <span class="n">articles</span> <span class="o">=</span> <span class="n">Article</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
            <span class="n">publisher</span><span class="o">=</span><span class="n">publisher</span><span class="p">,</span>
            <span class="n">status</span><span class="o">=</span><span class="s1">&#39;in_review_publisher&#39;</span>
        <span class="p">)</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="s1">&#39;-submitted_at&#39;</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">Publisher</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">:</span>
        <span class="n">messages</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s2">&quot;Publisher profile not found.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s1">&#39;my_published_articles&#39;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">render</span><span class="p">(</span>
        <span class="n">request</span><span class="p">,</span>
        <span class="s1">&#39;news2u/view_article_publication_requests.html&#39;</span><span class="p">,</span>
        <span class="p">{</span><span class="s1">&#39;articles&#39;</span><span class="p">:</span> <span class="n">articles</span><span class="p">}</span>
        <span class="p">)</span></div>



<span class="c1"># Publish Article by Publisher</span>
<div class="viewcode-block" id="publish_by_publisher">
<a class="viewcode-back" href="../../news2u.html#news2u.views.publish_by_publisher">[docs]</a>
<span class="nd">@login_required</span>
<span class="nd">@user_passes_test</span><span class="p">(</span><span class="n">is_publisher</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">publish_by_publisher</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">article_id</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; Publisher can publish articles assigned to them.&quot;&quot;&quot;</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">publisher</span> <span class="o">=</span> <span class="n">Publisher</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">user</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="p">)</span>
        <span class="n">article</span> <span class="o">=</span> <span class="n">Article</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
            <span class="nb">id</span><span class="o">=</span><span class="n">article_id</span><span class="p">,</span>
            <span class="n">publisher</span><span class="o">=</span><span class="n">publisher</span><span class="p">,</span>
            <span class="n">status</span><span class="o">=</span><span class="s1">&#39;in_review_publisher&#39;</span><span class="p">)</span>
    <span class="k">except</span> <span class="p">(</span><span class="n">Publisher</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">,</span> <span class="n">Article</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">):</span>
        <span class="n">messages</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s2">&quot;Article not found.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s1">&#39;view_article_publication_requests&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;POST&#39;</span><span class="p">:</span>
        <span class="n">article</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="s1">&#39;published_publisher&#39;</span>
        <span class="n">article</span><span class="o">.</span><span class="n">published_at</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
        <span class="n">article</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>

        <span class="c1"># Send email to subscribers</span>
        <span class="n">send_article_email</span><span class="p">(</span><span class="n">article</span><span class="p">)</span>

        <span class="c1"># Build the tweet</span>
        <span class="n">new_article_tweet</span> <span class="o">=</span> <span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;New Article Published!</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">article</span><span class="o">.</span><span class="n">article_title</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="si">{</span><span class="n">article</span><span class="o">.</span><span class="n">article_preview</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>

        <span class="c1"># Check if article has an image</span>
        <span class="n">tweet</span> <span class="o">=</span> <span class="n">Tweet</span><span class="p">()</span>
        <span class="n">tweet</span><span class="o">.</span><span class="n">make_tweet</span><span class="p">(</span>
            <span class="n">new_article_tweet</span><span class="p">,</span> <span class="n">article</span><span class="o">.</span><span class="n">article_photo</span><span class="o">.</span><span class="n">path</span>
            <span class="k">if</span> <span class="n">article</span><span class="o">.</span><span class="n">article_photo</span>
            <span class="k">else</span> <span class="kc">None</span><span class="p">)</span>

        <span class="n">messages</span><span class="o">.</span><span class="n">success</span><span class="p">(</span><span class="n">request</span><span class="p">,</span>
                         <span class="sa">f</span><span class="s1">&#39;Article &quot;</span><span class="si">{</span><span class="n">article</span><span class="o">.</span><span class="n">article_title</span><span class="si">}</span><span class="s1">&quot; published!&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s1">&#39;publish_success&#39;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">render</span><span class="p">(</span>
        <span class="n">request</span><span class="p">,</span>
        <span class="s1">&#39;news2u/publish_by_publisher.html&#39;</span><span class="p">,</span>
        <span class="p">{</span><span class="s1">&#39;article&#39;</span><span class="p">:</span> <span class="n">article</span><span class="p">}</span>
        <span class="p">)</span></div>



<span class="c1"># Publisher Create Newsletter</span>
<div class="viewcode-block" id="create_publisher_newsletter">
<a class="viewcode-back" href="../../news2u.html#news2u.views.create_publisher_newsletter">[docs]</a>
<span class="nd">@login_required</span>
<span class="nd">@user_passes_test</span><span class="p">(</span><span class="n">is_publisher</span><span class="p">)</span>
<span class="nd">@permission_required</span><span class="p">(</span><span class="s1">&#39;news2u.add_newsletter&#39;</span><span class="p">,</span> <span class="n">raise_exception</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">create_publisher_newsletter</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">publisher</span> <span class="o">=</span> <span class="n">Publisher</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">user</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">Publisher</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">:</span>
        <span class="n">messages</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s2">&quot;Publisher profile not found.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s1">&#39;home&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;POST&#39;</span><span class="p">:</span>
        <span class="n">form</span> <span class="o">=</span> <span class="n">NewsletterForm</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="p">,</span> <span class="n">publisher</span><span class="o">=</span><span class="n">publisher</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">form</span><span class="o">.</span><span class="n">is_valid</span><span class="p">():</span>
            <span class="n">newsletter</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">commit</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">newsletter</span><span class="o">.</span><span class="n">publisher</span> <span class="o">=</span> <span class="n">publisher</span>
            <span class="n">newsletter</span><span class="o">.</span><span class="n">journalist</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">newsletter</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="s1">&#39;draft&#39;</span>
            <span class="n">newsletter</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
            <span class="n">form</span><span class="o">.</span><span class="n">save_m2m</span><span class="p">()</span>

            <span class="n">messages</span><span class="o">.</span><span class="n">success</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;Newsletter created!&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s1">&#39;publisher_dashboard&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">form</span> <span class="o">=</span> <span class="n">NewsletterForm</span><span class="p">(</span><span class="n">publisher</span><span class="o">=</span><span class="n">publisher</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span>
                  <span class="s1">&#39;news2u/create_publisher_newsletter.html&#39;</span><span class="p">,</span>
                  <span class="p">{</span><span class="s1">&#39;form&#39;</span><span class="p">:</span> <span class="n">form</span><span class="p">})</span></div>



<span class="c1"># View Draft Newsletters</span>
<div class="viewcode-block" id="draft_newsletters">
<a class="viewcode-back" href="../../news2u.html#news2u.views.draft_newsletters">[docs]</a>
<span class="nd">@login_required</span>
<span class="nd">@user_passes_test</span><span class="p">(</span><span class="k">lambda</span> <span class="n">u</span><span class="p">:</span>
                  <span class="n">is_journalist</span><span class="p">(</span><span class="n">u</span><span class="p">)</span> <span class="ow">or</span>
                  <span class="n">is_editor</span><span class="p">(</span><span class="n">u</span><span class="p">)</span> <span class="ow">or</span>
                  <span class="n">is_publisher</span><span class="p">(</span><span class="n">u</span><span class="p">))</span>
<span class="k">def</span><span class="w"> </span><span class="nf">draft_newsletters</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Show draft newsletters for journalist, publisher OR editor&quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">is_journalist</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">journalist</span> <span class="o">=</span> <span class="n">Journalist</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">user</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="p">)</span>
            <span class="n">newsletters</span> <span class="o">=</span> <span class="n">Newsletter</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
                <span class="n">journalist</span><span class="o">=</span><span class="n">journalist</span><span class="p">,</span>
                <span class="n">status</span><span class="o">=</span><span class="s1">&#39;draft&#39;</span>
            <span class="p">)</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="s1">&#39;-submitted_at&#39;</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">Journalist</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">:</span>
            <span class="n">messages</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s2">&quot;Journalist profile not found.&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s1">&#39;home&#39;</span><span class="p">)</span>

    <span class="k">elif</span> <span class="n">is_editor</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">editor</span> <span class="o">=</span> <span class="n">Editor</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">user</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="p">)</span>
            <span class="c1"># Editor sees articles assigned to them that are in draft</span>
            <span class="n">newsletters</span> <span class="o">=</span> <span class="n">Newsletter</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
                <span class="n">editor</span><span class="o">=</span><span class="n">editor</span><span class="p">,</span>
                <span class="n">status</span><span class="o">=</span><span class="s1">&#39;draft&#39;</span>
            <span class="p">)</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="s1">&#39;-submitted_at&#39;</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">Editor</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">:</span>
            <span class="n">messages</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s2">&quot;Editor profile not found.&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s1">&#39;home&#39;</span><span class="p">)</span>

    <span class="k">elif</span> <span class="n">is_publisher</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">publisher</span> <span class="o">=</span> <span class="n">Publisher</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">user</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="p">)</span>
            <span class="n">newsletters</span> <span class="o">=</span> <span class="n">Newsletter</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
                <span class="n">publisher</span><span class="o">=</span><span class="n">publisher</span><span class="p">,</span>
                <span class="n">status</span><span class="o">=</span><span class="s1">&#39;draft&#39;</span>
            <span class="p">)</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="s1">&#39;-submitted_at&#39;</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">Publisher</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">:</span>
            <span class="n">messages</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s2">&quot;Publisher profile not found.&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s1">&#39;home&#39;</span><span class="p">)</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="n">messages</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s2">&quot;Access denied.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s1">&#39;home&#39;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;news2u/draft_newsletters.html&#39;</span><span class="p">,</span> <span class="p">{</span>
        <span class="s1">&#39;newsletters&#39;</span><span class="p">:</span> <span class="n">newsletters</span><span class="p">,</span>
        <span class="s1">&#39;is_journalist&#39;</span><span class="p">:</span> <span class="n">is_journalist</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="p">),</span>
        <span class="s1">&#39;is_editor&#39;</span><span class="p">:</span> <span class="n">is_editor</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="p">),</span>
        <span class="s1">&#39;is_publisher&#39;</span><span class="p">:</span> <span class="n">is_publisher</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="p">)</span>
    <span class="p">})</span></div>



<span class="c1"># View details of the Newsletter</span>
<div class="viewcode-block" id="newsletter_detail">
<a class="viewcode-back" href="../../news2u.html#news2u.views.newsletter_detail">[docs]</a>
<span class="nd">@login_required</span>
<span class="nd">@user_passes_test</span><span class="p">(</span><span class="k">lambda</span> <span class="n">u</span><span class="p">:</span>
                  <span class="n">is_journalist</span><span class="p">(</span><span class="n">u</span><span class="p">)</span> <span class="ow">or</span>
                  <span class="n">is_editor</span><span class="p">(</span><span class="n">u</span><span class="p">)</span> <span class="ow">or</span>
                  <span class="n">is_publisher</span><span class="p">(</span><span class="n">u</span><span class="p">))</span>
<span class="nd">@permission_required</span><span class="p">(</span><span class="s1">&#39;news2u.view_newsletter&#39;</span><span class="p">,</span> <span class="n">raise_exception</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">newsletter_detail</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">newsletter_id</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; View newsletter details &quot;&quot;&quot;</span>

    <span class="n">user</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">is_journalist</span><span class="p">(</span><span class="n">user</span><span class="p">):</span>
            <span class="n">journalist</span> <span class="o">=</span> <span class="n">Journalist</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">user</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="p">)</span>
            <span class="n">newsletter</span> <span class="o">=</span> <span class="n">Newsletter</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                <span class="nb">id</span><span class="o">=</span><span class="n">newsletter_id</span><span class="p">,</span>
                <span class="n">journalist</span><span class="o">=</span><span class="n">journalist</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">is_publisher</span><span class="p">(</span><span class="n">user</span><span class="p">):</span>
            <span class="n">publisher</span> <span class="o">=</span> <span class="n">Publisher</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">user</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="p">)</span>
            <span class="n">newsletter</span> <span class="o">=</span> <span class="n">Newsletter</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                <span class="nb">id</span><span class="o">=</span><span class="n">newsletter_id</span><span class="p">,</span>
                <span class="n">publisher</span><span class="o">=</span><span class="n">publisher</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">is_editor</span><span class="p">(</span><span class="n">user</span><span class="p">):</span>
            <span class="n">editor</span> <span class="o">=</span> <span class="n">Editor</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">user</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="p">)</span>
            <span class="n">newsletter</span> <span class="o">=</span> <span class="n">Newsletter</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                <span class="nb">id</span><span class="o">=</span><span class="n">newsletter_id</span><span class="p">,</span>
                <span class="n">editor</span><span class="o">=</span><span class="n">editor</span><span class="p">)</span>

    <span class="k">except</span> <span class="p">(</span><span class="n">Editor</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">,</span>
            <span class="n">Newsletter</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">,</span>
            <span class="n">Publisher</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">,</span>
            <span class="n">Journalist</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">):</span>
        <span class="n">messages</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s2">&quot;Newsletter not found.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s1">&#39;home&#39;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;news2u/newsletter_detail.html&#39;</span><span class="p">,</span>
                  <span class="p">{</span><span class="s1">&#39;newsletter&#39;</span><span class="p">:</span> <span class="n">newsletter</span><span class="p">,</span>
                   <span class="s1">&#39;is_journalist&#39;</span><span class="p">:</span> <span class="n">is_journalist</span><span class="p">(</span><span class="n">user</span><span class="p">),</span>
                   <span class="s1">&#39;is_editor&#39;</span><span class="p">:</span> <span class="n">is_editor</span><span class="p">(</span><span class="n">user</span><span class="p">),</span>
                   <span class="s1">&#39;is_publisher&#39;</span><span class="p">:</span> <span class="n">is_publisher</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
                   <span class="p">})</span></div>



<span class="c1"># Edit Newsletter by Journalist, Editor or Publisher</span>
<div class="viewcode-block" id="edit_newsletter">
<a class="viewcode-back" href="../../news2u.html#news2u.views.edit_newsletter">[docs]</a>
<span class="nd">@login_required</span>
<span class="nd">@user_passes_test</span><span class="p">(</span><span class="k">lambda</span> <span class="n">u</span><span class="p">:</span>
                  <span class="n">is_journalist</span><span class="p">(</span><span class="n">u</span><span class="p">)</span> <span class="ow">or</span>
                  <span class="n">is_editor</span><span class="p">(</span><span class="n">u</span><span class="p">)</span> <span class="ow">or</span>
                  <span class="n">is_publisher</span><span class="p">(</span><span class="n">u</span><span class="p">))</span>
<span class="nd">@permission_required</span><span class="p">(</span><span class="s1">&#39;news2u.change_newsletter&#39;</span><span class="p">,</span> <span class="n">raise_exception</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">edit_newsletter</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">newsletter_id</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; Journalists, Editors or Publishers can edit newsletters:</span>
<span class="sd">    - Journalists can edit draft newsletters</span>
<span class="sd">    - Editors can edit newsletters awaiting their review</span>
<span class="sd">    - Publishers can edit draft newsletters</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">user</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span>
    <span class="n">journalist</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">editor</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">publisher</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="c1"># Fetch the newsletter based on user role</span>
    <span class="c1"># Journalists can edit their own draft newsletters</span>
    <span class="c1"># Editors can edit newsletters assigned to them awaiting review</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">newsletter</span> <span class="o">=</span> <span class="n">Newsletter</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">newsletter_id</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">is_journalist</span><span class="p">(</span><span class="n">user</span><span class="p">):</span>
            <span class="n">journalist</span> <span class="o">=</span> <span class="n">Journalist</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">user</span><span class="o">=</span><span class="n">user</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">newsletter</span><span class="o">.</span><span class="n">journalist</span> <span class="o">!=</span> <span class="n">journalist</span><span class="p">:</span>
                <span class="n">messages</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s2">&quot;Access denied.&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s1">&#39;journalist_dashboard&#39;</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">is_publisher</span><span class="p">(</span><span class="n">user</span><span class="p">):</span>
            <span class="n">publisher</span> <span class="o">=</span> <span class="n">Publisher</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">user</span><span class="o">=</span><span class="n">user</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">newsletter</span><span class="o">.</span><span class="n">publisher</span> <span class="o">!=</span> <span class="n">publisher</span><span class="p">:</span>
                <span class="n">messages</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s2">&quot;Access denied.&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s1">&#39;publisher_dashboard&#39;</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">is_editor</span><span class="p">(</span><span class="n">user</span><span class="p">):</span>
            <span class="n">editor</span> <span class="o">=</span> <span class="n">Editor</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">user</span><span class="o">=</span><span class="n">user</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">newsletter</span><span class="o">.</span><span class="n">editor</span> <span class="o">!=</span> <span class="n">editor</span><span class="p">:</span>
                <span class="n">messages</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s2">&quot;Access denied.&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s1">&#39;editor_dashboard&#39;</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">messages</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s2">&quot;Access denied.&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s1">&#39;home&#39;</span><span class="p">)</span>

    <span class="k">except</span> <span class="p">(</span><span class="n">Journalist</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">,</span>
            <span class="n">Editor</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">,</span>
            <span class="n">Newsletter</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">):</span>
        <span class="n">messages</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s2">&quot;Newsletter not found.&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">is_journalist</span><span class="p">(</span><span class="n">user</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s1">&#39;journalist_dashboard&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">is_editor</span><span class="p">(</span><span class="n">user</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s1">&#39;view_requests&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">is_publisher</span><span class="p">(</span><span class="n">user</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s1">&#39;publisher_dashboard&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s1">&#39;home&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;POST&#39;</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">journalist</span><span class="p">:</span>
            <span class="n">form</span> <span class="o">=</span> <span class="n">NewsletterForm</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="p">,</span>
                                  <span class="n">request</span><span class="o">.</span><span class="n">FILES</span><span class="p">,</span>
                                  <span class="n">instance</span><span class="o">=</span><span class="n">newsletter</span><span class="p">,</span>
                                  <span class="n">journalist</span><span class="o">=</span><span class="n">journalist</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">publisher</span><span class="p">:</span>
            <span class="n">form</span> <span class="o">=</span> <span class="n">NewsletterForm</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="p">,</span>
                                  <span class="n">request</span><span class="o">.</span><span class="n">FILES</span><span class="p">,</span>
                                  <span class="n">instance</span><span class="o">=</span><span class="n">newsletter</span><span class="p">,</span>
                                  <span class="n">publisher</span><span class="o">=</span><span class="n">publisher</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">editor</span><span class="p">:</span>
            <span class="n">form</span> <span class="o">=</span> <span class="n">NewsletterForm</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="p">,</span>
                                  <span class="n">request</span><span class="o">.</span><span class="n">FILES</span><span class="p">,</span>
                                  <span class="n">instance</span><span class="o">=</span><span class="n">newsletter</span><span class="p">,</span>
                                  <span class="n">editor</span><span class="o">=</span><span class="n">editor</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s1">&#39;home&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">form</span><span class="o">.</span><span class="n">is_valid</span><span class="p">():</span>
            <span class="n">form</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">commit</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">form</span><span class="o">.</span><span class="n">save_m2m</span><span class="p">()</span>

            <span class="n">messages</span><span class="o">.</span><span class="n">success</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;Newsletter Updated!&#39;</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">is_journalist</span><span class="p">(</span><span class="n">user</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s1">&#39;newsletter_detail&#39;</span><span class="p">,</span>
                                <span class="n">newsletter_id</span><span class="o">=</span><span class="n">newsletter</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">is_editor</span><span class="p">(</span><span class="n">user</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s1">&#39;view_requests&#39;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">is_publisher</span><span class="p">(</span><span class="n">user</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s1">&#39;newsletter_detail&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s1">&#39;home&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">journalist</span><span class="p">:</span>
            <span class="n">form</span> <span class="o">=</span> <span class="n">NewsletterForm</span><span class="p">(</span>
                <span class="n">instance</span><span class="o">=</span><span class="n">newsletter</span><span class="p">,</span>
                <span class="n">journalist</span><span class="o">=</span><span class="n">journalist</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">publisher</span><span class="p">:</span>
            <span class="n">form</span> <span class="o">=</span> <span class="n">NewsletterForm</span><span class="p">(</span>
                <span class="n">instance</span><span class="o">=</span><span class="n">newsletter</span><span class="p">,</span>
                <span class="n">publisher</span><span class="o">=</span><span class="n">publisher</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">editor</span><span class="p">:</span>
            <span class="n">form</span> <span class="o">=</span> <span class="n">NewsletterForm</span><span class="p">(</span>
                <span class="n">instance</span><span class="o">=</span><span class="n">newsletter</span><span class="p">,</span> <span class="n">editor</span><span class="o">=</span><span class="n">editor</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s1">&#39;home&#39;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">render</span><span class="p">(</span>
        <span class="n">request</span><span class="p">,</span>
        <span class="s1">&#39;news2u/edit_newsletter.html&#39;</span><span class="p">,</span>
        <span class="p">{</span>
            <span class="s1">&#39;form&#39;</span><span class="p">:</span> <span class="n">form</span><span class="p">,</span>
            <span class="s1">&#39;newsletter&#39;</span><span class="p">:</span> <span class="n">newsletter</span><span class="p">,</span>
            <span class="s1">&#39;is_journalist&#39;</span><span class="p">:</span> <span class="n">is_journalist</span><span class="p">(</span><span class="n">user</span><span class="p">),</span>
            <span class="s1">&#39;is_editor&#39;</span><span class="p">:</span> <span class="n">is_editor</span><span class="p">(</span><span class="n">user</span><span class="p">),</span>
            <span class="s1">&#39;is_publisher&#39;</span><span class="p">:</span> <span class="n">is_publisher</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
        <span class="p">}</span>
    <span class="p">)</span></div>



<span class="c1"># Selectd published article to add to newsletter</span>
<div class="viewcode-block" id="add_article_to_newsletter">
<a class="viewcode-back" href="../../news2u.html#news2u.views.add_article_to_newsletter">[docs]</a>
<span class="nd">@login_required</span>
<span class="nd">@user_passes_test</span><span class="p">(</span><span class="k">lambda</span> <span class="n">u</span><span class="p">:</span> <span class="n">is_journalist</span><span class="p">(</span><span class="n">u</span><span class="p">)</span> <span class="ow">or</span> <span class="n">is_publisher</span><span class="p">(</span><span class="n">u</span><span class="p">))</span>
<span class="k">def</span><span class="w"> </span><span class="nf">add_article_to_newsletter</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">article_id</span><span class="p">,</span> <span class="n">newsletter_id</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Add an article to a newsletter&quot;&quot;&quot;</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">journalist</span> <span class="o">=</span> <span class="n">Journalist</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">user</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="p">)</span>
        <span class="n">article</span> <span class="o">=</span> <span class="n">Article</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
            <span class="nb">id</span><span class="o">=</span><span class="n">article_id</span><span class="p">,</span>
            <span class="n">journalist</span><span class="o">=</span><span class="n">journalist</span><span class="p">,</span>
            <span class="n">status__in</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;published_independent&#39;</span><span class="p">,</span> <span class="s1">&#39;published_publisher&#39;</span><span class="p">]</span>
        <span class="p">)</span>

        <span class="n">publisher</span> <span class="o">=</span> <span class="n">Publisher</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">user</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="p">)</span>
        <span class="n">article</span> <span class="o">=</span> <span class="n">Article</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
            <span class="nb">id</span><span class="o">=</span><span class="n">article_id</span><span class="p">,</span>
            <span class="n">publisher</span><span class="o">=</span><span class="n">publisher</span><span class="p">,</span>
            <span class="n">status__in</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;published_independent&#39;</span><span class="p">,</span> <span class="s1">&#39;published_publisher&#39;</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="n">newsletter</span> <span class="o">=</span> <span class="n">Newsletter</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
            <span class="nb">id</span><span class="o">=</span><span class="n">newsletter_id</span><span class="p">,</span>
            <span class="n">journalist</span><span class="o">=</span><span class="n">journalist</span><span class="p">,</span>
            <span class="n">status</span><span class="o">=</span><span class="s1">&#39;draft&#39;</span>  <span class="c1"># Can only add to draft newsletters</span>
        <span class="p">)</span>

        <span class="c1"># Add article to newsletter</span>
        <span class="n">newsletter</span><span class="o">.</span><span class="n">articles</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">article</span><span class="p">)</span>

        <span class="n">messages</span><span class="o">.</span><span class="n">success</span><span class="p">(</span>
            <span class="n">request</span><span class="p">,</span>
            <span class="sa">f</span><span class="s1">&#39;Article &quot;</span><span class="si">{</span><span class="n">article</span><span class="o">.</span><span class="n">article_title</span><span class="si">}</span><span class="s1">&quot; &#39;</span>
            <span class="s1">&#39;added to newsletter!&#39;</span><span class="p">)</span>

    <span class="k">except</span> <span class="p">(</span><span class="n">Journalist</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">,</span>
            <span class="n">Article</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">,</span>
            <span class="n">Newsletter</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">):</span>
        <span class="n">messages</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s2">&quot;Article or newsletter not found.&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s1">&#39;draft_newsletters&#39;</span><span class="p">,</span> <span class="n">newsletter_id</span><span class="o">=</span><span class="n">newsletter_id</span><span class="p">)</span></div>



<span class="c1"># View Submitted Newsletters to Editor</span>
<div class="viewcode-block" id="view_submitted_newsletters">
<a class="viewcode-back" href="../../news2u.html#news2u.views.view_submitted_newsletters">[docs]</a>
<span class="nd">@login_required</span>
<span class="nd">@user_passes_test</span><span class="p">(</span><span class="n">is_journalist</span><span class="p">)</span>
<span class="nd">@permission_required</span><span class="p">(</span><span class="s1">&#39;news2u.view_newsletter&#39;</span><span class="p">,</span> <span class="n">raise_exception</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">view_submitted_newsletters</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Show submitted newsletters for journalist&quot;&quot;&quot;</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">journalist</span> <span class="o">=</span> <span class="n">Journalist</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">user</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="p">)</span>
        <span class="n">newsletters</span> <span class="o">=</span> <span class="n">Newsletter</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
            <span class="n">journalist</span><span class="o">=</span><span class="n">journalist</span><span class="p">,</span>
            <span class="n">status</span><span class="o">=</span><span class="s1">&#39;awaiting_editor&#39;</span>
        <span class="p">)</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="s1">&#39;-submitted_at&#39;</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">Journalist</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">:</span>
        <span class="n">messages</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s2">&quot;Journalist profile not found.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s1">&#39;home&#39;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;news2u/view_submitted_newsletter.html&#39;</span><span class="p">,</span> <span class="p">{</span>
        <span class="s1">&#39;newsletters&#39;</span><span class="p">:</span> <span class="n">newsletters</span>
    <span class="p">})</span></div>



<span class="c1"># ============================================================</span>
<span class="c1"># SUBSCRIPTION FUNCTIONS</span>
<span class="c1"># ============================================================</span>

<span class="c1"># Manage Subscriptions</span>
<div class="viewcode-block" id="manage_subscriptions">
<a class="viewcode-back" href="../../news2u.html#news2u.views.manage_subscriptions">[docs]</a>
<span class="nd">@login_required</span>
<span class="nd">@user_passes_test</span><span class="p">(</span><span class="n">is_reader</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">manage_subscriptions</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="n">reader</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">customuser</span>

    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;POST&#39;</span><span class="p">:</span>
        <span class="n">form</span> <span class="o">=</span> <span class="n">SubscriptionForm</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">form</span><span class="o">.</span><span class="n">is_valid</span><span class="p">():</span>
            <span class="n">action</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;action&#39;</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">action</span> <span class="o">==</span> <span class="s1">&#39;subscribe&#39;</span><span class="p">:</span>
                <span class="c1"># ADD to existing subscriptions (don&#39;t clear the form)</span>
                <span class="k">for</span> <span class="n">journalist</span> <span class="ow">in</span> <span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s1">&#39;journalists&#39;</span><span class="p">]:</span>
                    <span class="n">reader</span><span class="o">.</span><span class="n">subscribed_journalists</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">journalist</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">publisher</span> <span class="ow">in</span> <span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s1">&#39;publishers&#39;</span><span class="p">]:</span>
                    <span class="n">reader</span><span class="o">.</span><span class="n">subscribed_publishers</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">publisher</span><span class="p">)</span>

                <span class="n">messages</span><span class="o">.</span><span class="n">success</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;New subscriptions added!&#39;</span><span class="p">)</span>

            <span class="k">elif</span> <span class="n">action</span> <span class="o">==</span> <span class="s1">&#39;update&#39;</span><span class="p">:</span>
                <span class="c1"># Replace all subscriptions with selected ones</span>
                <span class="n">reader</span><span class="o">.</span><span class="n">subscribed_journalists</span><span class="o">.</span><span class="n">set</span><span class="p">(</span>
                    <span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s1">&#39;journalists&#39;</span><span class="p">])</span>
                <span class="n">reader</span><span class="o">.</span><span class="n">subscribed_publishers</span><span class="o">.</span><span class="n">set</span><span class="p">(</span>
                    <span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s1">&#39;publishers&#39;</span><span class="p">])</span>

                <span class="n">messages</span><span class="o">.</span><span class="n">success</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;Subscriptions updated!&#39;</span><span class="p">)</span>

            <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s1">&#39;manage_subscriptions&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">form</span> <span class="o">=</span> <span class="n">SubscriptionForm</span><span class="p">(</span><span class="n">initial</span><span class="o">=</span><span class="p">{</span>
            <span class="s1">&#39;journalists&#39;</span><span class="p">:</span>
            <span class="n">reader</span><span class="o">.</span><span class="n">subscribed_journalists</span><span class="o">.</span><span class="n">all</span><span class="p">()</span><span class="o">.</span><span class="n">values_list</span><span class="p">(</span>
                <span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="n">flat</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
            <span class="s1">&#39;publishers&#39;</span><span class="p">:</span>
            <span class="n">reader</span><span class="o">.</span><span class="n">subscribed_publishers</span><span class="o">.</span><span class="n">all</span><span class="p">()</span><span class="o">.</span><span class="n">values_list</span><span class="p">(</span>
                <span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="n">flat</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
        <span class="p">})</span>

    <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;news2u/manage_subscriptions.html&#39;</span><span class="p">,</span> <span class="p">{</span>
        <span class="s1">&#39;form&#39;</span><span class="p">:</span> <span class="n">form</span><span class="p">,</span>
        <span class="s1">&#39;subscribed_publishers&#39;</span><span class="p">:</span> <span class="n">reader</span><span class="o">.</span><span class="n">subscribed_publishers</span><span class="o">.</span><span class="n">all</span><span class="p">(),</span>
        <span class="s1">&#39;subscribed_journalists&#39;</span><span class="p">:</span> <span class="n">reader</span><span class="o">.</span><span class="n">subscribed_journalists</span><span class="o">.</span><span class="n">all</span><span class="p">(),</span>
    <span class="p">})</span></div>



<span class="c1"># ============================================================</span>
<span class="c1"># VIEW ASSOCIATED USERS</span>
<span class="c1"># ============================================================</span>

<span class="c1"># View All Editors</span>
<div class="viewcode-block" id="view_all_editors">
<a class="viewcode-back" href="../../news2u.html#news2u.views.view_all_editors">[docs]</a>
<span class="nd">@login_required</span>
<span class="nd">@user_passes_test</span><span class="p">(</span><span class="k">lambda</span> <span class="n">u</span><span class="p">:</span> <span class="n">is_journalist</span><span class="p">(</span><span class="n">u</span><span class="p">)</span> <span class="ow">or</span> <span class="n">is_publisher</span><span class="p">(</span><span class="n">u</span><span class="p">))</span>
<span class="k">def</span><span class="w"> </span><span class="nf">view_all_editors</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; View all Editors &quot;&quot;&quot;</span>

    <span class="n">editors</span> <span class="o">=</span> <span class="n">Editor</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>  <span class="c1"># Get ALL editors, not just yours!</span>

    <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;news2u/view_all_editors.html&#39;</span><span class="p">,</span> <span class="p">{</span>
        <span class="s1">&#39;editors&#39;</span><span class="p">:</span> <span class="n">editors</span><span class="p">,</span>
    <span class="p">})</span></div>



<span class="c1"># View Associated Editors</span>
<div class="viewcode-block" id="view_my_editors">
<a class="viewcode-back" href="../../news2u.html#news2u.views.view_my_editors">[docs]</a>
<span class="nd">@login_required</span>
<span class="nd">@user_passes_test</span><span class="p">(</span><span class="k">lambda</span> <span class="n">u</span><span class="p">:</span> <span class="n">is_journalist</span><span class="p">(</span><span class="n">u</span><span class="p">)</span> <span class="ow">or</span> <span class="n">is_publisher</span><span class="p">(</span><span class="n">u</span><span class="p">))</span>
<span class="k">def</span><span class="w"> </span><span class="nf">view_my_editors</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; View Editors associated with Journalist or Publisher &quot;&quot;&quot;</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">is_journalist</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="p">):</span>
            <span class="n">journalist</span> <span class="o">=</span> <span class="n">Journalist</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">user</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="p">)</span>
            <span class="n">editors</span> <span class="o">=</span> <span class="n">Editor</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
                <span class="n">article_by_editor__journalist</span><span class="o">=</span><span class="n">journalist</span>
            <span class="p">)</span><span class="o">.</span><span class="n">distinct</span><span class="p">()</span>

        <span class="k">elif</span> <span class="n">is_publisher</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="p">):</span>
            <span class="n">publisher</span> <span class="o">=</span> <span class="n">Publisher</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">user</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="p">)</span>
            <span class="n">editor_ids</span> <span class="o">=</span> <span class="n">Article</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
             <span class="n">publisher</span><span class="o">=</span><span class="n">publisher</span>
            <span class="p">)</span><span class="o">.</span><span class="n">values_list</span><span class="p">(</span><span class="s1">&#39;editor_id&#39;</span><span class="p">,</span> <span class="n">flat</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">distinct</span><span class="p">()</span>

            <span class="n">editors</span> <span class="o">=</span> <span class="n">Editor</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
                <span class="n">id__in</span><span class="o">=</span><span class="n">editor_ids</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">messages</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s2">&quot;Access denied.&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s1">&#39;home&#39;</span><span class="p">)</span>
    <span class="k">except</span> <span class="p">(</span><span class="n">Journalist</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">,</span> <span class="n">Publisher</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">):</span>
        <span class="n">messages</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s2">&quot;Profile not found.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s1">&#39;home&#39;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;news2u/view_my_editors.html&#39;</span><span class="p">,</span> <span class="p">{</span>
        <span class="s1">&#39;editors&#39;</span><span class="p">:</span> <span class="n">editors</span><span class="p">,</span>
        <span class="s1">&#39;is_journalist&#39;</span><span class="p">:</span> <span class="n">is_journalist</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="p">),</span>
        <span class="s1">&#39;is_publisher&#39;</span><span class="p">:</span> <span class="n">is_publisher</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="p">),</span>
    <span class="p">})</span></div>



<span class="c1"># View All Journalists</span>
<div class="viewcode-block" id="view_all_journalists">
<a class="viewcode-back" href="../../news2u.html#news2u.views.view_all_journalists">[docs]</a>
<span class="nd">@login_required</span>
<span class="nd">@user_passes_test</span><span class="p">(</span><span class="k">lambda</span> <span class="n">u</span><span class="p">:</span> <span class="n">is_editor</span><span class="p">(</span><span class="n">u</span><span class="p">)</span> <span class="ow">or</span> <span class="n">is_publisher</span><span class="p">(</span><span class="n">u</span><span class="p">))</span>
<span class="k">def</span><span class="w"> </span><span class="nf">view_all_journalists</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; View all Journalists&quot;&quot;&quot;</span>

    <span class="n">journalists</span> <span class="o">=</span> <span class="n">Journalist</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>  <span class="c1"># Get all journalists</span>

    <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;news2u/view_all_journalists.html&#39;</span><span class="p">,</span> <span class="p">{</span>
        <span class="s1">&#39;journalists&#39;</span><span class="p">:</span> <span class="n">journalists</span><span class="p">,</span>
    <span class="p">})</span></div>



<span class="c1"># View Journalists associated with Editor</span>
<div class="viewcode-block" id="view_my_journalists">
<a class="viewcode-back" href="../../news2u.html#news2u.views.view_my_journalists">[docs]</a>
<span class="nd">@login_required</span>
<span class="nd">@user_passes_test</span><span class="p">(</span><span class="k">lambda</span> <span class="n">u</span><span class="p">:</span> <span class="n">is_editor</span><span class="p">(</span><span class="n">u</span><span class="p">)</span> <span class="ow">or</span> <span class="n">is_publisher</span><span class="p">(</span><span class="n">u</span><span class="p">))</span>
<span class="k">def</span><span class="w"> </span><span class="nf">view_my_journalists</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; View Journalists associated with Editor or Publisher &quot;&quot;&quot;</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">is_editor</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="p">):</span>
            <span class="n">editor</span> <span class="o">=</span> <span class="n">Editor</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">user</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="p">)</span>
            <span class="n">journalist_ids</span> <span class="o">=</span> <span class="n">Article</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
             <span class="n">editor</span><span class="o">=</span><span class="n">editor</span>
            <span class="p">)</span><span class="o">.</span><span class="n">values_list</span><span class="p">(</span><span class="s1">&#39;journalist_id&#39;</span><span class="p">,</span> <span class="n">flat</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">distinct</span><span class="p">()</span>

            <span class="n">journalists</span> <span class="o">=</span> <span class="n">Journalist</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
                <span class="n">id__in</span><span class="o">=</span><span class="n">journalist_ids</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">is_publisher</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="p">):</span>
            <span class="n">publisher</span> <span class="o">=</span> <span class="n">Publisher</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">user</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="p">)</span>

            <span class="c1"># Get journalists who have published with this publisher</span>
            <span class="n">journalists</span> <span class="o">=</span> <span class="n">Journalist</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
                <span class="n">article_by_journalist__publisher</span><span class="o">=</span><span class="n">publisher</span><span class="p">,</span>
                <span class="n">article_by_journalist__status</span><span class="o">=</span><span class="s1">&#39;published_publisher&#39;</span>
            <span class="p">)</span><span class="o">.</span><span class="n">distinct</span><span class="p">()</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">messages</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s2">&quot;Access denied.&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s1">&#39;home&#39;</span><span class="p">)</span>
    <span class="k">except</span> <span class="p">(</span><span class="n">Editor</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">,</span> <span class="n">Publisher</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">):</span>
        <span class="n">messages</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s2">&quot;Profile not found.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s1">&#39;home&#39;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;news2u/view_my_journalists.html&#39;</span><span class="p">,</span> <span class="p">{</span>
        <span class="s1">&#39;journalists&#39;</span><span class="p">:</span> <span class="n">journalists</span><span class="p">,</span>
        <span class="s1">&#39;is_editor&#39;</span><span class="p">:</span> <span class="n">is_editor</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="p">),</span>
        <span class="s1">&#39;is_publisher&#39;</span><span class="p">:</span> <span class="n">is_publisher</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="p">),</span>
    <span class="p">})</span></div>



<span class="c1"># View all Publishers</span>
<div class="viewcode-block" id="view_all_publishers">
<a class="viewcode-back" href="../../news2u.html#news2u.views.view_all_publishers">[docs]</a>
<span class="nd">@login_required</span>
<span class="nd">@user_passes_test</span><span class="p">(</span><span class="k">lambda</span> <span class="n">u</span><span class="p">:</span> <span class="n">is_journalist</span><span class="p">(</span><span class="n">u</span><span class="p">)</span> <span class="ow">or</span> <span class="n">is_editor</span><span class="p">(</span><span class="n">u</span><span class="p">))</span>
<span class="k">def</span><span class="w"> </span><span class="nf">view_all_publishers</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; View all Publishers &quot;&quot;&quot;</span>

    <span class="n">publishers</span> <span class="o">=</span> <span class="n">Publisher</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>  <span class="c1"># Get ALL publishers, not just yours!</span>

    <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;news2u/view_all_publishers.html&#39;</span><span class="p">,</span> <span class="p">{</span>
        <span class="s1">&#39;publishers&#39;</span><span class="p">:</span> <span class="n">publishers</span><span class="p">,</span>
    <span class="p">})</span></div>



<span class="c1"># View Associated Publishers</span>
<div class="viewcode-block" id="view_my_publishers">
<a class="viewcode-back" href="../../news2u.html#news2u.views.view_my_publishers">[docs]</a>
<span class="nd">@login_required</span>
<span class="nd">@user_passes_test</span><span class="p">(</span><span class="k">lambda</span> <span class="n">u</span><span class="p">:</span> <span class="n">is_journalist</span><span class="p">(</span><span class="n">u</span><span class="p">)</span> <span class="ow">or</span> <span class="n">is_editor</span><span class="p">(</span><span class="n">u</span><span class="p">))</span>
<span class="k">def</span><span class="w"> </span><span class="nf">view_my_publishers</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; View Publishers associated with Journalist or Editor &quot;&quot;&quot;</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">is_journalist</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="p">):</span>
            <span class="n">journalist</span> <span class="o">=</span> <span class="n">Journalist</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">user</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="p">)</span>

            <span class="n">publisher_ids</span> <span class="o">=</span> <span class="n">Article</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
                <span class="n">journalist</span><span class="o">=</span><span class="n">journalist</span><span class="p">,</span>
                <span class="n">status</span><span class="o">=</span><span class="s1">&#39;published_publisher&#39;</span><span class="p">,</span>
                <span class="n">publisher__isnull</span><span class="o">=</span><span class="kc">False</span>
            <span class="p">)</span><span class="o">.</span><span class="n">values_list</span><span class="p">(</span><span class="s1">&#39;publisher_id&#39;</span><span class="p">,</span> <span class="n">flat</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">distinct</span><span class="p">()</span>

            <span class="n">publishers</span> <span class="o">=</span> <span class="n">Publisher</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">id__in</span><span class="o">=</span><span class="n">publisher_ids</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">is_editor</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="p">):</span>
            <span class="n">editor</span> <span class="o">=</span> <span class="n">Editor</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">user</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="p">)</span>
            <span class="n">publisher_ids</span> <span class="o">=</span> <span class="n">Article</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
             <span class="n">editor</span><span class="o">=</span><span class="n">editor</span>
            <span class="p">)</span><span class="o">.</span><span class="n">values_list</span><span class="p">(</span><span class="s1">&#39;publisher_id&#39;</span><span class="p">,</span> <span class="n">flat</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">distinct</span><span class="p">()</span>

            <span class="n">publishers</span> <span class="o">=</span> <span class="n">Publisher</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
                <span class="n">id__in</span><span class="o">=</span><span class="n">publisher_ids</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">messages</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s2">&quot;Access denied.&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s1">&#39;home&#39;</span><span class="p">)</span>
    <span class="k">except</span> <span class="p">(</span><span class="n">Journalist</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">,</span> <span class="n">Editor</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">):</span>
        <span class="n">messages</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s2">&quot;Profile not found.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s1">&#39;home&#39;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;news2u/view_my_publishers.html&#39;</span><span class="p">,</span> <span class="p">{</span>
        <span class="s1">&#39;publishers&#39;</span><span class="p">:</span> <span class="n">publishers</span><span class="p">,</span>
        <span class="s1">&#39;is_journalist&#39;</span><span class="p">:</span> <span class="n">is_journalist</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="p">),</span>
        <span class="s1">&#39;is_editor&#39;</span><span class="p">:</span> <span class="n">is_editor</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="p">),</span>
    <span class="p">})</span></div>



<span class="c1"># View Article Requests</span>
<div class="viewcode-block" id="view_requests">
<a class="viewcode-back" href="../../news2u.html#news2u.views.view_requests">[docs]</a>
<span class="nd">@login_required</span>
<span class="nd">@user_passes_test</span><span class="p">(</span><span class="n">is_editor</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">view_requests</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; Editor can view article and newsletter requests assigned</span>
<span class="sd">    to them.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">editor</span> <span class="o">=</span> <span class="n">Editor</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">user</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="p">)</span>
        <span class="n">articles</span> <span class="o">=</span> <span class="n">Article</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
            <span class="n">editor</span><span class="o">=</span><span class="n">editor</span><span class="p">,</span>
            <span class="n">status</span><span class="o">=</span><span class="s1">&#39;awaiting_editor&#39;</span>
        <span class="p">)</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="s1">&#39;-submitted_at&#39;</span><span class="p">)</span>

        <span class="n">newsletters</span> <span class="o">=</span> <span class="n">Newsletter</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
            <span class="n">editor</span><span class="o">=</span><span class="n">editor</span><span class="p">,</span>
            <span class="n">status</span><span class="o">=</span><span class="s1">&#39;awaiting_editor&#39;</span>
        <span class="p">)</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="s1">&#39;-submitted_at&#39;</span><span class="p">)</span>

    <span class="k">except</span> <span class="n">Editor</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">:</span>
        <span class="n">messages</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s2">&quot;Editor profile not found.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s1">&#39;editor_dashboard&#39;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;news2u/view_requests.html&#39;</span><span class="p">,</span> <span class="p">{</span>
        <span class="s1">&#39;articles&#39;</span><span class="p">:</span> <span class="n">articles</span><span class="p">,</span>
        <span class="s1">&#39;newsletters&#39;</span><span class="p">:</span> <span class="n">newsletters</span><span class="p">,</span>
    <span class="p">})</span></div>



<span class="c1"># View Subscriber Newsletters</span>
<div class="viewcode-block" id="view_subscriber_newsletters">
<a class="viewcode-back" href="../../news2u.html#news2u.views.view_subscriber_newsletters">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">view_subscriber_newsletters</span><span class="p">():</span>
    <span class="k">pass</span></div>



<span class="c1"># ============================================================</span>
<span class="c1"># API FUNCTIONS</span>
<span class="c1"># ============================================================</span>

<span class="c1"># Login</span>
<div class="viewcode-block" id="api_user_login">
<a class="viewcode-back" href="../../news2u.html#news2u.views.api_user_login">[docs]</a>
<span class="nd">@api_view</span><span class="p">([</span><span class="s1">&#39;POST&#39;</span><span class="p">])</span>
<span class="nd">@permission_classes</span><span class="p">([</span><span class="n">IsAuthenticated</span><span class="p">])</span>
<span class="k">def</span><span class="w"> </span><span class="nf">api_user_login</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; API endpoint for user login &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;POST&#39;</span><span class="p">:</span>
        <span class="n">form</span> <span class="o">=</span> <span class="n">AuthenticationForm</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">form</span><span class="o">.</span><span class="n">is_valid</span><span class="p">():</span>
            <span class="n">username</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="p">[</span><span class="s1">&#39;username&#39;</span><span class="p">]</span>
            <span class="n">password</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="p">[</span><span class="s1">&#39;password&#39;</span><span class="p">]</span>
            <span class="n">user</span> <span class="o">=</span> <span class="n">authenticate</span><span class="p">(</span><span class="n">request</span><span class="p">,</span>
                                <span class="n">username</span><span class="o">=</span><span class="n">username</span><span class="p">,</span>
                                <span class="n">password</span><span class="o">=</span><span class="n">password</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">user</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">login</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">user</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">is_publisher</span><span class="p">(</span><span class="n">user</span><span class="p">):</span>
                    <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s1">&#39;publisher_dashboard&#39;</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">is_editor</span><span class="p">(</span><span class="n">user</span><span class="p">):</span>
                    <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s1">&#39;editor_dashboard&#39;</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">is_journalist</span><span class="p">(</span><span class="n">user</span><span class="p">):</span>
                    <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s1">&#39;journalist_dashboard&#39;</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">is_reader</span><span class="p">(</span><span class="n">user</span><span class="p">):</span>
                    <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s1">&#39;reader_dashboard&#39;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s1">&#39;home&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">form</span> <span class="o">=</span> <span class="n">AuthenticationForm</span><span class="p">()</span>

    <span class="n">serializer</span> <span class="o">=</span> <span class="n">LoginFormSerializer</span><span class="p">(</span><span class="n">form</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">JsonResponse</span><span class="p">(</span><span class="n">serializer</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">safe</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></div>



<span class="c1"># Logout</span>
<div class="viewcode-block" id="api_user_logout">
<a class="viewcode-back" href="../../news2u.html#news2u.views.api_user_logout">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">api_user_logout</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">is_authenticated</span><span class="p">:</span>
        <span class="c1"># Clear pending messages</span>
        <span class="n">storage</span> <span class="o">=</span> <span class="n">messages</span><span class="o">.</span><span class="n">get_messages</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
        <span class="n">storage</span><span class="o">.</span><span class="n">used</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="n">logout</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
        <span class="n">messages</span><span class="o">.</span><span class="n">success</span><span class="p">(</span><span class="n">request</span><span class="p">,</span>
                         <span class="s1">&#39;You have been logged out successfully.&#39;</span><span class="p">)</span>

    <span class="n">serializer</span> <span class="o">=</span> <span class="n">LoginFormSerializer</span><span class="p">({})</span>
    <span class="k">return</span> <span class="n">JsonResponse</span><span class="p">(</span><span class="n">serializer</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">safe</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></div>



<span class="c1"># Manage Subscriptions</span>
<div class="viewcode-block" id="api_manage_subscriptions">
<a class="viewcode-back" href="../../news2u.html#news2u.views.api_manage_subscriptions">[docs]</a>
<span class="nd">@api_view</span><span class="p">([</span><span class="s1">&#39;GET&#39;</span><span class="p">,</span> <span class="s1">&#39;POST&#39;</span><span class="p">])</span>
<span class="nd">@permission_classes</span><span class="p">([</span><span class="n">IsAuthenticated</span><span class="p">])</span>
<span class="k">def</span><span class="w"> </span><span class="nf">api_manage_subscriptions</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    GET: Get current subscriptions</span>
<span class="sd">    POST: Update subscriptions</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">custom_user</span> <span class="o">=</span> <span class="n">CustomUser</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">user</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">CustomUser</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">Response</span><span class="p">(</span>
            <span class="p">{</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;User profile not found&#39;</span><span class="p">},</span>
            <span class="n">status</span><span class="o">=</span><span class="mi">404</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">custom_user</span><span class="o">.</span><span class="n">role</span> <span class="o">!=</span> <span class="s1">&#39;reader&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">Response</span><span class="p">({</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;Only readers can manage &#39;</span>
                        <span class="s1">&#39;subscriptions&#39;</span><span class="p">},</span> <span class="n">status</span><span class="o">=</span><span class="mi">403</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;GET&#39;</span><span class="p">:</span>
        <span class="c1"># Return current subscriptions</span>
        <span class="n">data</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;subscribed_journalists&#39;</span><span class="p">:</span> <span class="n">JournalistSerializer</span><span class="p">(</span>
                <span class="n">custom_user</span><span class="o">.</span><span class="n">subscribed_journalists</span><span class="o">.</span><span class="n">all</span><span class="p">(),</span>
                <span class="n">many</span><span class="o">=</span><span class="kc">True</span>
            <span class="p">)</span><span class="o">.</span><span class="n">data</span><span class="p">,</span>
            <span class="s1">&#39;subscribed_publishers&#39;</span><span class="p">:</span> <span class="n">PublisherSerializer</span><span class="p">(</span>
                <span class="n">custom_user</span><span class="o">.</span><span class="n">subscribed_publishers</span><span class="o">.</span><span class="n">all</span><span class="p">(),</span>
                <span class="n">many</span><span class="o">=</span><span class="kc">True</span>
            <span class="p">)</span><span class="o">.</span><span class="n">data</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

    <span class="k">elif</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;POST&#39;</span><span class="p">:</span>
        <span class="n">action</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;action&#39;</span><span class="p">)</span>
        <span class="n">journalist_ids</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;journalists&#39;</span><span class="p">,</span> <span class="p">[])</span>
        <span class="n">publisher_ids</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;publishers&#39;</span><span class="p">,</span> <span class="p">[])</span>

        <span class="k">if</span> <span class="n">action</span> <span class="o">==</span> <span class="s1">&#39;subscribe&#39;</span><span class="p">:</span>
            <span class="c1"># ADD to existing subscriptions</span>
            <span class="k">for</span> <span class="n">journalist_id</span> <span class="ow">in</span> <span class="n">journalist_ids</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">journalist</span> <span class="o">=</span> <span class="n">Journalist</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">journalist_id</span><span class="p">)</span>
                    <span class="n">custom_user</span><span class="o">.</span><span class="n">subscribed_journalists</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">journalist</span><span class="p">)</span>
                <span class="k">except</span> <span class="n">Journalist</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">:</span>
                    <span class="k">pass</span>

            <span class="k">for</span> <span class="n">publisher_id</span> <span class="ow">in</span> <span class="n">publisher_ids</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">publisher</span> <span class="o">=</span> <span class="n">Publisher</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">publisher_id</span><span class="p">)</span>
                    <span class="n">custom_user</span><span class="o">.</span><span class="n">subscribed_publishers</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">publisher</span><span class="p">)</span>
                <span class="k">except</span> <span class="n">Publisher</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">:</span>
                    <span class="k">pass</span>

            <span class="k">return</span> <span class="n">Response</span><span class="p">({</span><span class="s1">&#39;message&#39;</span><span class="p">:</span> <span class="s1">&#39;Subscriptions added!&#39;</span><span class="p">},</span> <span class="n">status</span><span class="o">=</span><span class="mi">200</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">action</span> <span class="o">==</span> <span class="s1">&#39;update&#39;</span><span class="p">:</span>
            <span class="c1"># REPLACE all subscriptions</span>
            <span class="n">journalists</span> <span class="o">=</span> <span class="n">Journalist</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">id__in</span><span class="o">=</span><span class="n">journalist_ids</span><span class="p">)</span>
            <span class="n">publishers</span> <span class="o">=</span> <span class="n">Publisher</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">id__in</span><span class="o">=</span><span class="n">publisher_ids</span><span class="p">)</span>

            <span class="n">custom_user</span><span class="o">.</span><span class="n">subscribed_journalists</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">journalists</span><span class="p">)</span>
            <span class="n">custom_user</span><span class="o">.</span><span class="n">subscribed_publishers</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">publishers</span><span class="p">)</span>

            <span class="k">return</span> <span class="n">Response</span><span class="p">(</span>
                <span class="p">{</span><span class="s1">&#39;message&#39;</span><span class="p">:</span> <span class="s1">&#39;Subscriptions updated!&#39;</span><span class="p">},</span>
                <span class="n">status</span><span class="o">=</span><span class="mi">200</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">Response</span><span class="p">(</span>
                <span class="p">{</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;Invalid action. Use &quot;subscribe&quot; or &quot;update&quot;&#39;</span><span class="p">},</span>
                <span class="n">status</span><span class="o">=</span><span class="mi">400</span><span class="p">)</span></div>



<span class="c1"># Reader can retrieve published articles from subscribed journalists</span>
<span class="c1"># and publishers</span>
<div class="viewcode-block" id="api_my_published_articles">
<a class="viewcode-back" href="../../news2u.html#news2u.views.api_my_published_articles">[docs]</a>
<span class="nd">@api_view</span><span class="p">([</span><span class="s1">&#39;GET&#39;</span><span class="p">])</span>
<span class="nd">@permission_classes</span><span class="p">([</span><span class="n">IsAuthenticated</span><span class="p">])</span>
<span class="k">def</span><span class="w"> </span><span class="nf">api_my_published_articles</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; API endpoint to get published articles for the a subscriber &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">is_reader</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">JsonResponse</span><span class="p">(</span>
            <span class="p">{</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;Access denied.&#39;</span><span class="p">},</span>
            <span class="n">status</span><span class="o">=</span><span class="mi">403</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;GET&quot;</span><span class="p">:</span>
        <span class="c1"># Get the CustomUser for this reader</span>
        <span class="n">custom_user</span> <span class="o">=</span> <span class="n">CustomUser</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">user</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="p">)</span>

        <span class="c1"># Get articles from subscribed journalists</span>
        <span class="c1"># OR subscribed publishers</span>
        <span class="n">articles</span> <span class="o">=</span> <span class="n">Article</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
            <span class="n">journalist__in</span><span class="o">=</span><span class="n">custom_user</span><span class="o">.</span><span class="n">subscribed_journalists</span><span class="o">.</span><span class="n">all</span><span class="p">(),</span>
            <span class="n">status__in</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;published_independent&#39;</span><span class="p">,</span> <span class="s1">&#39;published_publisher&#39;</span><span class="p">]</span>
        <span class="p">)</span> <span class="o">|</span> <span class="n">Article</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
            <span class="n">publisher__in</span><span class="o">=</span><span class="n">custom_user</span><span class="o">.</span><span class="n">subscribed_publishers</span><span class="o">.</span><span class="n">all</span><span class="p">(),</span>
            <span class="n">status</span><span class="o">=</span><span class="s1">&#39;published_publisher&#39;</span>
        <span class="p">)</span>

        <span class="n">serializer</span> <span class="o">=</span> <span class="n">ArticleSerializer</span><span class="p">(</span><span class="n">articles</span><span class="p">,</span> <span class="n">many</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">JsonResponse</span><span class="p">(</span><span class="n">serializer</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">safe</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></div>



<span class="c1"># Read Article</span>
<div class="viewcode-block" id="api_read_article">
<a class="viewcode-back" href="../../news2u.html#news2u.views.api_read_article">[docs]</a>
<span class="nd">@api_view</span><span class="p">([</span><span class="s1">&#39;GET&#39;</span><span class="p">])</span>
<span class="nd">@permission_classes</span><span class="p">([</span><span class="n">IsAuthenticated</span><span class="p">])</span>
<span class="k">def</span><span class="w"> </span><span class="nf">api_read_article</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">article_id</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; API endpoint to read a specific article &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">is_reader</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">JsonResponse</span><span class="p">(</span>
            <span class="p">{</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;Access denied.&#39;</span><span class="p">},</span>
            <span class="n">status</span><span class="o">=</span><span class="mi">403</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">article</span> <span class="o">=</span> <span class="n">Article</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">article_id</span><span class="p">)</span>

        <span class="c1"># Check if the article is from a subscribed journalist</span>
        <span class="c1"># or publisher</span>
        <span class="n">custom_user</span> <span class="o">=</span> <span class="n">CustomUser</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">user</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="p">)</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">article</span><span class="o">.</span><span class="n">journalist</span> <span class="ow">not</span> <span class="ow">in</span>
                <span class="n">custom_user</span><span class="o">.</span><span class="n">subscribed_journalists</span><span class="o">.</span><span class="n">all</span><span class="p">()</span> <span class="ow">and</span>
            <span class="n">article</span><span class="o">.</span><span class="n">publisher</span> <span class="ow">not</span> <span class="ow">in</span>
                <span class="n">custom_user</span><span class="o">.</span><span class="n">subscribed_publishers</span><span class="o">.</span><span class="n">all</span><span class="p">()):</span>
            <span class="k">return</span> <span class="n">JsonResponse</span><span class="p">(</span>
                <span class="p">{</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;Access denied to this article.&#39;</span><span class="p">},</span>
                <span class="n">status</span><span class="o">=</span><span class="mi">403</span><span class="p">)</span>

        <span class="n">serializer</span> <span class="o">=</span> <span class="n">ArticleSerializer</span><span class="p">(</span><span class="n">article</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">JsonResponse</span><span class="p">(</span><span class="n">serializer</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">safe</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="k">except</span> <span class="n">Article</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">JsonResponse</span><span class="p">({</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;Article not found.&#39;</span><span class="p">},</span> <span class="n">status</span><span class="o">=</span><span class="mi">404</span><span class="p">)</span></div>

</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2025, Elizabeth Fuzy.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>